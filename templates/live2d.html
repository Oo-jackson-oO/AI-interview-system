<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>AIé¢è¯•å®˜ - æ™ºèƒ½é¢è¯•ç³»ç»Ÿ</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='css/index.css') }}">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    body {
      margin: 0;
      overflow: hidden;
      background-color: #f0f0f0;
      font-family: 'Inter', sans-serif;
    }
    
    canvas#live2d {
      width: 100vw;
      height: 100vh;
      position: absolute;
      top: 0;
      left: 0;
      z-index: 10;
    }
    
    /* é¢è¯•æ§åˆ¶é¢æ¿ */
    .interview-controls {
      position: fixed;
      top: 20px;
      right: 20px;
      background: rgba(255, 255, 255, 0.1);
      backdrop-filter: blur(20px);
      border-radius: 20px;
      padding: 20px;
      border: 1px solid rgba(255, 255, 255, 0.2);
      z-index: 20;
      min-width: 250px;
    }
    
    .control-title {
      color: white;
      font-size: 1.2rem;
      margin-bottom: 15px;
      text-align: center;
      font-weight: 600;
    }
    
    .control-btn {
      width: 100%;
      padding: 12px;
      margin: 8px 0;
      border: none;
      border-radius: 10px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      cursor: pointer;
      transition: all 0.3s ease;
      font-size: 14px;
      font-weight: 500;
    }
    
    .control-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 25px rgba(102, 126, 234, 0.4);
    }
    
    .control-btn:disabled {
      opacity: 0.6;
      cursor: not-allowed;
      transform: none;
    }
    
    .status-text {
      color: rgba(255, 255, 255, 0.8);
      font-size: 12px;
      text-align: center;
      margin: 10px 0;
      min-height: 20px;
    }
    
    /* èŠå¤©åŒºåŸŸ */
    .chat-area {
      position: fixed;
      bottom: 20px;
      left: 20px;
      right: 20px;
      background: rgba(255, 255, 255, 0.1);
      backdrop-filter: blur(20px);
      border-radius: 20px;
      padding: 20px;
      border: 1px solid rgba(255, 255, 255, 0.2);
      z-index: 20;
      max-height: 200px;
      display: flex;
      flex-direction: column;
    }
    
    .chat-messages {
      flex: 1;
      overflow-y: auto;
      margin-bottom: 15px;
      max-height: 120px;
    }
    
    .message {
      margin-bottom: 10px;
      padding: 8px 12px;
      border-radius: 10px;
      max-width: 80%;
      word-wrap: break-word;
      font-size: 14px;
    }
    
    .message.interviewer {
      background: rgba(102, 126, 234, 0.3);
      color: white;
      border: 1px solid rgba(102, 126, 234, 0.5);
      margin-right: auto;
    }
    
    .message.candidate {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      margin-left: auto;
    }
    
    .chat-input {
      display: flex;
      gap: 10px;
    }
    
    .chat-input input {
      flex: 1;
      padding: 12px;
      border: 1px solid rgba(255, 255, 255, 0.2);
      border-radius: 10px;
      background: rgba(255, 255, 255, 0.1);
      color: white;
      font-size: 14px;
    }
    
    .chat-input input:focus {
      outline: none;
      border-color: #667eea;
      box-shadow: 0 0 15px rgba(102, 126, 234, 0.3);
    }
    
    .chat-input input::placeholder {
      color: rgba(255, 255, 255, 0.5);
    }
    
    .send-btn {
      padding: 12px 20px;
      border: none;
      border-radius: 10px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      cursor: pointer;
      transition: all 0.3s ease;
    }
    
    .send-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
    }
    
    /* è¿”å›æŒ‰é’® */
    .back-btn {
      position: fixed;
      top: 20px;
      right: 140px;
      background: rgba(255, 255, 255, 0.1);
      border: 1px solid rgba(255, 255, 255, 0.2);
      color: white;
      padding: 15px 25px;
      border-radius: 30px;
      cursor: pointer;
      transition: all 0.3s ease;
      backdrop-filter: blur(10px);
      z-index: 100;
      font-size: 16px;
      font-weight: 500;
    }
    
    .back-btn:hover {
      background: rgba(255, 255, 255, 0.2);
      transform: translateY(-2px);
    }
    
    /* ä¸»ç•Œé¢å¼€å§‹é¢è¯•æŒ‰é’® */
    .main-start-interview-btn {
      position: fixed;
      top: 20px;
      left: 80px;
      background: rgba(255, 255, 255, 0.1);
      border: 1px solid rgba(255, 255, 255, 0.2);
      color: white;
      padding: 12px 20px;
      border-radius: 12px;
      cursor: pointer;
      font-size: 16px;
      transition: all 0.3s ease;
      backdrop-filter: blur(10px);
      z-index: 100;
      display: flex;
      align-items: center;
      gap: 6px;
    }
    
    .main-start-interview-btn:hover {
      background: rgba(255, 255, 255, 0.2);
      transform: translateY(-2px);
    }
    
    .main-start-interview-btn:disabled {
      opacity: 0.6;
      cursor: not-allowed;
      transform: none;
    }
    
    /* æ³¢åŠ¨æ•ˆæœæ ·å¼ */
    .rocket-wave {
      position: fixed;
      pointer-events: none;
      z-index: 9999;
      border: 2px solid rgba(255, 255, 255, 0.3);
      border-radius: 50%;
      animation: waveExpand 2s ease-out forwards;
    }
    
    @keyframes waveExpand {
      0% {
        width: 0;
        height: 0;
        opacity: 1;
        transform: translate(-50%, -50%);
      }
      100% {
        width: 200px;
        height: 200px;
        opacity: 0;
        transform: translate(-50%, -50%);
      }
    }
    
    /* å“åº”å¼è®¾è®¡ */
    @media (max-width: 768px) {
      .interview-controls {
        top: 10px;
        right: 10px;
        left: 10px;
        min-width: auto;
      }
      
      .chat-area {
        bottom: 10px;
        left: 10px;
        right: 10px;
      }
    }
    
    /* é€šçŸ¥åŠ¨ç”» */
    @keyframes slideIn {
      from {
        transform: translateX(100%);
        opacity: 0;
      }
      to {
        transform: translateX(0);
        opacity: 1;
      }
    }
    
    @keyframes slideOut {
      from {
        transform: translateX(0);
        opacity: 1;
      }
      to {
        transform: translateX(100%);
        opacity: 0;
      }
    }
    
    /* AIæ€è€ƒåŠ¨ç”» */
    .ai-thinking {
      position: fixed;
      bottom: 80px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(255, 255, 255, 0.1);
      backdrop-filter: blur(20px);
      border-radius: 20px;
      padding: 15px 25px;
      border: 1px solid rgba(255, 255, 255, 0.2);
      z-index: 1000;
      display: none;
      flex-direction: column;
      align-items: center;
      gap: 10px;
      min-width: 280px;
    }
    
    .thinking-progress {
      display: flex;
      align-items: center;
      gap: 15px;
      width: 100%;
      position: relative;
    }
    
    .thinking-icon {
      width: 35px;
      height: 35px;
      border-radius: 50%;
      background: rgba(255, 255, 255, 0.2);
      display: flex;
      align-items: center;
      justify-content: center;
      color: rgba(255, 255, 255, 0.4);
      font-size: 16px;
      transition: all 0.5s ease;
      position: relative;
      z-index: 2;
      flex-shrink: 0;
    }
    
    .thinking-icon.active {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      box-shadow: 0 0 20px rgba(102, 126, 234, 0.5);
      transform: scale(1.1);
    }
    
    .progress-line1 {
      flex: 1;
      height: 3px;
      background: rgba(255, 255, 255, 0.2);
      border-radius: 2px;
      position: relative;
      overflow: hidden;
    }

	.progress-line2 {
      flex: 1;
      height: 3px;
      background: rgba(255, 255, 255, 0.2);
      border-radius: 2px;
      position: relative;
      overflow: hidden;
    }
    
    .progress-fill1 {
	  height: 100%;
	  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
	  width: 0%;
	  border-radius: 2px;
	  transition: none; /* é»˜è®¤æ— åŠ¨ç”» */
	}
    
	.progress-fill2 {
	  height: 100%;
	  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
	  width: 0%;
	  border-radius: 2px;
	  transition: none; /* é»˜è®¤æ— åŠ¨ç”» */
	}

    .progress-fill1.animate {
      transition: width 1s ease;
    }
    
    .progress-fill2.animate {
      transition: width 1s ease;
    }
    
    /* ç³»ç»Ÿè®¾ç½®é¢æ¿ */
    .system-settings {
      position: fixed;
      top: 20px;
      right: 20px;
      z-index: 200;
    }
    
    .settings-toggle {
      width: 50px;
      height: 50px;
      border-radius: 50%;
      background: rgba(255, 255, 255, 0.1);
      backdrop-filter: blur(20px);
      border: 1px solid rgba(255, 255, 255, 0.2);
      color: white;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 20px;
      transition: all 0.3s ease;
    }
    
    .settings-toggle:hover {
      background: rgba(255, 255, 255, 0.2);
      transform: rotate(90deg);
    }
    
    .settings-panel {
      position: absolute;
      top: 60px;
      right: 0;
      background: rgba(255, 255, 255, 0.1);
      backdrop-filter: blur(20px);
      border-radius: 15px;
      padding: 20px;
      border: 1px solid rgba(255, 255, 255, 0.2);
      min-width: 280px;
      display: none;
      flex-direction: column;
      gap: 15px;
      animation: slideDown 0.3s ease;
      max-height: 90vh;
      overflow-y: auto;
    }
    
    .settings-panel.show {
      display: flex;
    }
    
    @keyframes slideDown {
      from {
        opacity: 0;
        transform: translateY(-20px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }
    
    .panel-title {
      color: white;
      font-size: 18px;
      font-weight: 600;
      text-align: center;
      margin-bottom: 10px;
      border-bottom: 1px solid rgba(255, 255, 255, 0.2);
      padding-bottom: 10px;
    }
    
    .setting-item {
      display: flex;
      align-items: center;
      justify-content: space-between;
      color: white;
      font-size: 14px;
      padding: 8px 0;
    }
    
    .setting-label {
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .setting-toggle {
      width: 50px;
      height: 25px;
      border-radius: 15px;
      background: rgba(255, 255, 255, 0.2);
      position: relative;
      cursor: pointer;
      transition: all 0.3s ease;
    }
    
    .setting-toggle.active {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    }
    
    .toggle-slider {
      width: 21px;
      height: 21px;
      border-radius: 50%;
      background: white;
      position: absolute;
      top: 2px;
      left: 2px;
      transition: all 0.3s ease;
    }
    
    .setting-toggle.active .toggle-slider {
      transform: translateX(25px);
    }
    
    .setting-button {
      background: rgba(255, 255, 255, 0.1);
      border: 1px solid rgba(255, 255, 255, 0.2);
      color: white;
      padding: 8px 16px;
      border-radius: 8px;
      cursor: pointer;
      font-size: 12px;
      transition: all 0.3s ease;
    }
    
    .setting-button:hover {
      background: rgba(255, 255, 255, 0.2);
      transform: translateY(-2px);
    }
    
    .debug-info {
      background: rgba(0, 0, 0, 0.3);
      border-radius: 8px;
      padding: 10px;
      font-size: 12px;
      color: rgba(255, 255, 255, 0.8);
      font-family: 'Courier New', monospace;
      max-height: 150px;
      overflow-y: auto;
      white-space: pre-wrap;
    }
    
    /* ASRè½¬å†™ç»“æœæ˜¾ç¤ºåŒºåŸŸ */
    .asr-results {
      position: fixed;
      bottom: 250px;
      left: 20px;
      width: 400px;
      max-height: 300px;
      background: rgba(255, 255, 255, 0.1);
      backdrop-filter: blur(20px);
      border-radius: 15px;
      padding: 15px;
      border: 1px solid rgba(255, 255, 255, 0.2);
      z-index: 20;
      display: none;
      flex-direction: column;
      gap: 10px;
    }
    
    .asr-results.show {
      display: flex;
    }
    
    .asr-title {
      color: white;
      font-size: 16px;
      font-weight: 600;
      text-align: center;
      margin-bottom: 10px;
      border-bottom: 1px solid rgba(255, 255, 255, 0.2);
      padding-bottom: 8px;
    }
    
    .asr-content {
      flex: 1;
      overflow-y: auto;
      max-height: 200px;
    }
    
    .asr-text {
      padding: 8px 12px;
      margin: 5px 0;
      border-left: 3px solid #4CAF50;
      background: rgba(255, 255, 255, 0.1);
      border-radius: 6px;
      color: white;
      font-size: 13px;
      line-height: 1.4;
    }
    
    .asr-final {
      padding: 12px 16px;
      margin: 8px 0;
      border-left: 4px solid #2196F3;
      background: rgba(33, 150, 243, 0.2);
      border-radius: 8px;
      color: white;
      font-weight: 500;
      font-size: 14px;
    }
    
    .asr-status {
      text-align: center;
      color: rgba(255, 255, 255, 0.7);
      font-size: 12px;
      padding: 5px;
      font-style: italic;
    }
    
    .asr-sentence {
      padding: 6px 10px;
      margin: 3px 0;
      background: rgba(255, 255, 255, 0.05);
      border-radius: 4px;
      border-left: 2px solid #007bff;
      color: rgba(255, 255, 255, 0.9);
      font-size: 12px;
    }
    
    /* ASRçŠ¶æ€æŒ‡ç¤ºå™¨ */
    .asr-indicator {
      position: fixed;
      top: 80px;
      left: 20px;
      background: rgba(255, 255, 255, 0.1);
      backdrop-filter: blur(10px);
      border-radius: 25px;
      padding: 8px 15px;
      border: 1px solid rgba(255, 255, 255, 0.2);
      z-index: 150;
      display: none;
      align-items: center;
      gap: 8px;
      color: white;
      font-size: 13px;
    }
    
    .asr-indicator.show {
      display: flex;
    }
    
    .asr-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: #4CAF50;
      animation: pulse 1.5s infinite;
    }
    
    .asr-dot.recording {
      background: #f44336;
      animation: blink 0.8s infinite;
    }
    
    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }
    
    @keyframes blink {
      0%, 50% { opacity: 1; }
      51%, 100% { opacity: 0; }
    }
  </style>
</head>
<body>
  <!-- ç«ç®­é¼ æ ‡æ ·å¼ -->
  <div class="rocket-cursor" id="rocketCursor">
    <div class="rocket-nose"></div>
    <div class="rocket-body"></div>
    <div class="rocket-fins"></div>
    <div class="rocket-engine"></div>
  </div>
  
  <!-- é«˜çº§ç²’å­æ•ˆæœå®¹å™¨ -->
  <div class="particles-container">
    <canvas id="particles-canvas"></canvas>
  </div>
  
  <!-- èƒŒæ™¯æµæ˜Ÿæ•ˆæœ -->
  <div class="meteor-container"></div>
  
  <!-- æ˜Ÿå…‰ç‰¹æ•ˆ -->
  <div class="stars-container"></div>
  
  <!-- æ˜Ÿç©ºè£…é¥°å…ƒç´  -->
  <!-- è¡Œæ˜Ÿæ‚¬æµ® -->
  <div class="planet saturn"></div>
  <div class="planet jupiter"></div>
  
  <!-- æœ›è¿œé•œ -->
  <div class="telescope"></div>
  
  <!-- è§‚æ˜Ÿå°äºº -->
  <div class="stargazer"></div>
  
  <!-- æ˜Ÿåº§å›¾æ¡ˆ -->
  <div class="constellation big-dipper"></div>
  <div class="constellation orion"></div>
  
  <!-- æµæ˜Ÿç—•è¿¹ -->
  <div class="meteor-trail left"></div>
  <div class="meteor-trail right"></div>
  <div class="meteor-trail center"></div>
  
  <!-- ç©ºé—´ç«™ -->
  <div class="space-station right"></div>
  
  <!-- è¿”å›æŒ‰é’® -->
  <button class="back-btn" onclick="goBack()">
    <i class="fas fa-arrow-left"></i> è¿”å›ä¸»é¡µ
  </button>

  <!-- ä¸»ç•Œé¢å¼€å§‹é¢è¯•æŒ‰é’® -->
  <button class="main-start-interview-btn" onclick="startInterview()" id="mainStartInterviewBtn" disabled>
    <i class="fas fa-play"></i> å¼€å§‹é¢è¯•
  </button>

  <!-- AIæ€è€ƒåŠ¨ç”» -->
  <div class="ai-thinking" id="aiThinking">
    <div class="thinking-progress">
      <div class="thinking-icon" id="thinkingIcon1">
        <i class="fas fa-broadcast-tower"></i>
      </div>
      <div class="progress-line1">
        <div class="progress-fill1" id="progressFill1"></div>
      </div>
      <div class="thinking-icon" id="thinkingIcon2">
        <i class="fas fa-satellite"></i>
      </div>
      <div class="progress-line2">
        <div class="progress-fill2" id="progressFill2"></div>
      </div>
      <div class="thinking-icon" id="thinkingIcon3">
        <i class="fa-solid fa-podcast"></i>
      </div>
    </div>
  </div>
  
  <!-- ASRçŠ¶æ€æŒ‡ç¤ºå™¨
  <div class="asr-indicator" id="asrIndicator">
    <div class="asr-dot" id="asrDot"></div>
    <span id="asrStatus">æœªè¿æ¥</span>
  </div> -->
  
  <!-- ç³»ç»Ÿè®¾ç½®é¢æ¿ -->
  <div class="system-settings">
    <div class="settings-toggle" onclick="toggleSettings()">
      <i class="fas fa-cog"></i>
    </div>
    <div class="settings-panel" id="settingsPanel">
      <div class="panel-title">
        <i class="fas fa-tools"></i> ç³»ç»Ÿè®¾ç½®
      </div>
            <!-- é¢è¯•åŠŸèƒ½åŒºåŸŸ -->
      <div class="setting-item" style="border-top: 1px solid rgba(255, 255, 255, 0.2); margin-top: 15px; padding-top: 15px;">
        <div class="setting-label" style="width: 100%; flex-direction: column; align-items: stretch; gap: 10px;">
          <div style="display: flex; align-items: center; gap: 8px;">
            <i class="fas fa-user-tie"></i>
            <span>AIé¢è¯•ç³»ç»Ÿ</span>
          </div>
          
          <!-- é¢è¯•çŠ¶æ€æ˜¾ç¤º -->
          <div id="interviewStatus" style="
            background: rgba(255, 255, 255, 0.1);
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 12px;
            text-align: center;
            color: rgba(255, 255, 255, 0.8);
          ">æ­£åœ¨åˆå§‹åŒ–...</div>
          
          <!-- é¢è¯•è¿›åº¦ -->
          <div id="interviewProgress" style="display: none;">
            <div style="font-size: 11px; color: rgba(255, 255, 255, 0.6); margin-bottom: 4px;">
              <span id="currentSection">å‡†å¤‡ä¸­</span> (<span id="questionProgress">0/0</span>)
            </div>
            <div style="background: rgba(255, 255, 255, 0.2); height: 4px; border-radius: 2px; overflow: hidden;">
              <div id="progressBar" style="
                height: 100%;
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                width: 0%;
                transition: width 0.3s ease;
              "></div>
            </div>
          </div>
          
          <!-- é¢è¯•æ§åˆ¶æŒ‰é’® -->
          <div style="display: flex; gap: 5px; margin-top: 8px;">
            <button class="setting-button" onclick="startInterview()" id="startInterviewBtn" style="flex: 1;" disabled>
              <i class="fas fa-play"></i> å¼€å§‹é¢è¯•
            </button>
            <button class="setting-button" onclick="pauseInterview()" id="pauseInterviewBtn" style="flex: 1;" disabled>
              <i class="fas fa-pause"></i> æš‚åœ
            </button>
            <button class="setting-button" onclick="stopInterview()" id="stopInterviewBtn" style="flex: 1;" disabled>
              <i class="fas fa-stop"></i> ç»“æŸ
            </button>
          </div>
        </div>
      </div>
      
      <div class="setting-item">
        <div class="setting-label">
          <i class="fas fa-volume-up"></i>
          <span>è¯­éŸ³æ’­æ”¾</span>
        </div>
        <div class="setting-toggle" onclick="toggleSetting(this, 'voice')" data-setting="voice">
          <div class="toggle-slider"></div>
        </div>
      </div>
      
      <div class="setting-item">
        <div class="setting-label">
          <i class="fas fa-microphone"></i>
          <span>è¯­è°ƒåˆ†æ</span>
        </div>
        <div class="setting-toggle active" onclick="toggleSetting(this, 'voiceAnalysis')" data-setting="voiceAnalysis">
          <div class="toggle-slider"></div>
        </div>
      </div>
      
      <div class="setting-item">
        <div class="setting-label">
          <i class="fas fa-microphone"></i>
          <span>è‡ªåŠ¨å½•éŸ³</span>
        </div>
        <div class="setting-toggle" onclick="toggleSetting(this, 'autoRecord')" data-setting="autoRecord">
          <div class="toggle-slider"></div>
        </div>
      </div>
      
      <!-- æ–°å¢ASRè¯­éŸ³è¯†åˆ«å¼€å…³ -->
      <div class="setting-item">
        <div class="setting-label">
          <i class="fas fa-comments"></i>
          <span>ASRè¯­éŸ³è¯†åˆ«</span>
        </div>
        <div class="setting-toggle" onclick="toggleSetting(this, 'asrRecognition')" data-setting="asrRecognition">
          <div class="toggle-slider"></div>
        </div>
      </div>
      
      <!-- æ–°å¢TTSè¯­éŸ³åˆæˆå¼€å…³ -->
      <div class="setting-item">
        <div class="setting-label">
          <i class="fas fa-volume-up"></i>
          <span>TTSè¯­éŸ³åˆæˆ</span>
        </div>
        <div class="setting-toggle" onclick="toggleSetting(this, 'ttsEnabled')" data-setting="ttsEnabled">
          <div class="toggle-slider"></div>
        </div>
      </div>
      
      <div class="setting-item">
        <div class="setting-label">
          <i class="fas fa-camera"></i>
          <span>å¾®è¡¨æƒ…è¯†åˆ«</span>
        </div>
        <div class="setting-toggle active" onclick="toggleSetting(this, 'facialAnalysis')" data-setting="facialAnalysis">
          <div class="toggle-slider"></div>
        </div>
      </div>
    
      <div class="setting-item">
        <div class="setting-label">
          <i class="fas fa-eye"></i>
          <span>é¼ æ ‡è·Ÿéš</span>
        </div>
        <div class="setting-toggle active" onclick="toggleSetting(this, 'mouseFollow')" data-setting="mouseFollow">
          <div class="toggle-slider"></div>
        </div>
      </div>
      
      <div class="setting-item">
        <div class="setting-label">
          <i class="fas fa-rocket"></i>
          <span>ç²’å­ç‰¹æ•ˆ</span>
        </div>
        <div class="setting-toggle active" onclick="toggleSetting(this, 'particles')" data-setting="particles">
          <div class="toggle-slider"></div>
        </div>
      </div>
      
      <!-- TTSæ–‡æœ¬è¾“å…¥åŒºåŸŸ -->
      <div class="setting-item" id="ttsTextInput" style="display: none; flex-direction: column; align-items: stretch;">
        <div class="setting-label" style="margin-bottom: 8px;">
          <i class="fas fa-edit"></i>
          <span>åˆæˆæ–‡æœ¬ (è†å°çª)</span>
        </div>
        <textarea id="ttsTextArea" placeholder="è¯·è¾“å…¥è¦åˆæˆçš„æ–‡æœ¬..." style="
          width: 100%;
          min-height: 60px;
          padding: 8px;
          border: 1px solid rgba(255, 255, 255, 0.3);
          border-radius: 6px;
          background: rgba(255, 255, 255, 0.1);
          color: white;
          font-size: 12px;
          resize: vertical;
          margin-bottom: 8px;
        ">ä½ å¥½ï¼Œæˆ‘æ˜¯AIé¢è¯•å®˜ï¼Œå¾ˆé«˜å…´ä¸ºæ‚¨æä¾›æœåŠ¡ã€‚è¯·é—®æœ‰ä»€ä¹ˆå¯ä»¥å¸®åŠ©æ‚¨çš„å—ï¼Ÿ</textarea>
        <div style="display: flex; gap: 5px;">
          <button class="setting-button" onclick="startTTSSynthesis()" id="ttsStartBtn" style="flex: 1;">
            <i class="fas fa-play"></i> å¼€å§‹åˆæˆ
          </button>
          <button class="setting-button" onclick="stopTTSPlayback()" id="ttsStopBtn" style="flex: 1;" disabled>
            <i class="fas fa-stop"></i> åœæ­¢æ’­æ”¾
          </button>
        </div>
        <div id="ttsStatus" style="
          text-align: center;
          color: rgba(255, 255, 255, 0.7);
          font-size: 11px;
          margin-top: 4px;
          min-height: 16px;
        ">å¾…æœºä¸­</div>
      </div>
      
      <div class="setting-item">
        <button class="setting-button" onclick="testThinking()">
          <i class="fas fa-play"></i> æµ‹è¯•æ€è€ƒåŠ¨ç”»
        </button>
        <button class="setting-button" onclick="resetAnimation()">
          <i class="fas fa-stop"></i> é‡ç½®åŠ¨ç”»
        </button>
      </div>
      
      <div class="setting-item">
        <button class="setting-button" onclick="toggleFacialAnalysis()">
          <i class="fas fa-camera"></i> <span id="facialBtn">åœæ­¢åˆ†æ</span>
        </button>
        <button class="setting-button" onclick="toggleVoiceAnalysis()">
          <i class="fas fa-microphone"></i> <span id="voiceBtn">åœæ­¢å½•éŸ³</span>
        </button>
      </div>
      
      <!-- æ–°å¢ASRæ§åˆ¶æŒ‰é’® -->
      <div class="setting-item">
        <button class="setting-button" onclick="startSmartASR()">
          <i class="fas fa-comments"></i> <span id="asrBtn">å¼€å§‹æ™ºèƒ½è¯†åˆ«</span>
        </button>
        <button class="setting-button" onclick="toggleASRResults()">
          <i class="fas fa-eye"></i> <span id="asrResultsBtn">æ˜¾ç¤ºè½¬å†™</span>
        </button>
      </div>
      
      <!-- ASRè½¬å†™ç»“æœæ˜¾ç¤ºåŒºåŸŸ -->
      <div class="setting-item" style="border-top: 1px solid rgba(255, 255, 255, 0.2); margin-top: 15px; padding-top: 15px;">
        <div class="asr-results" id="asrResults" style="
          position: relative;
          bottom: auto;
          left: auto;
          width: auto;
          max-height: 200px;
          background: rgba(255, 255, 255, 0.05);
          backdrop-filter: none;
          border-radius: 8px;
          padding: 10px;
          border: 1px solid rgba(255, 255, 255, 0.1);
          z-index: auto;
          display: none;
          flex-direction: column;
          gap: 8px;
        ">
          <div class="asr-title" style="
            color: white;
            font-size: 14px;
            font-weight: 600;
            text-align: center;
            margin-bottom: 8px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            padding-bottom: 6px;
          ">
            <i class="fas fa-microphone"></i> è¯­éŸ³è½¬å†™ç»“æœ
          </div>
          <div class="asr-content" id="asrContent" style="
            flex: 1;
            overflow-y: auto;
            max-height: 150px;
          ">
            <div class="asr-status">ç­‰å¾…è¯­éŸ³è¾“å…¥...</div>
          </div>
        </div>
      </div>
      
      <div class="setting-item">
        <button class="setting-button" onclick="resetLive2D()">
          <i class="fas fa-redo"></i> é‡ç½®æ¨¡å‹
        </button>
        <button class="setting-button" onclick="toggleDebugInfo()">
          <i class="fas fa-bug"></i> è°ƒè¯•ä¿¡æ¯
        </button>
      </div>
      
      <div class="setting-item">
        <button class="setting-button" onclick="exportSettings()">
          <i class="fas fa-download"></i> å¯¼å‡ºè®¾ç½®
        </button>
      </div>
      

      
      <div class="debug-info" id="debugInfo" style="display: none;">
        Live2DçŠ¶æ€: æ­£å¸¸
        åŠ¨ç”»çŠ¶æ€: ç©ºé—²
        éŸ³é¢‘çŠ¶æ€: æœªåˆå§‹åŒ–
        æ€§èƒ½: 60 FPS
            </div>
            </div>
          </div>
          
  <!-- é»‘æ´è½¬åœºæ•ˆæœ -->
  <div class="blackhole-transition" id="blackholeTransition">
    <div class="blackhole-circle"></div>
    <div class="blackhole-vortex"></div>
    <div class="blackhole-streams">
      <div class="particle"></div>
      <div class="particle"></div>
      <div class="particle"></div>
      <div class="particle"></div>
      <div class="particle"></div>
      <div class="particle"></div>
      <div class="particle"></div>
      <div class="particle"></div>
      <div class="particle"></div>
      <div class="particle"></div>
      <div class="particle"></div>
      <div class="particle"></div>
      <div class="particle"></div>
      <div class="particle"></div>
      <div class="particle"></div>
      <div class="particle"></div>
      <div class="particle"></div>
      <div class="particle"></div>
      <div class="particle"></div>
      <div class="particle"></div>
      <div class="particle"></div>
      <div class="particle"></div>
      <div class="particle"></div>
      <div class="particle"></div>
      <div class="particle"></div>
      <div class="particle"></div>
      <div class="particle"></div>
      <div class="particle"></div>
      <div class="particle"></div>
      <div class="particle"></div>
      <div class="particle"></div>
      <div class="particle"></div>
      <div class="particle"></div>
      <div class="particle"></div>
      <div class="particle"></div>
      <div class="particle"></div>
      <div class="particle"></div>
      <div class="particle"></div>
        </div>
      </div>
      
  <!-- Live2D æ•°å­—äºº -->
  	<canvas id="live2d"></canvas>
  
  <!-- SocketIO CDN -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>
  
  <!-- importmap -->
  	<script type="importmap">
	{
  		"imports": {
    			"pixi.js": "https://cdn.jsdelivr.net/npm/pixi.js/dist/pixi.min.mjs",
    			"@pixi/sound": "https://cdn.jsdelivr.net/npm/@pixi/sound@6.0.1/dist/pixi-sound.mjs",
    			"easy-live2d": "https://cdn.jsdelivr.net/npm/easy-live2d/dist/index.js"
  		}
	}
	</script>
  
  <!-- Live2D Core -->
  <script src="/live2d/Core/live2dcubismcore.js"></script>
  
  <!-- èƒŒæ™¯ç‰¹æ•ˆè„šæœ¬ -->
  <script src="{{ url_for('static', filename='js/index.js') }}"></script>
  
  <!-- Live2D å’Œé¢è¯•é€»è¾‘ -->
	<script type="module">
   		import { Application, Ticker } from 'pixi.js';
    		import { Live2DSprite, Config } from 'easy-live2d'

    		Config.MotionGroupIdle = 'Idle'; 
    		Config.MouseFollow = false;
    		const live2dSprite = new Live2DSprite();
    
    let app;
    let interviewActive = false;
    let currentQuestion = 0;
    const questions = [
      "è¯·å…ˆè‡ªæˆ‘ä»‹ç»ä¸€ä¸‹",
      "è¯´è¯´ä½ æœ€å¤§çš„ä¼˜åŠ¿æ˜¯ä»€ä¹ˆï¼Ÿ",
      "ä½ ä¸ºä»€ä¹ˆé€‰æ‹©è¿™ä¸ªèŒä½ï¼Ÿ",
      "æè¿°ä¸€ä¸‹ä½ çš„èŒä¸šè§„åˆ’",
      "ä½ å¦‚ä½•å¤„ç†å·¥ä½œä¸­çš„å‹åŠ›ï¼Ÿ"
    ];
    
    // åˆå§‹åŒ–Live2D
    async function initLive2D() {
      try {
        await live2dSprite.init({
          modelPath: '/live2d/assets/haru/haru_greeter_t05.model3.json',
      			ticker: Ticker.shared
    		});

			function resizeModel() {
            	const canvas = document.getElementById('live2d');

          console.log(window.devicePixelRatio);
          
          const screenWidth = window.innerWidth * window.devicePixelRatio / 1.5;
          const screenHeight = window.innerHeight * window.devicePixelRatio / 1.5;
				
            	canvas.width = screenWidth;
            	canvas.height = screenHeight;
            
            	live2dSprite.width = 3 * screenWidth;
				live2dSprite.height = 3 * screenHeight;
				live2dSprite.x = -0.75 * screenWidth;
          live2dSprite.y = -1.5 * screenHeight;
			}

			const canvas = document.getElementById('live2d');
        app = new Application();
      				await app.init({
        				view: document.getElementById('live2d'),
        				backgroundAlpha: 0, 
      				});
        
			window.addEventListener('resize', resizeModel);
			resizeModel();
      		app.stage.addChild(live2dSprite);
        
        console.log('Live2Dæ¨¡å‹åŠ è½½æˆåŠŸ');
        updateStatus('Live2Dé¢è¯•å®˜å·²å°±ç»ª');
        
        // 3ç§’åè‡ªåŠ¨æ’­æ”¾å¤ªç©ºä¿¡æ¯ä¼ è¾“åŠ¨ç”»æ¼”ç¤º
        setTimeout(() => {
          showThinking();
        }, 3000);
        
      } catch (error) {
        console.error('Live2Dæ¨¡å‹åŠ è½½å¤±è´¥:', error);
        updateStatus('æ¨¡å‹åŠ è½½å¤±è´¥ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•');
      }
    }
    
    function updateStatus(text) {
      console.log('çŠ¶æ€æ›´æ–°:', text);
    }
    
    // åˆå§‹åŒ–é¡µé¢
    document.addEventListener('DOMContentLoaded', function() {
      // åˆå§‹åŒ–èƒŒæ™¯ç‰¹æ•ˆ
      new RocketCursorSystem();
      new ParticleSystem();
      new StarSystem();
      new MeteorSystem();
      
      // åˆå§‹åŒ–Live2D
      initLive2D();
      
      // æ·»åŠ é¼ æ ‡ç‰¹æ•ˆ
      addMouseEffects();
      
      // åˆå§‹åŒ–è®¾ç½®
      updateDebugInfo();
      
      // åˆå§‹åŒ–ASRç³»ç»Ÿï¼ˆä¼šåœ¨è¿æ¥æˆåŠŸåè‡ªåŠ¨åˆå§‹åŒ–TTSï¼‰
      initASRSystem();
      
      // åˆå§‹åŒ–é¢è¯•ç³»ç»Ÿ
      setTimeout(() => {
        initInterviewSystem();
      }, 2000); // å»¶è¿Ÿ2ç§’ç¡®ä¿å…¶ä»–ç³»ç»Ÿåˆå§‹åŒ–å®Œæˆ
      
      // è‡ªåŠ¨å¯åŠ¨å¾®è¡¨æƒ…åˆ†æï¼ˆå¦‚æœè®¾ç½®ä¸ºå¼€å¯ï¼‰
      setTimeout(() => {
        if (systemSettings.facialAnalysis) {
          console.log('ğŸ¬ è‡ªåŠ¨å¯åŠ¨å¾®è¡¨æƒ…è‚¢ä½“åˆ†æ...');
          startFacialAnalysis();
        }
      }, 2000); // å»¶è¿Ÿ2ç§’å¯åŠ¨ï¼Œç¡®ä¿Live2DåŠ è½½å®Œæˆ
      
      // è‡ªåŠ¨å¯åŠ¨è¯­è°ƒåˆ†æï¼ˆå¦‚æœè®¾ç½®ä¸ºå¼€å¯ï¼‰
      setTimeout(() => {
        if (systemSettings.voiceAnalysis) {
          console.log('ğŸ¤ è‡ªåŠ¨å¯åŠ¨è¯­è°ƒåˆ†æ...');
          startVoiceAnalysis();
        }
      }, 3000); // å»¶è¿Ÿ3ç§’å¯åŠ¨ï¼Œç¡®ä¿å¾®è¡¨æƒ…åˆ†æå…ˆå¯åŠ¨
    });
    
    // é¡µé¢ç¦»å¼€æ—¶è‡ªåŠ¨åœæ­¢åˆ†æ
    window.addEventListener('beforeunload', function() {
      if (facialAnalysisRunning) {
        console.log('ğŸ›‘ é¡µé¢ç¦»å¼€ï¼Œè‡ªåŠ¨åœæ­¢å¾®è¡¨æƒ…åˆ†æ');
        // å‘é€åŒæ­¥è¯·æ±‚åœæ­¢åˆ†æ
        navigator.sendBeacon('/api/interview/stop-facial-analysis', JSON.stringify({}));
        stopAnalysisStatusMonitoring();
      }
      
      if (voiceAnalysisRunning) {
        console.log('ğŸ›‘ é¡µé¢ç¦»å¼€ï¼Œè‡ªåŠ¨åœæ­¢è¯­è°ƒåˆ†æ');
        // å‘é€åŒæ­¥è¯·æ±‚åœæ­¢åˆ†æ
        navigator.sendBeacon('/api/interview/stop-voice-analysis', JSON.stringify({}));
        stopVoiceStatusMonitoring();
      }
      
      // åœæ­¢ASRè¯†åˆ«
      if (asrActive) {
        console.log('ğŸ›‘ é¡µé¢ç¦»å¼€ï¼Œè‡ªåŠ¨åœæ­¢ASRè¯†åˆ«');
        stopASRRecognition();
      }
      
      // åœæ­¢TTSæ’­æ”¾å’Œæ¸…ç†èµ„æº
      if (ttsAudioPlayer && !ttsAudioPlayer.paused) {
        console.log('ğŸ›‘ é¡µé¢ç¦»å¼€ï¼Œè‡ªåŠ¨åœæ­¢TTSæ’­æ”¾');
        ttsAudioPlayer.pause();
        
        // åœæ­¢æ•°å­—äººå˜´éƒ¨åŠ¨ç”»
        if (live2dSprite && live2dSprite.stopVoice) {
          try {
            live2dSprite.stopVoice();
          } catch (error) {
            console.warn('åœæ­¢å˜´éƒ¨åŠ¨ç”»å¤±è´¥:', error);
          }
        }
        
        // æ¸…ç†éŸ³é¢‘URLèµ„æº
        if (ttsAudioPlayer.src && ttsAudioPlayer.src.startsWith('blob:')) {
          URL.revokeObjectURL(ttsAudioPlayer.src);
        }
      }
    });
    
    // é¡µé¢éšè—æ—¶æš‚åœåˆ†æ
    document.addEventListener('visibilitychange', function() {
      if (document.hidden) {
        console.log('â¸ï¸ é¡µé¢éšè—ï¼Œæš‚åœçŠ¶æ€ç›‘æ§');
        stopAnalysisStatusMonitoring();
        stopVoiceStatusMonitoring();
      } else {
        console.log('â–¶ï¸ é¡µé¢æ˜¾ç¤ºï¼Œæ¢å¤çŠ¶æ€ç›‘æ§');
        if (facialAnalysisRunning) {
          startAnalysisStatusMonitoring();
        }
        if (voiceAnalysisRunning) {
          startVoiceStatusMonitoring();
        }
      }
    });
    
    // æ·»åŠ é¼ æ ‡ç‰¹æ•ˆ
    function addMouseEffects() {
      const interactiveElements = document.querySelectorAll('.setting-button, .settings-toggle, .back-btn');
      
      interactiveElements.forEach(element => {
        element.addEventListener('mouseenter', function(event) {
          const wave = document.createElement('div');
          wave.className = 'rocket-wave';
          wave.style.left = event.clientX + 'px';
          wave.style.top = event.clientY + 'px';
          document.body.appendChild(wave);
          
          setTimeout(() => {
            if (document.body.contains(wave)) {
              document.body.removeChild(wave);
            }
          }, 2000);
        });
      });
    }
    
    // è¿”å›ä¸»é¡µ
    window.goBack = function() {
      const blackhole = document.getElementById('blackholeTransition');
      blackhole.style.display = 'flex';
      blackhole.classList.add('active');
      
      setTimeout(() => {
        window.location.href = '/';
      }, 1000);
    }
    
    // AIæ€è€ƒåŠ¨ç”»ç›¸å…³åŠŸèƒ½
    let thinkingAnimationTimeout;
    
    function showThinking() {
      const thinkingDiv = document.getElementById('aiThinking');
      thinkingDiv.style.display = 'flex';
      
      // é‡ç½®æ‰€æœ‰çŠ¶æ€
      resetThinkingAnimation();
      
      // é˜¶æ®µ1: æ¿€æ´»ç¬¬ä¸€ä¸ªå›¾æ ‡ï¼Œç„¶åå¡«å……ç¬¬ä¸€ä¸ªè¿›åº¦æ¡
      setTimeout(() => {
        activateThinkingIcon(1);
        setTimeout(() => {
          fillProgressBar(1);
        }, 100);
      }, 200);
      
      // é˜¶æ®µ2: æ¿€æ´»ç¬¬äºŒä¸ªå›¾æ ‡ï¼Œç„¶åå¡«å……ç¬¬äºŒä¸ªè¿›åº¦æ¡
      setTimeout(() => {
        activateThinkingIcon(2);
        setTimeout(() => {
          fillProgressBar(2);
        }, 100);
      }, 1200);
      
      // é˜¶æ®µ3: æ¿€æ´»ç¬¬ä¸‰ä¸ªå›¾æ ‡
      setTimeout(() => {
        activateThinkingIcon(3);
      }, 2200);
      
      // 3ç§’åéšè—
      thinkingAnimationTimeout = setTimeout(() => {
        hideThinking();
      }, 3000);
    }
    
    function hideThinking() {
      const thinkingDiv = document.getElementById('aiThinking');
      thinkingDiv.style.display = 'none';
      resetThinkingAnimation();
    }
    
    // é‡ç½®åŠ¨ç”»
    function resetThinkingAnimation() {
      const progressFills = document.querySelectorAll('.progress-fill1, .progress-fill2');
      progressFills.forEach(fill => {
        fill.style.width = '0%';
        fill.classList.remove('animate');
      });
      
      const icons = document.querySelectorAll('.thinking-icon');
      icons.forEach(icon => {
        icon.classList.remove('active');
      });
    }
    
    // æ¿€æ´»å›¾æ ‡
    function activateThinkingIcon(iconNumber) {
      const icon = document.getElementById(`thinkingIcon${iconNumber}`);
      if (icon) {
        icon.classList.add('active');
        console.log(`æ¿€æ´»å›¾æ ‡ ${iconNumber}: ${getIconName(iconNumber)}`);
      }
    }
    
    // å¡«å……è¿›åº¦æ¡
    function fillProgressBar(progressNumber) {
      const progressFill = document.getElementById(`progressFill${progressNumber}`);
      if (progressFill) {
        console.log(`å¼€å§‹å¡«å……è¿›åº¦æ¡ ${progressNumber}`);
        
        // ç¡®ä¿åªå¢åŠ å®½åº¦ï¼Œä¸ºæ¯ä¸ªè¿›åº¦æ¡åˆ†åˆ«æ·»åŠ åŠ¨ç”»
        if (progressNumber === 1) {
          progressFill.classList.add('animate');  // å¼€å¯åŠ¨ç”»
          progressFill.style.width = '100%';
        } 
		else if (progressNumber === 2) {
          progressFill.classList.add('animate');  // å¼€å¯åŠ¨ç”»
          progressFill.style.width = '100%';
        }
        
        console.log(`è¿›åº¦æ¡ ${progressNumber} å¼€å§‹åŠ¨ç”»åˆ° 100%`);
      }
    }
    
    function getIconName(step) {
      const names = ['ä¿¡å·å‘å°„', 'å«æ˜Ÿä¼ è¾“', 'è¯­éŸ³æ¥æ”¶'];
      return names[step - 1] || 'æœªçŸ¥';
    }
    
    // ç³»ç»Ÿè®¾ç½®é¢æ¿åŠŸèƒ½
    let settingsVisible = false;
    let systemSettings = {
      voice: false,
      voiceAnalysis: true, // è¯­è°ƒåˆ†æé»˜è®¤å¼€å¯
      autoRecord: false,
      facialAnalysis: true, // å¾®è¡¨æƒ…è¯†åˆ«é»˜è®¤å¼€å¯
      mouseFollow: true,
      particles: true,
      asrRecognition: false, // æ–°å¢ASRè¯­éŸ³è¯†åˆ«è®¾ç½®
      ttsEnabled: false // æ–°å¢TTSè¯­éŸ³åˆæˆè®¾ç½®
    };
    
    // å¾®è¡¨æƒ…åˆ†æç›¸å…³å˜é‡
    let facialAnalysisRunning = false;
    let analysisStatusInterval = null;
    let currentAnalysisCount = 0;
    
    // è¯­è°ƒåˆ†æç›¸å…³å˜é‡
    let voiceAnalysisRunning = false;
    let voiceStatusInterval = null;
    let isRecording = false;
    
    // åª’ä½“æµç›¸å…³å˜é‡
    let videoStream = null;
    let audioStream = null;
    let mediaRecorder = null;
    let recordedChunks = [];
    
    // ==================== ASRç›¸å…³å˜é‡å’ŒåŠŸèƒ½ ====================
    let asrSocket = null;
    let asrActive = false;
    let asrRecording = false;
    let asrAudioContext = null;
    let asrProcessor = null;
    let asrResultsVisible = false;
    
    // åˆå§‹åŒ–ASRç³»ç»Ÿ
    function initASRSystem() {
      console.log('ğŸ™ï¸ åˆå§‹åŒ–ASRè¯­éŸ³è¯†åˆ«ç³»ç»Ÿ...');
      
      // è¿æ¥åˆ°ASRæœåŠ¡å™¨ï¼ˆç«¯å£5000 - é›†æˆåˆ°ä¸»æœåŠ¡å™¨ï¼‰
      try {
        asrSocket = io('http://localhost:5000');
        
        // ASR Socketäº‹ä»¶å¤„ç†
        asrSocket.on('connect', function() {
          console.log('âœ… ASRæœåŠ¡å™¨å·²è¿æ¥');
          updateASRStatus('å·²è¿æ¥', false);
          
          // åœ¨ASRè¿æ¥æˆåŠŸååˆå§‹åŒ–TTSç³»ç»Ÿ
          initTTSSystem();
        });
        
        asrSocket.on('disconnect', function() {
          console.log('âŒ ASRæœåŠ¡å™¨æ–­å¼€è¿æ¥');
          updateASRStatus('æœªè¿æ¥', false);
          asrActive = false;
          asrRecording = false;
          updateASRButton();
        });
        
        asrSocket.on('asr_connected', function() {
          console.log('ğŸ§  ASRæ™ºèƒ½è¯­éŸ³è¯†åˆ«å·²è¿æ¥');
          updateASRStatus('è¯†åˆ«å°±ç»ª', false);
        });
        
        asrSocket.on('asr_smart_started', function(data) {
          console.log('ğŸ”´ æ™ºèƒ½å½•éŸ³å·²å¯åŠ¨:', data.message);
          updateASRStatus('æ™ºèƒ½å½•éŸ³ä¸­', true);
          asrRecording = true;
          showASRResults();
          showNotification('ğŸ™ï¸ æ™ºèƒ½è¯­éŸ³è¯†åˆ«å·²å¯åŠ¨', 'success');
        });
        
        asrSocket.on('asr_disconnected', function() {
          console.log('â¹ï¸ ASRè¯­éŸ³è¯†åˆ«å·²æ–­å¼€');
          updateASRStatus('å·²æ–­å¼€', false);
          asrActive = false;
          asrRecording = false;
          updateASRButton();
        });
        
        asrSocket.on('asr_auto_stopped', function() {
          console.log('ğŸ›‘ æ™ºèƒ½å½•éŸ³å·²è‡ªåŠ¨åœæ­¢');
          updateASRStatus('è‡ªåŠ¨åœæ­¢', false);
          asrActive = false;
          asrRecording = false;
          updateASRButton();
          showNotification('ğŸ›‘ æ™ºèƒ½è¯†åˆ«å·²è‡ªåŠ¨åœæ­¢', 'info');
        });
        
        asrSocket.on('asr_result', function(data) {
          if (data.text) {
            console.log('ğŸ“ å®æ—¶è½¬å†™:', data.text);
            addASRResult(data.text, 'realtime');
          }
        });
        
        asrSocket.on('asr_final_result', function(data) {
          console.log('ğŸ¯ æœ€ç»ˆç»“æœ:', data);
          addASRResult(`æœ€ç»ˆç»“æœ (${data.count}å¥è¯): ${data.full_text}`, 'final');
          
          // å¦‚æœæœ‰å¤šä¸ªå¥å­ï¼Œæ˜¾ç¤ºåˆ†å¥è¯¦æƒ…
          if (data.sentences && data.sentences.length > 1) {
            data.sentences.forEach((sentence, index) => {
              addASRResult(`${index + 1}. ${sentence}`, 'sentence');
            });
          }
          
          // é¢è¯•ç³»ç»Ÿï¼šå¤„ç†ç”¨æˆ·å›ç­”
          if (awaitingAnswer && data.full_text) {
            if (interviewState === InterviewState.REVERSE_QA_WAITING) {
              // åé—®ç¯èŠ‚å¤„ç†
              handleReverseUserQuestion(data.full_text);
            } else {
              // æ™®é€šé¢è¯•å›ç­”å¤„ç†
              handleInterviewAnswer(data.full_text);
            }
          }
          
          showNotification(`ğŸ¯ è¯†åˆ«å®Œæˆï¼å…±${data.count}å¥è¯`, 'success');
        });
        
        asrSocket.on('asr_error', function(data) {
          console.error('âŒ ASRé”™è¯¯:', data.error);
          addASRResult(`é”™è¯¯: ${data.error}`, 'error');
          updateASRStatus('å‘ç”Ÿé”™è¯¯', false);
          showNotification('ASRè¯†åˆ«å‘ç”Ÿé”™è¯¯', 'error');
        });
        
      } catch (error) {
        console.error('ASRè¿æ¥å¤±è´¥:', error);
        updateASRStatus('è¿æ¥å¤±è´¥', false);
      }
    }
    
    // å¼€å§‹æ™ºèƒ½ASRè¯†åˆ«
    async function startSmartASR() {
      if (asrActive) {
        stopASRRecognition();
        return;
      }
      
      try {
        console.log('ğŸ™ï¸ å¯åŠ¨æ™ºèƒ½ASRè¯†åˆ«...');
        
        // æ¸…ç©ºä¹‹å‰çš„ç»“æœ
        clearASRResults();
        
        // åˆå§‹åŒ–å½•éŸ³
        await initASRRecording();
        
        // å‘é€å¼€å§‹æ™ºèƒ½è¯†åˆ«å‘½ä»¤
        asrSocket.emit('start_smart_asr');
        
        asrActive = true;
        updateASRButton();
        updateASRStatus('å¯åŠ¨ä¸­...', false);
        
      } catch (error) {
        console.error('å¯åŠ¨ASRå¤±è´¥:', error);
        showNotification('æ— æ³•è®¿é—®éº¦å…‹é£ï¼Œè¯·æ£€æŸ¥æƒé™è®¾ç½®', 'error');
        updateASRStatus('å¯åŠ¨å¤±è´¥', false);
      }
    }
    
    // åœæ­¢ASRè¯†åˆ«
    function stopASRRecognition() {
      if (!asrActive) return;
      
      console.log('ğŸ›‘ åœæ­¢ASRè¯†åˆ«...');
      
      asrActive = false;
      asrRecording = false;
      updateASRButton();
      updateASRStatus('åœæ­¢ä¸­...', false);
      
      // åœæ­¢å½•éŸ³å¤„ç†å™¨
      if (asrProcessor) {
        asrProcessor.disconnect();
        asrProcessor = null;
      }
      
      if (asrAudioContext) {
        asrAudioContext.close();
        asrAudioContext = null;
      }
      
      // å‘é€åœæ­¢å‘½ä»¤
      if (asrSocket) {
        asrSocket.emit('stop_asr');
      }
      
      updateASRStatus('å·²åœæ­¢', false);
      showNotification('ğŸ›‘ ASRè¯†åˆ«å·²åœæ­¢', 'info');
    }
    
    // åˆå§‹åŒ–ASRå½•éŸ³
    async function initASRRecording() {
      const stream = await navigator.mediaDevices.getUserMedia({ 
        audio: {
          sampleRate: 16000,
          channelCount: 1,
          sampleSize: 16
        } 
      });
      
      asrAudioContext = new AudioContext({ sampleRate: 16000 });
      const source = asrAudioContext.createMediaStreamSource(stream);
      asrProcessor = asrAudioContext.createScriptProcessor(1024, 1, 1);
      
      asrProcessor.onaudioprocess = function(e) {
        if (asrActive && asrRecording) {
          const audioData = e.inputBuffer.getChannelData(0);
          // è½¬æ¢ä¸º16ä½PCM
          const pcmData = new Int16Array(audioData.length);
          for (let i = 0; i < audioData.length; i++) {
            pcmData[i] = audioData[i] * 32767;
          }
          
          // è½¬æ¢ä¸ºbase64å¹¶å‘é€
          const audioBytes = new Uint8Array(pcmData.buffer);
          const base64Audio = btoa(String.fromCharCode.apply(null, audioBytes));
          asrSocket.emit('audio_data', { audio: base64Audio });
        }
      };
      
      source.connect(asrProcessor);
      asrProcessor.connect(asrAudioContext.destination);
      
      console.log('âœ… ASRå½•éŸ³åˆå§‹åŒ–å®Œæˆ');
    }
    
    // æ›´æ–°ASRçŠ¶æ€
    function updateASRStatus(status, isRecording) {
      const asrIndicator = document.getElementById('asrIndicator');
      const asrStatus = document.getElementById('asrStatus');
      const asrDot = document.getElementById('asrDot');
      
      if (asrIndicator && asrStatus && asrDot) {
        asrStatus.textContent = status;
        
        if (isRecording) {
          asrDot.classList.add('recording');
          asrIndicator.classList.add('show');
        } else {
          asrDot.classList.remove('recording');
          if (status === 'æœªè¿æ¥' || status === 'è¿æ¥å¤±è´¥') {
            asrIndicator.classList.remove('show');
          } else {
            asrIndicator.classList.add('show');
          }
        }
      }
    }
    
    // æ›´æ–°ASRæŒ‰é’®
    function updateASRButton() {
      const asrBtn = document.getElementById('asrBtn');
      if (asrBtn) {
        asrBtn.textContent = asrActive ? 'åœæ­¢è¯†åˆ«' : 'å¼€å§‹æ™ºèƒ½è¯†åˆ«';
      }
    }
    
    // æ˜¾ç¤º/éšè—ASRç»“æœ
    function toggleASRResults() {
      const asrResults = document.getElementById('asrResults');
      const asrResultsBtn = document.getElementById('asrResultsBtn');
      
      asrResultsVisible = !asrResultsVisible;
      
      if (asrResultsVisible) {
        asrResults.classList.add('show');
        asrResultsBtn.textContent = 'éšè—è½¬å†™';
      } else {
        asrResults.classList.remove('show');
        asrResultsBtn.textContent = 'æ˜¾ç¤ºè½¬å†™';
      }
    }
    
    // æ˜¾ç¤ºASRç»“æœåŒºåŸŸ
    function showASRResults() {
      const asrResults = document.getElementById('asrResults');
      const asrResultsBtn = document.getElementById('asrResultsBtn');
      
      if (!asrResultsVisible) {
        asrResults.classList.add('show');
        asrResultsBtn.textContent = 'éšè—è½¬å†™';
        asrResultsVisible = true;
      }
    }
    
    // æ·»åŠ ASRç»“æœ
    function addASRResult(text, type = 'realtime') {
      const asrContent = document.getElementById('asrContent');
      
      if (!asrContent) return;
      
      // å¦‚æœæ˜¯ç¬¬ä¸€æ¬¡æ·»åŠ ç»“æœï¼Œæ¸…é™¤ç­‰å¾…æ¶ˆæ¯
      const statusMsg = asrContent.querySelector('.asr-status');
      if (statusMsg && statusMsg.textContent === 'ç­‰å¾…è¯­éŸ³è¾“å…¥...') {
        asrContent.innerHTML = '';
      }
      
      const resultDiv = document.createElement('div');
      
      switch (type) {
        case 'realtime':
          resultDiv.className = 'asr-text';
          resultDiv.textContent = text;
          break;
        case 'final':
          resultDiv.className = 'asr-final';
          resultDiv.textContent = text;
          break;
        case 'sentence':
          resultDiv.className = 'asr-sentence';
          resultDiv.textContent = text;
          break;
        case 'error':
          resultDiv.className = 'asr-text';
          resultDiv.style.color = '#f44336';
          resultDiv.textContent = text;
          break;
        default:
          resultDiv.className = 'asr-text';
          resultDiv.textContent = text;
      }
      
      asrContent.appendChild(resultDiv);
      asrContent.scrollTop = asrContent.scrollHeight;
    }
    
    // æ¸…ç©ºASRç»“æœ
    function clearASRResults() {
      const asrContent = document.getElementById('asrContent');
      if (asrContent) {
        asrContent.innerHTML = '<div class="asr-status">ç­‰å¾…è¯­éŸ³è¾“å…¥...</div>';
      }
    }
    
    // å…¨å±€ASRå‡½æ•°
    window.startSmartASR = startSmartASR;
    window.toggleASRResults = toggleASRResults;
    
    // ==================== åŸæœ‰åŠŸèƒ½ä¿æŒä¸å˜ ====================
    
    window.toggleSettings = function() {
      const panel = document.getElementById('settingsPanel');
      settingsVisible = !settingsVisible;
      
      if (settingsVisible) {
        panel.classList.add('show');
      } else {
        panel.classList.remove('show');
      }
    }
    
    window.toggleSetting = function(element, settingName) {
      const isActive = element.classList.contains('active');
      
      if (isActive) {
        element.classList.remove('active');
        systemSettings[settingName] = false;
      } else {
        element.classList.add('active');
        systemSettings[settingName] = true;
      }
      
      // åº”ç”¨è®¾ç½®
      applySystemSetting(settingName, systemSettings[settingName]);
      updateDebugInfo();
    }
    
    // å¾®è¡¨æƒ…åˆ†æåŠŸèƒ½
    async function startFacialAnalysis() {
      if (facialAnalysisRunning) {
        console.log('å¾®è¡¨æƒ…åˆ†æå·²åœ¨è¿è¡Œä¸­');
        return;
      }
      
      try {
        console.log('ğŸ¬ å¯åŠ¨å¾®è¡¨æƒ…è‚¢ä½“åˆ†æ...');
        
        // è¯·æ±‚æ‘„åƒå¤´æƒé™
        await requestCameraPermission();
        
        const response = await fetch('/api/interview/start-facial-analysis', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          }
        });
        
        const data = await response.json();
        
        if (data.success) {
          facialAnalysisRunning = true;
          console.log('âœ… å¾®è¡¨æƒ…åˆ†æå·²å¯åŠ¨:', data.message);
          
          // å¼€å§‹å®šæœŸæ‹ç…§åˆ†æ
          startPeriodicPhotoCapture();
          
          // å¼€å§‹å®šæœŸæ£€æŸ¥çŠ¶æ€
          startAnalysisStatusMonitoring();
          updateDebugInfo();
          updateFacialAnalysisButton();
          
          // æ˜¾ç¤ºå¯åŠ¨é€šçŸ¥
          showNotification('ğŸ“¹ å¾®è¡¨æƒ…è‚¢ä½“åˆ†æå·²å¯åŠ¨', 'success');
        } else {
          console.error('âŒ å¯åŠ¨å¤±è´¥:', data.message);
          showNotification('å¯åŠ¨å¾®è¡¨æƒ…åˆ†æå¤±è´¥: ' + data.message, 'error');
        }
      } catch (error) {
        console.error('å¾®è¡¨æƒ…åˆ†æå¯åŠ¨é”™è¯¯:', error);
        showNotification('æ‘„åƒå¤´è®¿é—®å¤±è´¥ï¼Œè¯·æ£€æŸ¥æƒé™è®¾ç½®', 'error');
      }
    }
    
    function startPeriodicPhotoCapture() {
      if (!videoStream || !facialAnalysisRunning) return;
      
      // æ¯10ç§’æ‹ç…§ä¸€æ¬¡
      const captureInterval = setInterval(async () => {
        if (!facialAnalysisRunning) {
          clearInterval(captureInterval);
          return;
        }
        
        try {
          // åˆ›å»ºcanvasæ¥æ•è·è§†é¢‘å¸§
          const canvas = document.createElement('canvas');
          const video = document.createElement('video');
          video.srcObject = videoStream;
          video.play();
          
          video.onloadedmetadata = () => {
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            
            const ctx = canvas.getContext('2d');
            ctx.drawImage(video, 0, 0);
            
            // è½¬æ¢ä¸ºblobå¹¶å‘é€åˆ°åç«¯
            canvas.toBlob(async (blob) => {
              const formData = new FormData();
              formData.append('image', blob, 'capture.jpg');
              
              try {
                const response = await fetch('/api/interview/analyze-photo', {
                  method: 'POST',
                  body: formData
                });
                
                const result = await response.json();
                if (result.success) {
                  currentAnalysisCount++;
                  console.log(`ğŸ“Š ç¬¬${currentAnalysisCount}æ¬¡åˆ†æå®Œæˆ:`, result.analysis);
                  updateDebugInfo();
                }
              } catch (error) {
                console.error('ç…§ç‰‡åˆ†æå¤±è´¥:', error);
              }
            }, 'image/jpeg', 0.8);
          };
        } catch (error) {
          console.error('æ‹ç…§å¤±è´¥:', error);
        }
      }, 10000); // 10ç§’é—´éš”
    }
    
    async function stopFacialAnalysis() {
      if (!facialAnalysisRunning) {
        console.log('å¾®è¡¨æƒ…åˆ†ææœªåœ¨è¿è¡Œ');
        return;
      }
      
      try {
        console.log('ğŸ›‘ åœæ­¢å¾®è¡¨æƒ…è‚¢ä½“åˆ†æ...');
        
        const response = await fetch('/api/interview/stop-facial-analysis', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          }
        });
        
        const data = await response.json();
        
        if (data.success) {
          facialAnalysisRunning = false;
          stopAnalysisStatusMonitoring();
          
          // åœæ­¢æ‘„åƒå¤´æµ
          if (videoStream) {
            videoStream.getTracks().forEach(track => track.stop());
            videoStream = null;
          }
          
          console.log('âœ… å¾®è¡¨æƒ…åˆ†æå·²åœæ­¢:', data.message);
          console.log('ğŸ“Š åˆ†ææ€»ç»“:', data.summary);
          
          updateDebugInfo();
          updateFacialAnalysisButton();
          
          // æ˜¾ç¤ºåœæ­¢é€šçŸ¥å’Œç»“æœæ‘˜è¦
          if (data.summary) {
            const avgScore = data.summary.overall_score || 0;
            showNotification(`ğŸ“¹ åˆ†æå®Œæˆï¼ç»¼åˆå¾—åˆ†: ${avgScore}/10`, 'success');
          } else {
            showNotification('ğŸ“¹ å¾®è¡¨æƒ…åˆ†æå·²åœæ­¢', 'success');
          }
        } else {
          console.error('âŒ åœæ­¢å¤±è´¥:', data.message);
          showNotification('åœæ­¢åˆ†æå¤±è´¥: ' + data.message, 'error');
        }
      } catch (error) {
        console.error('åœæ­¢å¾®è¡¨æƒ…åˆ†æé”™è¯¯:', error);
        showNotification('åœæ­¢åˆ†ææ—¶å‘ç”Ÿé”™è¯¯', 'error');
      }
    }
    
    async function requestCameraPermission() {
      try {
        videoStream = await navigator.mediaDevices.getUserMedia({ 
          video: { width: 640, height: 480 },
          audio: false 
        });
        
        console.log('âœ… æ‘„åƒå¤´æƒé™å·²è·å–ï¼Œè§†é¢‘æµå·²å¯åŠ¨');
        return true;
      } catch (error) {
        console.error('âŒ æ‘„åƒå¤´æƒé™è·å–å¤±è´¥:', error);
        throw new Error('æ— æ³•è®¿é—®æ‘„åƒå¤´ï¼Œè¯·æ£€æŸ¥æµè§ˆå™¨æƒé™è®¾ç½®');
      }
    }
    
    function startAnalysisStatusMonitoring() {
      // æ¯5ç§’æ£€æŸ¥ä¸€æ¬¡åˆ†æçŠ¶æ€
      analysisStatusInterval = setInterval(async () => {
        try {
          const response = await fetch('/api/interview/facial-analysis-status');
          const data = await response.json();
          
          if (data.success) {
            facialAnalysisRunning = data.is_running;
            currentAnalysisCount = data.analysis_count;
            
            // å¦‚æœåˆ†ææ„å¤–åœæ­¢ï¼Œæ›´æ–°çŠ¶æ€
            if (!data.is_running && facialAnalysisRunning) {
              facialAnalysisRunning = false;
              stopAnalysisStatusMonitoring();
              showNotification('å¾®è¡¨æƒ…åˆ†æå·²è‡ªåŠ¨åœæ­¢', 'info');
            }
            
            updateDebugInfo();
          }
        } catch (error) {
          console.error('çŠ¶æ€ç›‘æ§é”™è¯¯:', error);
        }
      }, 5000);
    }
    
    function stopAnalysisStatusMonitoring() {
      if (analysisStatusInterval) {
        clearInterval(analysisStatusInterval);
        analysisStatusInterval = null;
      }
    }
    
    // è¯­è°ƒåˆ†æåŠŸèƒ½
    async function startVoiceAnalysis() {
      if (voiceAnalysisRunning) {
        console.log('è¯­è°ƒåˆ†æå·²åœ¨è¿è¡Œä¸­');
        return;
      }
      
      try {
        console.log('ğŸ¤ å¯åŠ¨è¯­è°ƒåˆ†æ...');
        
        // è¯·æ±‚éº¦å…‹é£æƒé™
        await requestMicrophonePermission();
        
        const response = await fetch('/api/interview/start-voice-analysis', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          }
        });
        
        const data = await response.json();
        
        if (data.success) {
          voiceAnalysisRunning = true;
          console.log('âœ… è¯­è°ƒåˆ†æå·²å¯åŠ¨:', data.message);
          
          // å¼€å§‹æµè§ˆå™¨ç«¯å½•éŸ³
          startBrowserRecording();
          
          // å¼€å§‹å®šæœŸæ£€æŸ¥çŠ¶æ€
          startVoiceStatusMonitoring();
          updateDebugInfo();
          updateVoiceAnalysisButton();
          
          // æ˜¾ç¤ºå¯åŠ¨é€šçŸ¥
          showNotification('ğŸ¤ è¯­è°ƒåˆ†æå·²å¯åŠ¨', 'success');
        } else {
          console.error('âŒ å¯åŠ¨å¤±è´¥:', data.message);
          showNotification('å¯åŠ¨è¯­è°ƒåˆ†æå¤±è´¥: ' + data.message, 'error');
        }
      } catch (error) {
        console.error('è¯­è°ƒåˆ†æå¯åŠ¨é”™è¯¯:', error);
        showNotification('éº¦å…‹é£è®¿é—®å¤±è´¥ï¼Œè¯·æ£€æŸ¥æƒé™è®¾ç½®', 'error');
      }
    }
    
    function startBrowserRecording() {
      if (!audioStream || !voiceAnalysisRunning) return;
      
      try {
        recordedChunks = [];
        
        // ä½¿ç”¨MediaRecorderå½•éŸ³
        mediaRecorder = new MediaRecorder(audioStream, {
          mimeType: 'audio/webm;codecs=opus'
        });
        
        mediaRecorder.ondataavailable = (event) => {
          if (event.data.size > 0) {
            recordedChunks.push(event.data);
          }
        };
        
        mediaRecorder.onstop = async () => {
          // å½•éŸ³ç»“æŸï¼Œå‘é€åˆ°åç«¯åˆ†æ
          if (recordedChunks.length > 0) {
            const audioBlob = new Blob(recordedChunks, { type: 'audio/webm' });
            await sendAudioForAnalysis(audioBlob);
          }
        };
        
        // å¼€å§‹å½•éŸ³
        mediaRecorder.start(1000); // æ¯ç§’ä¿å­˜ä¸€æ¬¡æ•°æ®
        isRecording = true;
        console.log('ğŸ¤ æµè§ˆå™¨å½•éŸ³å·²å¼€å§‹');
        
      } catch (error) {
        console.error('å½•éŸ³å¯åŠ¨å¤±è´¥:', error);
        showNotification('å½•éŸ³å¯åŠ¨å¤±è´¥', 'error');
      }
    }
    
    async function sendAudioForAnalysis(audioBlob) {
      try {
        const formData = new FormData();
        formData.append('audio', audioBlob, 'recording.webm');
        
        console.log('ğŸ“¤ å‘é€éŸ³é¢‘æ•°æ®è¿›è¡Œåˆ†æ...');
        
        const response = await fetch('/api/interview/analyze-audio', {
          method: 'POST',
          body: formData
        });
        
        const result = await response.json();
        if (result.success) {
          console.log('ğŸµ è¯­è°ƒåˆ†æå®Œæˆ:', result.analysis);
          
          // æ˜¾ç¤ºåˆ†æç»“æœé€šçŸ¥
          if (result.analysis && result.analysis.analysis_info) {
            const overallScore = result.analysis.analysis_info.overall_score || 0;
            showNotification(`ğŸ¤ è¯­è°ƒåˆ†æå®Œæˆï¼ç»¼åˆå¾—åˆ†: ${overallScore.toFixed(2)}/1.0`, 'success');
          } else {
            showNotification('ğŸ¤ è¯­è°ƒåˆ†æå®Œæˆï¼Œç»“æœå·²ä¿å­˜', 'success');
          }
          
          // æ›´æ–°è°ƒè¯•ä¿¡æ¯
          updateDebugInfo();
          
        } else {
          console.error('âŒ åˆ†æå¤±è´¥:', result.message);
          showNotification('è¯­è°ƒåˆ†æå¤±è´¥: ' + result.message, 'error');
        }
      } catch (error) {
        console.error('éŸ³é¢‘åˆ†æå¤±è´¥:', error);
        showNotification('éŸ³é¢‘åˆ†ææ—¶å‘ç”Ÿé”™è¯¯', 'error');
      }
    }
    
    async function stopVoiceAnalysis() {
      if (!voiceAnalysisRunning) {
        console.log('è¯­è°ƒåˆ†ææœªåœ¨è¿è¡Œ');
        return;
      }
      
      try {
        console.log('ğŸ›‘ åœæ­¢è¯­è°ƒåˆ†æ...');
        
        // åœæ­¢å½•éŸ³
        if (mediaRecorder && mediaRecorder.state !== 'inactive') {
          mediaRecorder.stop();
          // ç­‰å¾…å½•éŸ³æ•°æ®å¤„ç†å®Œæˆ
          await new Promise(resolve => {
            mediaRecorder.onstop = async () => {
              if (recordedChunks.length > 0) {
                const audioBlob = new Blob(recordedChunks, { type: 'audio/webm' });
                console.log('ğŸµ å¼€å§‹åˆ†æå½•éŸ³æ•°æ®...');
                await sendAudioForAnalysis(audioBlob);
              }
              resolve();
            };
          });
        }
        
        // åœæ­¢éº¦å…‹é£æµ
        if (audioStream) {
          audioStream.getTracks().forEach(track => track.stop());
          audioStream = null;
        }
        
        voiceAnalysisRunning = false;
        isRecording = false;
        stopVoiceStatusMonitoring();
        
        // é€šçŸ¥åç«¯åœæ­¢çŠ¶æ€ç›‘æ§
        const response = await fetch('/api/interview/stop-voice-analysis', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ browser_mode: true })
        });
        
        const data = await response.json();
        
        console.log('âœ… è¯­è°ƒåˆ†æå·²åœæ­¢');
        updateDebugInfo();
        updateVoiceAnalysisButton();
        
        // æ˜¾ç¤ºåœæ­¢é€šçŸ¥
        showNotification('ğŸ¤ è¯­è°ƒåˆ†æå·²åœæ­¢ï¼Œæ­£åœ¨å¤„ç†æ•°æ®...', 'success');
        
      } catch (error) {
        console.error('åœæ­¢è¯­è°ƒåˆ†æé”™è¯¯:', error);
        showNotification('åœæ­¢åˆ†ææ—¶å‘ç”Ÿé”™è¯¯', 'error');
      }
    }
    
    async function requestMicrophonePermission() {
      try {
        audioStream = await navigator.mediaDevices.getUserMedia({ 
          audio: { 
            sampleRate: 44100,
            channelCount: 1,
            echoCancellation: true,
            noiseSuppression: true 
          }
        });
        
        console.log('âœ… éº¦å…‹é£æƒé™å·²è·å–ï¼ŒéŸ³é¢‘æµå·²å¯åŠ¨');
        return true;
      } catch (error) {
        console.error('âŒ éº¦å…‹é£æƒé™è·å–å¤±è´¥:', error);
        throw new Error('æ— æ³•è®¿é—®éº¦å…‹é£ï¼Œè¯·æ£€æŸ¥æµè§ˆå™¨æƒé™è®¾ç½®');
      }
    }
    
    function startVoiceStatusMonitoring() {
      // æ¯5ç§’æ£€æŸ¥ä¸€æ¬¡åˆ†æçŠ¶æ€
      voiceStatusInterval = setInterval(async () => {
        try {
          const response = await fetch('/api/interview/voice-analysis-status');
          const data = await response.json();
          
          if (data.success) {
            voiceAnalysisRunning = data.is_running;
            isRecording = data.is_recording;
            
            // å¦‚æœåˆ†ææ„å¤–åœæ­¢ï¼Œæ›´æ–°çŠ¶æ€
            if (!data.is_running && voiceAnalysisRunning) {
              voiceAnalysisRunning = false;
              isRecording = false;
              stopVoiceStatusMonitoring();
              showNotification('è¯­è°ƒåˆ†æå·²è‡ªåŠ¨åœæ­¢', 'info');
            }
            
            updateDebugInfo();
          }
        } catch (error) {
          console.error('è¯­è°ƒçŠ¶æ€ç›‘æ§é”™è¯¯:', error);
        }
      }, 5000);
    }
    
    function stopVoiceStatusMonitoring() {
      if (voiceStatusInterval) {
        clearInterval(voiceStatusInterval);
        voiceStatusInterval = null;
      }
    }
    
    function showNotification(message, type = 'info') {
      // åˆ›å»ºé€šçŸ¥å…ƒç´ 
      const notification = document.createElement('div');
      notification.className = `notification ${type}`;
      notification.style.cssText = `
        position: fixed;
        top: 80px;
        right: 20px;
        background: ${type === 'success' ? 'rgba(76, 175, 80, 0.9)' : 
                     type === 'error' ? 'rgba(244, 67, 54, 0.9)' : 
                     'rgba(33, 150, 243, 0.9)'};
        color: white;
        padding: 12px 20px;
        border-radius: 8px;
        z-index: 1001;
        backdrop-filter: blur(10px);
        box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        animation: slideIn 0.3s ease;
        max-width: 300px;
        word-wrap: break-word;
      `;
      notification.textContent = message;
      
      // æ·»åŠ åˆ°é¡µé¢
      document.body.appendChild(notification);
      
      // 3ç§’åè‡ªåŠ¨ç§»é™¤
      setTimeout(() => {
        if (document.body.contains(notification)) {
          notification.style.animation = 'slideOut 0.3s ease';
          setTimeout(() => {
            if (document.body.contains(notification)) {
              document.body.removeChild(notification);
            }
          }, 300);
        }
      }, 3000);
    }
    
    function applySystemSetting(settingName, value) {
      switch (settingName) {
        case 'mouseFollow':
          if (window.Config && live2dSprite) {
            window.Config.MouseFollow = value;
          }
          break;
        case 'particles':
          const particlesCanvas = document.getElementById('particles-canvas');
          if (particlesCanvas) {
            particlesCanvas.style.display = value ? 'block' : 'none';
          }
          break;
        case 'voice':
          console.log('è¯­éŸ³æ’­æ”¾:', value ? 'å¼€å¯' : 'å…³é—­');
          break;
        case 'voiceAnalysis':
          console.log('è¯­è°ƒåˆ†æ:', value ? 'å¼€å¯' : 'å…³é—­');
          if (value && !voiceAnalysisRunning) {
            // å¦‚æœå¼€å¯ä¸”æœªè¿è¡Œï¼Œåˆ™å¯åŠ¨
            startVoiceAnalysis();
          } else if (!value && voiceAnalysisRunning) {
            // å¦‚æœå…³é—­ä¸”æ­£åœ¨è¿è¡Œï¼Œåˆ™åœæ­¢
            stopVoiceAnalysis();
          }
          break;
        case 'autoRecord':
          console.log('è‡ªåŠ¨å½•éŸ³:', value ? 'å¼€å¯' : 'å…³é—­');
          break;
        case 'facialAnalysis':
          console.log('å¾®è¡¨æƒ…è¯†åˆ«:', value ? 'å¼€å¯' : 'å…³é—­');
          if (value && !facialAnalysisRunning) {
            // å¦‚æœå¼€å¯ä¸”æœªè¿è¡Œï¼Œåˆ™å¯åŠ¨
            startFacialAnalysis();
          } else if (!value && facialAnalysisRunning) {
            // å¦‚æœå…³é—­ä¸”æ­£åœ¨è¿è¡Œï¼Œåˆ™åœæ­¢
            stopFacialAnalysis();
          }
          break;
        case 'asrRecognition':
          console.log('ASRè¯­éŸ³è¯†åˆ«:', value ? 'å¼€å¯' : 'å…³é—­');
          if (value && !asrActive) {
            // å¦‚æœå¼€å¯ä¸”æœªè¿è¡Œï¼Œåˆ™å¯åŠ¨
            startSmartASR();
          } else if (!value && asrActive) {
            // å¦‚æœå…³é—­ä¸”æ­£åœ¨è¿è¡Œï¼Œåˆ™åœæ­¢
            stopASRRecognition();
          }
          break;
        case 'ttsEnabled':
          console.log('TTSè¯­éŸ³åˆæˆ:', value ? 'å¼€å¯' : 'å…³é—­');
          if (value && !ttsEnabled) {
            // å¦‚æœå¼€å¯ä¸”æœªè¿è¡Œï¼Œåˆ™å¯åŠ¨
            startTTS();
          } else if (!value && ttsEnabled) {
            // å¦‚æœå…³é—­ä¸”æ­£åœ¨è¿è¡Œï¼Œåˆ™åœæ­¢
            stopTTS();
          }
          break;
      }
    }
    
    window.testThinking = function() {
      showThinking();
    }
    
    window.resetAnimation = function() {
      // æ¸…é™¤ç°æœ‰çš„è¶…æ—¶
      if (thinkingAnimationTimeout) {
        clearTimeout(thinkingAnimationTimeout);
      }
      
      // éšè—åŠ¨ç”»å¹¶é‡ç½®
      hideThinking();
      console.log('å¤ªç©ºä¿¡æ¯ä¼ è¾“åŠ¨ç”»å·²é‡ç½®');
    }
    
    window.toggleFacialAnalysis = function() {
      const facialBtn = document.getElementById('facialBtn');
      
      if (facialAnalysisRunning) {
        stopFacialAnalysis();
        facialBtn.textContent = 'å¼€å§‹åˆ†æ';
      } else {
        startFacialAnalysis();
        facialBtn.textContent = 'åœæ­¢åˆ†æ';
      }
    }
    
    window.toggleVoiceAnalysis = function() {
      const voiceBtn = document.getElementById('voiceBtn');
      
      if (voiceAnalysisRunning) {
        stopVoiceAnalysis();
        voiceBtn.textContent = 'å¼€å§‹å½•éŸ³';
      } else {
        startVoiceAnalysis();
        voiceBtn.textContent = 'åœæ­¢å½•éŸ³';
      }
    }
    
    // æ›´æ–°æŒ‰é’®æ–‡æœ¬çš„å‡½æ•°
    function updateFacialAnalysisButton() {
      const facialBtn = document.getElementById('facialBtn');
      if (facialBtn) {
        facialBtn.textContent = facialAnalysisRunning ? 'åœæ­¢åˆ†æ' : 'å¼€å§‹åˆ†æ';
      }
    }
    
    function updateVoiceAnalysisButton() {
      const voiceBtn = document.getElementById('voiceBtn');
      if (voiceBtn) {
        voiceBtn.textContent = voiceAnalysisRunning ? 'åœæ­¢å½•éŸ³' : 'å¼€å§‹å½•éŸ³';
      }
    }
    
    window.resetLive2D = function() {
      if (live2dSprite && app) {
        // é‡ç½®Live2Dæ¨¡å‹ä½ç½®
        const canvas = document.getElementById('live2d');
        const screenWidth = window.innerWidth * window.devicePixelRatio / 1.5;
        const screenHeight = window.innerHeight * window.devicePixelRatio / 1.5;
        
        live2dSprite.width = 3 * screenWidth;
        live2dSprite.height = 3 * screenHeight;
        live2dSprite.x = -0.75 * screenWidth;
        live2dSprite.y = -1.5 * screenHeight;
        
        updateDebugInfo();
        console.log('Live2Dæ¨¡å‹å·²é‡ç½®');
      }
    }
    
    window.toggleDebugInfo = function() {
      const debugInfo = document.getElementById('debugInfo');
      const isVisible = debugInfo.style.display !== 'none';
      
      if (isVisible) {
        debugInfo.style.display = 'none';
      } else {
        debugInfo.style.display = 'block';
        updateDebugInfo();
      }
    }
    
    function updateDebugInfo() {
      const debugInfo = document.getElementById('debugInfo');
      const timestamp = new Date().toLocaleTimeString();
      
      let info = `æ›´æ–°æ—¶é—´: ${timestamp}\n`;
      info += `Live2DçŠ¶æ€: ${live2dSprite ? 'æ­£å¸¸' : 'æœªåŠ è½½'}\n`;
      info += `åŠ¨ç”»çŠ¶æ€: å¤ªç©ºä¿¡æ¯ä¼ è¾“\n`;
      info += `éŸ³é¢‘çŠ¶æ€: ${systemSettings.voice ? 'å·²å¯ç”¨' : 'æœªå¯ç”¨'}\n`;
      info += `é¼ æ ‡è·Ÿéš: ${systemSettings.mouseFollow ? 'å¼€å¯' : 'å…³é—­'}\n`;
      info += `ç²’å­ç‰¹æ•ˆ: ${systemSettings.particles ? 'å¼€å¯' : 'å…³é—­'}\n`;
      info += `å¾®è¡¨æƒ…è¯†åˆ«: ${systemSettings.facialAnalysis ? 'å¼€å¯' : 'å…³é—­'}\n`;
      info += `åˆ†æçŠ¶æ€: ${facialAnalysisRunning ? 'è¿è¡Œä¸­' : 'å·²åœæ­¢'}\n`;
      info += `åˆ†ææ¬¡æ•°: ${currentAnalysisCount}\n`;
      info += `è¯­è°ƒåˆ†æ: ${systemSettings.voiceAnalysis ? 'å¼€å¯' : 'å…³é—­'}\n`;
      info += `å½•éŸ³çŠ¶æ€: ${voiceAnalysisRunning ? (isRecording ? 'å½•éŸ³ä¸­' : 'å‡†å¤‡ä¸­') : 'å·²åœæ­¢'}\n`;
      info += `ASRè¯†åˆ«: ${systemSettings.asrRecognition ? 'å¼€å¯' : 'å…³é—­'}\n`;
      info += `ASRçŠ¶æ€: ${asrActive ? (asrRecording ? 'å½•éŸ³è¯†åˆ«ä¸­' : 'å‡†å¤‡ä¸­') : 'å·²åœæ­¢'}\n`;
      info += `ASRè¿æ¥: ${asrSocket && asrSocket.connected ? 'å·²è¿æ¥' : 'æœªè¿æ¥'}\n`;
      info += `TTSåˆæˆ: ${systemSettings.ttsEnabled ? 'å¼€å¯' : 'å…³é—­'}\n`;
      info += `TTSçŠ¶æ€: ${ttsActive ? 'åˆæˆä¸­' : (ttsAudioPlayer && !ttsAudioPlayer.paused ? 'æ’­æ”¾ä¸­' : 'å·²åœæ­¢')}\n`;
      info += `å±å¹•å°ºå¯¸: ${window.innerWidth}x${window.innerHeight}\n`;
      info += `è®¾å¤‡åƒç´ æ¯”: ${window.devicePixelRatio}\n`;
      info += `ä¼ è¾“åŠ¨ç”»: ä¿¡å·â†’å«æ˜Ÿâ†’è¯­éŸ³`;
      
      debugInfo.textContent = info;
    }
    
    window.exportSettings = function() {
      const settings = {
        systemSettings: systemSettings,
        timestamp: new Date().toISOString(),
        userAgent: navigator.userAgent,
        screenSize: {
          width: window.innerWidth,
          height: window.innerHeight,
          devicePixelRatio: window.devicePixelRatio
        },
        asrStatus: {
          active: asrActive,
          recording: asrRecording,
          connected: asrSocket && asrSocket.connected
        },
        ttsStatus: {
          enabled: ttsEnabled,
          active: ttsActive,
          playing: ttsAudioPlayer && !ttsAudioPlayer.paused,
          currentSession: currentTTSSession
        }
      };
      
      const dataStr = JSON.stringify(settings, null, 2);
      const dataBlob = new Blob([dataStr], {type: 'application/json'});
      const url = URL.createObjectURL(dataBlob);
      
      const link = document.createElement('a');
      link.href = url;
      link.download = 'live2d_settings.json';
      link.click();
      
      URL.revokeObjectURL(url);
      console.log('è®¾ç½®å·²å¯¼å‡º');
    }
    
    // ç‚¹å‡»å¤–éƒ¨å…³é—­è®¾ç½®é¢æ¿
    document.addEventListener('click', function(event) {
      const settingsPanel = document.getElementById('settingsPanel');
      const settingsToggle = document.querySelector('.settings-toggle');
      
      if (settingsVisible && 
          !settingsPanel.contains(event.target) && 
          !settingsToggle.contains(event.target)) {
        toggleSettings();
      }
    });
    
    // ==================== TTSç›¸å…³å˜é‡å’ŒåŠŸèƒ½ ====================
    let ttsEnabled = false;
    let ttsActive = false;
    let ttsAudioChunks = [];
    let currentTTSSession = null;
    let ttsAudioPlayer = null;
    let ttsWAVFile = null;
    
    // WAVæ–‡ä»¶å¤´ç”Ÿæˆå·¥å…·
    function createWAVHeader(dataLength, sampleRate = 24000, channels = 1, bitsPerSample = 16) {
      const buffer = new ArrayBuffer(44);
      const view = new DataView(buffer);
      
      // RIFF chunk descriptor
      view.setUint32(0, 0x52494646, false); // "RIFF"
      view.setUint32(4, 36 + dataLength, true); // File size - 8
      view.setUint32(8, 0x57415645, false); // "WAVE"
      
      // fmt sub-chunk
      view.setUint32(12, 0x666d7420, false); // "fmt "
      view.setUint32(16, 16, true); // Subchunk1Size (16 for PCM)
      view.setUint16(20, 1, true); // AudioFormat (1 for PCM)
      view.setUint16(22, channels, true); // NumChannels
      view.setUint32(24, sampleRate, true); // SampleRate
      view.setUint32(28, sampleRate * channels * bitsPerSample / 8, true); // ByteRate
      view.setUint16(32, channels * bitsPerSample / 8, true); // BlockAlign
      view.setUint16(34, bitsPerSample, true); // BitsPerSample
      
      // data sub-chunk
      view.setUint32(36, 0x64617461, false); // "data"
      view.setUint32(40, dataLength, true); // Subchunk2Size
      
      return new Uint8Array(buffer);
    }
    
    function createWAVFile(pcmData) {
      const wavHeader = createWAVHeader(pcmData.length);
      const wavFile = new Uint8Array(wavHeader.length + pcmData.length);
      wavFile.set(wavHeader, 0);
      wavFile.set(pcmData, wavHeader.length);
      return wavFile;
    }
    
    // åˆå§‹åŒ–TTSç³»ç»Ÿ
    function initTTSSystem() {
      console.log('ğŸ¤ åˆå§‹åŒ–TTSè¯­éŸ³åˆæˆç³»ç»Ÿ...');
      
      // ç¡®ä¿ä½¿ç”¨å·²å­˜åœ¨çš„asrSocketè¿æ¥
      if (!asrSocket) {
        console.error('âŒ ASR Socketæœªåˆå§‹åŒ–ï¼Œæ— æ³•ä½¿ç”¨TTSåŠŸèƒ½');
        return;
      }
      
      // TTS Socketäº‹ä»¶å¤„ç†
      asrSocket.on('tts_synthesis_started', (data) => {
        console.log('ğŸµ TTSåˆæˆå·²å¯åŠ¨:', data.session_id);
        currentTTSSession = data.session_id;
        ttsAudioChunks = [];
        ttsActive = true;
        updateTTSStatus('åˆæˆä¸­...', false);
        updateTTSButtons();
        showNotification('ğŸµ å¼€å§‹è¯­éŸ³åˆæˆ...', 'info');
      });
      
      asrSocket.on('tts_audio_chunk', (data) => {
        if (data.session_id === currentTTSSession) {
          ttsAudioChunks.push(data);
          console.log(`ğŸµ æ”¶åˆ°TTSéŸ³é¢‘å— #${data.chunk_number}`);
          updateTTSStatus(`åˆæˆä¸­... (${data.chunk_number}å—)`, false);
        }
      });
      
      asrSocket.on('tts_synthesis_complete', (data) => {
        if (data.session_id === currentTTSSession) {
          console.log('ğŸµ TTSåˆæˆå®Œæˆï¼Œå…±', data.total_chunks, 'ä¸ªéŸ³é¢‘å—');
          ttsActive = false;
          updateTTSStatus('åˆæˆå®Œæˆ', false);
          updateTTSButtons();
          
          // ç”ŸæˆWAVæ–‡ä»¶å¹¶æ’­æ”¾
          if (ttsAudioChunks.length > 0) {
            generateAndPlayTTSAudio();
          }
          
          showNotification(`ğŸµ è¯­éŸ³åˆæˆå®Œæˆï¼å…±${data.total_chunks}ä¸ªéŸ³é¢‘å—`, 'success');
        }
      });
      
      asrSocket.on('tts_synthesis_error', (data) => {
        console.error('âŒ TTSåˆæˆé”™è¯¯:', data.error);
        ttsActive = false;
        updateTTSStatus('åˆæˆå¤±è´¥', false);
        updateTTSButtons();
        showNotification('TTSåˆæˆå¤±è´¥: ' + data.error, 'error');
        
        // ğŸ§  åˆæˆå¤±è´¥æ—¶éšè—æ€è€ƒåŠ¨ç”»
        hideThinking();
        console.log('ğŸ§  éšè—æ€è€ƒåŠ¨ç”» - TTSåˆæˆå¤±è´¥');
      });
      
      console.log('âœ… TTSç³»ç»Ÿåˆå§‹åŒ–å®Œæˆï¼Œå¤ç”¨ASR Socketè¿æ¥');
    }
    
    // ç”Ÿæˆå¹¶æ’­æ”¾TTSéŸ³é¢‘
    function generateAndPlayTTSAudio() {
      try {
        console.log('ğŸµ å¼€å§‹ç”ŸæˆWAVéŸ³é¢‘æ–‡ä»¶...');
        
        // åˆå¹¶æ‰€æœ‰PCMéŸ³é¢‘å—
        const allPCMData = ttsAudioChunks.map(chunk => {
          const binaryString = atob(chunk.audio_data);
          const bytes = new Uint8Array(binaryString.length);
          for (let i = 0; i < binaryString.length; i++) {
            bytes[i] = binaryString.charCodeAt(i);
          }
          return bytes;
        });
        
        // è®¡ç®—æ€»é•¿åº¦å¹¶åˆå¹¶PCMæ•°æ®
        const totalLength = allPCMData.reduce((sum, arr) => sum + arr.length, 0);
        const mergedPCM = new Uint8Array(totalLength);
        
        let offset = 0;
        for (const data of allPCMData) {
          mergedPCM.set(data, offset);
          offset += data.length;
        }
        
        // åˆ›å»ºWAVæ–‡ä»¶
        ttsWAVFile = createWAVFile(mergedPCM);
        const wavBlob = new Blob([ttsWAVFile], { type: 'audio/wav' });
        const url = URL.createObjectURL(wavBlob);
        
        // åˆ›å»ºæˆ–æ›´æ–°éŸ³é¢‘æ’­æ”¾å™¨
        if (!ttsAudioPlayer) {
          ttsAudioPlayer = new Audio();
          ttsAudioPlayer.onerror = () => {
            updateTTSStatus('æ’­æ”¾å¤±è´¥', false);
            showNotification('éŸ³é¢‘æ’­æ”¾å¤±è´¥', 'error');
            
            // æ’­æ”¾å¤±è´¥æ—¶ä¹Ÿè¦æ¸…ç†èµ„æº
            if (ttsAudioPlayer.src && ttsAudioPlayer.src.startsWith('blob:')) {
              URL.revokeObjectURL(ttsAudioPlayer.src);
            }
          };
        }
        
        // è®¾ç½®éŸ³é¢‘æºä½†ä¸æ’­æ”¾HTML Audio
        ttsAudioPlayer.src = url;
        
        // åªä½¿ç”¨Live2Dçš„è¯­éŸ³æ’­æ”¾åŠŸèƒ½ï¼Œé¿å…é‡å¤æ’­æ”¾
        if (live2dSprite && live2dSprite.playVoice) {
          try {
            // ğŸ§  éšè—æ€è€ƒåŠ¨ç”» - å¼€å§‹æ’­æ”¾è¯­éŸ³æ—¶
            hideThinking();
            console.log('ğŸ§  éšè—æ€è€ƒåŠ¨ç”» - å¼€å§‹æ’­æ”¾åˆæˆè¯­éŸ³');
            
            // è®¡ç®—éŸ³é¢‘æ—¶é•¿ï¼ˆä¼°ç®—ï¼‰
            const audioContext = new AudioContext();
            fetch(url)
              .then(response => response.arrayBuffer())
              .then(data => audioContext.decodeAudioData(data))
              .then(audioBuffer => {
                const duration = audioBuffer.duration * 1000; // è½¬æ¢ä¸ºæ¯«ç§’
                console.log(`ğŸµ éŸ³é¢‘æ—¶é•¿: ${(duration/1000).toFixed(2)}ç§’`);
                
                // è®¾ç½®å®šæ—¶å™¨ç›‘å¬æ’­æ”¾å®Œæˆ
                setTimeout(() => {
                  updateTTSStatus('æ’­æ”¾å®Œæˆ', false);
                  updateTTSButtons();
                  
                  console.log('ğŸ­ æ•°å­—äººè¯­éŸ³æ’­æ”¾å·²å®Œæˆ');
                  
                  // ğŸ“¡ è§¦å‘æ€è€ƒåŠ¨ç”» - è¯­éŸ³æ’­æ”¾å®Œæˆæ—¶
                  console.log('ğŸ§  è§¦å‘æ€è€ƒåŠ¨ç”» - è¯­éŸ³æ’­æ”¾å®Œæˆï¼ŒAIå‡†å¤‡å›åº”');
                  setTimeout(() => {
                    showThinking();
                  }, 500); // å»¶è¿Ÿ500msåæ’­æ”¾æ€è€ƒåŠ¨ç”»ï¼Œè®©ç”¨æˆ·æ„Ÿå—åˆ°è‡ªç„¶çš„åœé¡¿
                  
                  // ğŸ¯ é¢è¯•ç³»ç»Ÿå›è°ƒ - éŸ³é¢‘æ’­æ”¾å®Œæˆ
                  if (window.interviewTTSCallback && typeof window.interviewTTSCallback === 'function') {
                    console.log('ğŸ¯ è°ƒç”¨é¢è¯•ç³»ç»ŸTTSå®Œæˆå›è°ƒ');
                    window.interviewTTSCallback();
                  }
                  
                  // æ¸…ç†éŸ³é¢‘URLèµ„æº
                  if (ttsAudioPlayer.src && ttsAudioPlayer.src.startsWith('blob:')) {
                    URL.revokeObjectURL(ttsAudioPlayer.src);
                  }
                }, duration + 100); // æ·»åŠ 100msç¼“å†²æ—¶é—´
              })
              .catch(error => {
                console.warn('æ— æ³•è·å–éŸ³é¢‘æ—¶é•¿ï¼Œä½¿ç”¨é»˜è®¤ç›‘å¬æ–¹å¼:', error);
                
                // å¤‡ç”¨æ–¹æ¡ˆï¼šä½¿ç”¨Audioå…ƒç´ ç›‘å¬
                const tempAudio = new Audio(url);
                tempAudio.addEventListener('loadedmetadata', () => {
                  const duration = tempAudio.duration * 1000;
                  console.log(`ğŸµ éŸ³é¢‘æ—¶é•¿ï¼ˆå¤‡ç”¨ï¼‰: ${(duration/1000).toFixed(2)}ç§’`);
                  
                  setTimeout(() => {
                    updateTTSStatus('æ’­æ”¾å®Œæˆ', false);
                    updateTTSButtons();
                    
                    console.log('ğŸ­ æ•°å­—äººè¯­éŸ³æ’­æ”¾å·²å®Œæˆ');
                    
                    // ğŸ“¡ è§¦å‘æ€è€ƒåŠ¨ç”» - è¯­éŸ³æ’­æ”¾å®Œæˆæ—¶
                    console.log('ğŸ§  è§¦å‘æ€è€ƒåŠ¨ç”» - è¯­éŸ³æ’­æ”¾å®Œæˆï¼ŒAIå‡†å¤‡å›åº”');
                    setTimeout(() => {
                      showThinking();
                    }, 500);
                    
                    // ğŸ¯ é¢è¯•ç³»ç»Ÿå›è°ƒ - éŸ³é¢‘æ’­æ”¾å®Œæˆï¼ˆå¤‡ç”¨ï¼‰
                    if (window.interviewTTSCallback && typeof window.interviewTTSCallback === 'function') {
                      console.log('ğŸ¯ è°ƒç”¨é¢è¯•ç³»ç»ŸTTSå®Œæˆå›è°ƒï¼ˆå¤‡ç”¨ï¼‰');
                      window.interviewTTSCallback();
                    }
                    
                    // æ¸…ç†éŸ³é¢‘URLèµ„æº
                    if (ttsAudioPlayer.src && ttsAudioPlayer.src.startsWith('blob:')) {
                      URL.revokeObjectURL(ttsAudioPlayer.src);
                    }
                  }, duration + 100);
                });
              });
            
            // åªä½¿ç”¨Live2Dæ’­æ”¾è¯­éŸ³ï¼ˆåŒ…å«å˜´éƒ¨åŒæ­¥ï¼‰
            live2dSprite.playVoice({
              voicePath: url,
              immediate: true
            });
            
            console.log('ğŸµ TTSéŸ³é¢‘å¼€å§‹æ’­æ”¾ï¼ˆLive2Dï¼‰');
            console.log('ğŸ­ æ•°å­—äººå˜´éƒ¨åŠ¨ç”»å·²ç»‘å®šåˆ°TTSéŸ³é¢‘');
            updateTTSStatus('æ’­æ”¾ä¸­...', true);
            updateTTSButtons();
            showNotification('ğŸµ å¼€å§‹æ’­æ”¾è¯­éŸ³', 'success');
            
          } catch (error) {
            console.error('Live2Dè¯­éŸ³æ’­æ”¾å¤±è´¥:', error);
            updateTTSStatus('æ’­æ”¾å¤±è´¥', false);
            showNotification('è¯­éŸ³æ’­æ”¾å¤±è´¥', 'error');
            
            // Live2Dæ’­æ”¾å¤±è´¥æ—¶éšè—æ€è€ƒåŠ¨ç”»
            hideThinking();
          }
        } else {
          console.warn('ğŸ­ Live2Dæ¨¡å‹æœªåŠ è½½ï¼Œä½¿ç”¨HTML Audioæ’­æ”¾');
          
          // å¦‚æœLive2Dä¸å¯ç”¨ï¼Œæ‰ä½¿ç”¨HTML Audioæ’­æ”¾
          ttsAudioPlayer.onended = () => {
            updateTTSStatus('æ’­æ”¾å®Œæˆ', false);
            updateTTSButtons();
            
            // ğŸ“¡ è§¦å‘æ€è€ƒåŠ¨ç”» - è¯­éŸ³æ’­æ”¾å®Œæˆæ—¶
            console.log('ğŸ§  è§¦å‘æ€è€ƒåŠ¨ç”» - è¯­éŸ³æ’­æ”¾å®Œæˆï¼ŒAIå‡†å¤‡å›åº”');
            setTimeout(() => {
              showThinking();
            }, 500);
            
            // ğŸ¯ é¢è¯•ç³»ç»Ÿå›è°ƒ - éŸ³é¢‘æ’­æ”¾å®Œæˆï¼ˆHTML Audioæ¨¡å¼ï¼‰
            if (window.interviewTTSCallback && typeof window.interviewTTSCallback === 'function') {
              console.log('ğŸ¯ è°ƒç”¨é¢è¯•ç³»ç»ŸTTSå®Œæˆå›è°ƒï¼ˆHTML Audioæ¨¡å¼ï¼‰');
              window.interviewTTSCallback();
            }
            
            // æ¸…ç†éŸ³é¢‘URLèµ„æº
            if (ttsAudioPlayer.src && ttsAudioPlayer.src.startsWith('blob:')) {
              URL.revokeObjectURL(ttsAudioPlayer.src);
            }
          };
          
          ttsAudioPlayer.play().then(() => {
            console.log('ğŸµ TTSéŸ³é¢‘å¼€å§‹æ’­æ”¾ï¼ˆHTML Audioå¤‡ç”¨ï¼‰');
            updateTTSStatus('æ’­æ”¾ä¸­...', true);
            updateTTSButtons();
            showNotification('ğŸµ å¼€å§‹æ’­æ”¾è¯­éŸ³', 'success');
            
            // ğŸ§  éšè—æ€è€ƒåŠ¨ç”» - å¼€å§‹æ’­æ”¾è¯­éŸ³æ—¶
            hideThinking();
            console.log('ğŸ§  éšè—æ€è€ƒåŠ¨ç”» - å¼€å§‹æ’­æ”¾åˆæˆè¯­éŸ³');
          }).catch((error) => {
            console.error('æ’­æ”¾å¤±è´¥:', error);
            updateTTSStatus('æ’­æ”¾å¤±è´¥', false);
            showNotification('éŸ³é¢‘æ’­æ”¾å¤±è´¥ï¼Œè¯·æ£€æŸ¥æµè§ˆå™¨è®¾ç½®', 'error');
            
            // æ’­æ”¾å¤±è´¥æ—¶ä¹Ÿéšè—æ€è€ƒåŠ¨ç”»
            hideThinking();
          });
        }
        
        console.log(`âœ… WAVæ–‡ä»¶å·²ç”Ÿæˆ (${(ttsWAVFile.length / 1024).toFixed(1)} KB)`);
        
      } catch (error) {
        console.error('ç”ŸæˆWAVæ–‡ä»¶å¤±è´¥:', error);
        updateTTSStatus('ç”Ÿæˆå¤±è´¥', false);
        showNotification('éŸ³é¢‘ç”Ÿæˆå¤±è´¥', 'error');
      }
    }
    
    // å¼€å§‹TTSåˆæˆ
    function startTTSSynthesis() {
      const text = document.getElementById('ttsTextArea').value.trim();
      
      if (!text) {
        showNotification('è¯·è¾“å…¥è¦åˆæˆçš„æ–‡æœ¬', 'error');
        return;
      }
      
      if (ttsActive) {
        showNotification('æ­£åœ¨åˆæˆä¸­ï¼Œè¯·ç¨å€™', 'error');
        return;
      }
      
      console.log('ğŸµ å¼€å§‹TTSåˆæˆ:', text);
      ttsActive = true;
      updateTTSButtons();
      updateTTSStatus('å‡†å¤‡åˆæˆ...', false);
      
      // ğŸ“¡ è§¦å‘æ€è€ƒåŠ¨ç”» - è¯­éŸ³åˆæˆå¼€å§‹æ—¶
      console.log('ğŸ§  è§¦å‘æ€è€ƒåŠ¨ç”» - å¼€å§‹è¯­éŸ³åˆæˆå¤„ç†');
      showThinking();
      
      // å‘é€TTSåˆæˆè¯·æ±‚
      asrSocket.emit('tts_synthesize', { text: text });
    }
    
    // åœæ­¢TTSæ’­æ”¾
    function stopTTSPlayback() {
      if (ttsAudioPlayer && !ttsAudioPlayer.paused) {
        ttsAudioPlayer.pause();
        ttsAudioPlayer.currentTime = 0;
        updateTTSStatus('å·²åœæ­¢', false);
        updateTTSButtons();
        showNotification('ğŸ›‘ è¯­éŸ³æ’­æ”¾å·²åœæ­¢', 'info');
        
        // ğŸ§  æ‰‹åŠ¨åœæ­¢æ’­æ”¾æ—¶éšè—æ€è€ƒåŠ¨ç”»
        hideThinking();
        console.log('ğŸ§  éšè—æ€è€ƒåŠ¨ç”» - æ‰‹åŠ¨åœæ­¢TTSæ’­æ”¾');
        
        // åœæ­¢Live2Dè¯­éŸ³æ’­æ”¾å’Œå˜´éƒ¨åŠ¨ç”»
        if (live2dSprite && live2dSprite.stopVoice) {
          try {
            live2dSprite.stopVoice();
            console.log('ğŸ­ Live2Dè¯­éŸ³æ’­æ”¾å’Œå˜´éƒ¨åŠ¨ç”»å·²åœæ­¢ï¼ˆåŠŸèƒ½å…³é—­ï¼‰');
          } catch (error) {
            console.warn('ğŸ­ åœæ­¢Live2Dè¯­éŸ³æ’­æ”¾å¤±è´¥:', error);
          }
        }
        
        // æ¸…ç†éŸ³é¢‘URLèµ„æº
        if (ttsAudioPlayer.src && ttsAudioPlayer.src.startsWith('blob:')) {
          URL.revokeObjectURL(ttsAudioPlayer.src);
        }
      }
    }
    
    // æ›´æ–°TTSçŠ¶æ€
    function updateTTSStatus(status, isPlaying) {
      const ttsStatus = document.getElementById('ttsStatus');
      if (ttsStatus) {
        ttsStatus.textContent = status;
        
        if (isPlaying) {
          ttsStatus.style.color = '#4CAF50';
        } else if (status.includes('å¤±è´¥') || status.includes('é”™è¯¯')) {
          ttsStatus.style.color = '#f44336';
        } else {
          ttsStatus.style.color = 'rgba(255, 255, 255, 0.7)';
        }
      }
    }
    
    // æ›´æ–°TTSæŒ‰é’®çŠ¶æ€
    function updateTTSButtons() {
      const startBtn = document.getElementById('ttsStartBtn');
      const stopBtn = document.getElementById('ttsStopBtn');
      
      if (startBtn) {
        startBtn.disabled = ttsActive;
      }
      
      if (stopBtn) {
        const isPlaying = ttsAudioPlayer && !ttsAudioPlayer.paused;
        stopBtn.disabled = !isPlaying;
      }
    }
    
    // æ˜¾ç¤º/éšè—TTSæ–‡æœ¬è¾“å…¥åŒºåŸŸ
    function toggleTTSInput(show) {
      const ttsInput = document.getElementById('ttsTextInput');
      if (ttsInput) {
        ttsInput.style.display = show ? 'flex' : 'none';
      }
    }
    
    // TTSåŠŸèƒ½æ§åˆ¶
    function startTTS() {
      ttsEnabled = true;
      toggleTTSInput(true);
      console.log('ğŸµ TTSåŠŸèƒ½å·²å¯ç”¨');
    }
    
    function stopTTS() {
      ttsEnabled = false;
      toggleTTSInput(false);
      
      // ğŸ§  å…³é—­TTSåŠŸèƒ½æ—¶éšè—æ€è€ƒåŠ¨ç”»
      hideThinking();
      console.log('ğŸ§  éšè—æ€è€ƒåŠ¨ç”» - TTSåŠŸèƒ½å·²å…³é—­');
      
      // åœæ­¢å½“å‰æ’­æ”¾
      if (ttsAudioPlayer && !ttsAudioPlayer.paused) {
        ttsAudioPlayer.pause();
        
        // åœæ­¢æ•°å­—äººå˜´éƒ¨åŠ¨ç”»
        if (live2dSprite && live2dSprite.stopVoice) {
          try {
            live2dSprite.stopVoice();
            console.log('ğŸ­ æ•°å­—äººå˜´éƒ¨åŠ¨ç”»å·²åœæ­¢ï¼ˆåŠŸèƒ½å…³é—­ï¼‰');
          } catch (error) {
            console.warn('ğŸ­ åœæ­¢å˜´éƒ¨åŠ¨ç”»å¤±è´¥:', error);
          }
        }
        
        // æ¸…ç†éŸ³é¢‘URLèµ„æº
        if (ttsAudioPlayer.src && ttsAudioPlayer.src.startsWith('blob:')) {
          URL.revokeObjectURL(ttsAudioPlayer.src);
        }
      }
      
      ttsActive = false;
      updateTTSButtons();
      updateTTSStatus('å·²ç¦ç”¨', false);
      console.log('   TTSåŠŸèƒ½å·²ç¦ç”¨');
    }
    
    // å…¨å±€TTSå‡½æ•°
    window.startTTSSynthesis = startTTSSynthesis;
    window.stopTTSPlayback = stopTTSPlayback;
    
    // ==================== é¢è¯•ç³»ç»Ÿç›¸å…³å˜é‡ ====================

    let currentUser = null;
    let interviewConfig = null;
    let interviewQuestions = null;
    let currentSection = null;
    let currentSectionIndex = 0;
    let currentQuestionIndex = 0;
    let selectedSections = [];
    let interviewData = []; // å­˜å‚¨é¢è¯•é—®ç­”æ•°æ®
    let awaitingAnswer = false;
    
    // åé—®ç¯èŠ‚ç›¸å…³å˜é‡
    let reverseQAActive = false;
    let reverseQAData = [];
    let currentReverseRound = 0;
    const maxReverseRounds = 2; // æœ€å¤š2è½®åé—®
    
    // åé—®æç¤ºè¯­åˆ—è¡¨
    const reverseQuestionPrompts = [
      "æ¥ä¸‹æ¥æ˜¯åé—®ç¯èŠ‚ï¼Œä½ æœ‰ä»€ä¹ˆæƒ³é—®çš„å—ï¼Ÿ",
      "è¿˜æœ‰å…¶ä»–é—®é¢˜å—ï¼Ÿ",
      "æ‚¨è¿˜æœ‰ä»€ä¹ˆæƒ³äº†è§£çš„å—ï¼Ÿ",
      "æœ‰ä»€ä¹ˆé—®é¢˜æƒ³è¦å’¨è¯¢çš„å—ï¼Ÿ",
      "è¿˜æœ‰ä»€ä¹ˆç–‘é—®éœ€è¦è§£ç­”å—ï¼Ÿ",
      "æ‚¨è¿˜æƒ³äº†è§£å“ªäº›æ–¹é¢çš„æƒ…å†µï¼Ÿ",
      "æœ‰ä»€ä¹ˆå…¶ä»–æƒ³çŸ¥é“çš„å—ï¼Ÿ",
      "è¿˜éœ€è¦äº†è§£ä»€ä¹ˆä¿¡æ¯å—ï¼Ÿ"
    ];
    
    // é¢è¯•çŠ¶æ€æšä¸¾
    const InterviewState = {
      NOT_STARTED: 'not_started',
      INTRODUCTION: 'introduction',
      QUESTIONING: 'questioning', 
      WAITING_ANSWER: 'waiting_answer',
      NEXT_QUESTION: 'next_question',
      SECTION_COMPLETE: 'section_complete',
      REVERSE_QA: 'reverse_qa',
      REVERSE_QA_WAITING: 'reverse_qa_waiting',
      INTERVIEW_COMPLETE: 'interview_complete',
      PAUSED: 'paused'
    };
    
    let interviewState = InterviewState.NOT_STARTED;
    
    // åˆå§‹åŒ–é¢è¯•ç³»ç»Ÿ
    async function initInterviewSystem() {
      console.log('ğŸ¯ åˆå§‹åŒ–é¢è¯•ç³»ç»Ÿ...');
      
      try {
        // è·å–å½“å‰ç”¨æˆ·ä¿¡æ¯ï¼ˆä½¿ç”¨sessionStorageï¼‰
        const user = sessionStorage.getItem('user');
        if (!user) {
          console.warn('âš ï¸ æœªæ‰¾åˆ°ç™»å½•ç”¨æˆ·ï¼Œæ— æ³•å¯åŠ¨é¢è¯•');
          updateInterviewStatus('è¯·å…ˆç™»å½•');
          document.getElementById('startInterviewBtn').disabled = true;
          return;
        }
        
        const userData = JSON.parse(user);
        currentUser = userData.username;
        console.log(`ğŸ‘¤ å½“å‰ç”¨æˆ·: ${currentUser}`);
        
        // åŠ è½½ç”¨æˆ·çš„é¢è¯•é…ç½®
        await loadInterviewConfig();
        
        // æ›´æ–°é¢è¯•çŠ¶æ€æ˜¾ç¤º
        updateInterviewStatus('é¢è¯•å·²å°±ç»ªï¼Œç‚¹å‡»å¼€å§‹é¢è¯•');
        document.getElementById('startInterviewBtn').disabled = false;
        document.getElementById('mainStartInterviewBtn').disabled = false;
        
      } catch (error) {
        console.error('âŒ åˆå§‹åŒ–é¢è¯•ç³»ç»Ÿå¤±è´¥:', error);
        updateInterviewStatus('åˆå§‹åŒ–å¤±è´¥');
        document.getElementById('startInterviewBtn').disabled = true;
        document.getElementById('mainStartInterviewBtn').disabled = true;
      }
    }
    
    // åŠ è½½é¢è¯•é…ç½®
    async function loadInterviewConfig() {
      try {
        console.log(`ğŸ“‹ åŠ è½½ç”¨æˆ· ${currentUser} çš„é¢è¯•é…ç½®...`);
        
        // åŠ è½½é¢è¯•é…ç½®
        const configResponse = await fetch(`/uploads/${currentUser}/interview_config.json`);
        if (!configResponse.ok) {
          throw new Error('é¢è¯•é…ç½®æ–‡ä»¶ä¸å­˜åœ¨');
        }
        interviewConfig = await configResponse.json();
        
        // åŠ è½½é¢è¯•é¢˜ç›®
        const questionsResponse = await fetch(`/uploads/${currentUser}/interview_questions.json`);
        if (!questionsResponse.ok) {
          throw new Error('é¢è¯•é¢˜ç›®æ–‡ä»¶ä¸å­˜åœ¨');
        }
        interviewQuestions = await questionsResponse.json();
        
        // è·å–é€‰å®šçš„é¢è¯•æ¿å—
        selectedSections = interviewConfig.interview_config.selected_sections || [];
        
        console.log('âœ… é¢è¯•é…ç½®åŠ è½½æˆåŠŸ');
        console.log(`ğŸ“ é¢è¯•æ¿å—: ${selectedSections.join(', ')}`);
        console.log(`ğŸ‘¤ é¢è¯•è€…: ${interviewConfig.interview_config.candidate_name}`);
        console.log(`ğŸ¯ èŒä½: ${interviewConfig.interview_config.position}`);
        console.log(`ğŸ¢ å…¬å¸: ${interviewConfig.interview_config.target_company}`);
        
      } catch (error) {
        console.error('âŒ åŠ è½½é¢è¯•é…ç½®å¤±è´¥:', error);
        throw error;
      }
    }
    
    // æ›´æ–°é¢è¯•çŠ¶æ€æ˜¾ç¤º
    function updateInterviewStatus(status) {
      const statusElement = document.getElementById('interviewStatus');
      if (statusElement) {
        statusElement.textContent = status;
      }
    }
    
    // æ›´æ–°é¢è¯•è¿›åº¦
    function updateInterviewProgress() {
      const progressElement = document.getElementById('interviewProgress');
      const currentSectionElement = document.getElementById('currentSection');
      const questionProgressElement = document.getElementById('questionProgress');
      const progressBarElement = document.getElementById('progressBar');
      
      if (progressElement && currentSectionElement && questionProgressElement && progressBarElement) {
        if (interviewActive && selectedSections.length > 0) {
          progressElement.style.display = 'block';
          
          const sectionName = selectedSections[currentSectionIndex] || 'æœªçŸ¥';
          currentSectionElement.textContent = sectionName;
          
          // è®¡ç®—å½“å‰æ¿å—çš„é¢˜ç›®æ•°é‡
          let totalQuestions = 0;
          let currentQuestionNum = currentQuestionIndex + 1;
          
          if (sectionName !== 'è‡ªæˆ‘ä»‹ç»' && interviewQuestions && interviewQuestions.questions[sectionName]) {
            totalQuestions = interviewQuestions.questions[sectionName].length;
          } else if (sectionName === 'è‡ªæˆ‘ä»‹ç»') {
            totalQuestions = 1;
          }
          
          questionProgressElement.textContent = `${currentQuestionNum}/${totalQuestions}`;
          
          // è®¡ç®—æ€»ä½“è¿›åº¦
          const totalSections = selectedSections.length;
          const completedSections = currentSectionIndex;
          const sectionProgress = totalQuestions > 0 ? (currentQuestionIndex / totalQuestions) : 0;
          const totalProgress = ((completedSections + sectionProgress) / totalSections) * 100;
          
          progressBarElement.style.width = `${Math.min(100, totalProgress)}%`;
        } else {
          progressElement.style.display = 'none';
        }
      }
    }
    
    // å¼€å§‹é¢è¯•
    async function startInterview() {
      if (!currentUser || !interviewConfig || !selectedSections.length) {
        showNotification('é¢è¯•é…ç½®æœªå°±ç»ªï¼Œè¯·æ£€æŸ¥ç™»å½•çŠ¶æ€å’Œé…ç½®æ–‡ä»¶', 'error');
        return;
      }
      
      console.log('ğŸ¯ å¼€å§‹é¢è¯•...');
      interviewActive = true;
      interviewState = InterviewState.INTRODUCTION;
      currentSectionIndex = 0;
      currentQuestionIndex = 0;
      interviewData = [];
      
      // æ›´æ–°æŒ‰é’®çŠ¶æ€
      document.getElementById('startInterviewBtn').disabled = true;
      document.getElementById('mainStartInterviewBtn').disabled = true;
      document.getElementById('pauseInterviewBtn').disabled = false;
      document.getElementById('stopInterviewBtn').disabled = false;
      
      updateInterviewStatus('é¢è¯•è¿›è¡Œä¸­...');
      updateInterviewProgress();
      
      // å¼€å§‹ç¬¬ä¸€ä¸ªæ¿å—
      await startCurrentSection();
    }
    
    // å¼€å§‹å½“å‰æ¿å—
    async function startCurrentSection() {
      if (currentSectionIndex >= selectedSections.length) {
        await completeInterview();
        return;
      }
      
      currentSection = selectedSections[currentSectionIndex];
      currentQuestionIndex = 0;
      
      console.log(`ğŸ“‹ å¼€å§‹é¢è¯•æ¿å—: ${currentSection}`);
      updateInterviewProgress();
      
      if (currentSection === 'è‡ªæˆ‘ä»‹ç»') {
        await startIntroductionSection();
      } else {
        await startQuestionSection();
      }
    }
    
    // å¼€å§‹è‡ªæˆ‘ä»‹ç»æ¿å—
    async function startIntroductionSection() {
      const candidateName = interviewConfig.interview_config.candidate_name;
      const strictMode = interviewConfig.interview_config.strict_mode;
      
      let introText;
      if (strictMode) {
        introText = `ä½ å¥½${candidateName}ï¼Œæˆ‘æ˜¯ä»Šå¤©çš„é¢è¯•å®˜ã€‚æœ¬æ¬¡é¢è¯•å°†é‡‡ç”¨ä¸¥æ ¼æ¨¡å¼è¿›è¡Œï¼Œè¯·è®¤çœŸå›ç­”æ¯ä¸ªé—®é¢˜ã€‚ç°åœ¨ï¼Œè¯·å…ˆåšä¸€æ®µè¯¦ç»†çš„è‡ªæˆ‘ä»‹ç»ï¼ŒåŒ…æ‹¬æ‚¨çš„æ•™è‚²èƒŒæ™¯ã€å·¥ä½œç»éªŒå’Œä¸ªäººä¼˜åŠ¿ã€‚`;
      } else {
        introText = `ä½ å¥½${candidateName}ï¼Œæˆ‘æ˜¯ä»Šå¤©çš„é¢è¯•å®˜ï¼Œå¾ˆé«˜å…´è§åˆ°æ‚¨ã€‚è¯·å…ˆåšä¸€æ®µè‡ªæˆ‘ä»‹ç»ï¼Œè®©æˆ‘ä»¬æ›´å¥½åœ°äº†è§£æ‚¨ã€‚`;
      }
      
      console.log(`ğŸ¤ é¢è¯•å®˜: ${introText}`);
      
      // è®°å½•é—®é¢˜
      const questionData = {
        section: 'è‡ªæˆ‘ä»‹ç»',
        question: 'è¯·å¼€å§‹æ‚¨çš„è‡ªæˆ‘ä»‹ç»',
        timestamp: new Date().toISOString(),
        answer: null
      };
      interviewData.push(questionData);
      
      // TTSè¯­éŸ³åˆæˆ
      await speakQuestion(introText);
      
      // ç­‰å¾…ç”¨æˆ·å›ç­”
      awaitingAnswer = true;
      interviewState = InterviewState.WAITING_ANSWER;
      updateInterviewStatus('è¯·å¼€å§‹è‡ªæˆ‘ä»‹ç»...');
    }
    
    // å¼€å§‹é¢˜ç›®æ¿å—
    async function startQuestionSection() {
      const questions = interviewQuestions.questions[currentSection];
      
      if (!questions || questions.length === 0) {
        console.warn(`âš ï¸ æ¿å— ${currentSection} æ²¡æœ‰é¢˜ç›®ï¼Œè·³è¿‡`);
        await nextSection();
        return;
      }
      
      await askCurrentQuestion();
    }
    
    // æé—®å½“å‰é¢˜ç›®
    async function askCurrentQuestion() {
      const questions = interviewQuestions.questions[currentSection];
      
      if (currentQuestionIndex >= questions.length) {
        await nextSection();
        return;
      }
      
      const question = questions[currentQuestionIndex];
      const questionText = question.question;
      
      console.log(`â“ ç¬¬${currentQuestionIndex + 1}é¢˜: ${questionText}`);
      
      // è®°å½•é—®é¢˜
      const questionData = {
        section: currentSection,
        question: questionText,
        questionIndex: currentQuestionIndex + 1,
        importance: question.importance,
        difficulty: question.difficulty,
        timestamp: new Date().toISOString(),
        answer: null
      };
      interviewData.push(questionData);
      
      // TTSè¯­éŸ³åˆæˆ
      await speakQuestion(questionText);
      
      // ç­‰å¾…ç”¨æˆ·å›ç­”
      awaitingAnswer = true;
      interviewState = InterviewState.WAITING_ANSWER;
      updateInterviewStatus(`æ­£åœ¨æé—®ç¬¬${currentQuestionIndex + 1}é¢˜...`);
      updateInterviewProgress();
    }
    
    // è¯­éŸ³åˆæˆé—®é¢˜
    async function speakQuestion(text) {
      console.log(`ğŸµ å¼€å§‹è¯­éŸ³åˆæˆé—®é¢˜...`);
      
      // è®¾ç½®TTSæ–‡æœ¬
      const ttsTextArea = document.getElementById('ttsTextArea');
      if (ttsTextArea) {
        ttsTextArea.value = text;
      }
      
      // å¯ç”¨TTSåŠŸèƒ½ï¼ˆå¦‚æœæœªå¯ç”¨ï¼‰
      if (!systemSettings.ttsEnabled) {
        systemSettings.ttsEnabled = true;
        const ttsToggle = document.querySelector('[data-setting="ttsEnabled"]');
        if (ttsToggle) {
          ttsToggle.classList.add('active');
        }
        startTTS();
      }
      
      // è®¾ç½®éŸ³é¢‘æ’­æ”¾å®Œæˆåçš„å›è°ƒ
      return new Promise((resolve) => {
        // è®¾ç½®å…¨å±€å›è°ƒï¼Œå½“éŸ³é¢‘æ’­æ”¾å®Œæˆæ—¶è°ƒç”¨
        window.interviewTTSCallback = async () => {
          console.log('ğŸµ é¢è¯•TTSæ’­æ”¾å®Œæˆï¼Œå¼€å§‹ASRè¯†åˆ«');
          
          // å»¶è¿Ÿ1ç§’åå¼€å§‹ASRè¯†åˆ«ï¼Œç»™ç”¨æˆ·ååº”æ—¶é—´
          setTimeout(async () => {
            await startAnswerRecording();
            resolve();
          }, 1000);
          
          // æ¸…é™¤å›è°ƒ
          window.interviewTTSCallback = null;
        };
        
        // å¼€å§‹åˆæˆ
        startTTSSynthesis();
      });
    }
    
    // å¼€å§‹å½•éŸ³è¯†åˆ«ç­”æ¡ˆ
    async function startAnswerRecording() {
      console.log('ğŸ™ï¸ å¼€å§‹å½•éŸ³è¯†åˆ«ç”¨æˆ·å›ç­”...');
      
      // å¯ç”¨ASRåŠŸèƒ½ï¼ˆå¦‚æœæœªå¯ç”¨ï¼‰
      if (!systemSettings.asrRecognition) {
        systemSettings.asrRecognition = true;
        const asrToggle = document.querySelector('[data-setting="asrRecognition"]');
        if (asrToggle) {
          asrToggle.classList.add('active');
        }
        
        // æ˜¾ç¤ºASRç»“æœåŒºåŸŸ
        if (!asrResultsVisible) {
          toggleASRResults();
        }
      }
      
      // å¼€å§‹æ™ºèƒ½ASRè¯†åˆ«
      if (!asrActive) {
        startSmartASR();
      }
      
      updateInterviewStatus('è¯·å›ç­”é—®é¢˜ï¼ˆæ­£åœ¨å½•éŸ³è¯†åˆ«ï¼‰...');
    }
    
    // ä¸‹ä¸€é¢˜
    async function nextQuestion() {
      currentQuestionIndex++;
      await askCurrentQuestion();
    }
    
    // ä¸‹ä¸€ä¸ªæ¿å—
    async function nextSection() {
      console.log(`âœ… æ¿å— ${currentSection} å®Œæˆ`);
      currentSectionIndex++;
      await startCurrentSection();
    }
    
    // å®Œæˆé¢è¯•
    async function completeInterview() {
      console.log('ğŸ‰ æ‰€æœ‰é¢è¯•æ¿å—å®Œæˆï¼');
      
      // æ£€æŸ¥æ˜¯å¦åŒ…å«åé—®ç¯èŠ‚
      if (selectedSections.includes('åé—®ç¯èŠ‚')) {
        console.log('ğŸ”„ å¼€å§‹åé—®ç¯èŠ‚...');
        await startReverseQASection();
        return;
      }
      
      // å¦‚æœæ²¡æœ‰åé—®ç¯èŠ‚ï¼Œç›´æ¥ç»“æŸé¢è¯•
      await finalizeInterview();
    }
    
    // æœ€ç»ˆç»“æŸé¢è¯•
    async function finalizeInterview() {
      console.log('ğŸ‰ é¢è¯•å®Œå…¨ç»“æŸï¼');
      interviewActive = false;
      interviewState = InterviewState.INTERVIEW_COMPLETE;
      awaitingAnswer = false;
      reverseQAActive = false;
      
      // 1. åœæ­¢æ‰€æœ‰åˆ†æåŠŸèƒ½
      console.log('ğŸ›‘ æ­£åœ¨å…³é—­æ‰€æœ‰åˆ†æåŠŸèƒ½...');
      updateInterviewStatus('æ­£åœ¨å…³é—­åˆ†æåŠŸèƒ½...');
      
      // åœæ­¢ASRè¯†åˆ«
      if (asrActive) {
        console.log('ğŸ›‘ åœæ­¢ASRè¯†åˆ«');
        stopASRRecognition();
      }
      
      // åœæ­¢å¾®è¡¨æƒ…åˆ†æ
      if (typeof stopFacialAnalysis === 'function') {
        console.log('ğŸ›‘ åœæ­¢å¾®è¡¨æƒ…åˆ†æ');
        await stopFacialAnalysis();
      }
      
      // åœæ­¢è¯­è°ƒåˆ†æ  
      if (typeof stopVoiceAnalysis === 'function') {
        console.log('ğŸ›‘ åœæ­¢è¯­è°ƒåˆ†æ');
        await stopVoiceAnalysis();
      }
      
      // ç­‰å¾…åˆ†æå®Œæˆ
      await new Promise(resolve => setTimeout(resolve, 2000));
      
      // 2. ä¿å­˜é¢è¯•ç»“æœ
      console.log('ğŸ’¾ ä¿å­˜é¢è¯•ç»“æœ...');
      updateInterviewStatus('æ­£åœ¨ä¿å­˜é¢è¯•æ•°æ®...');
      await saveInterviewResults();
      
      // 3. è¿è¡Œé¢è¯•æ€»ç»“åˆ†æ
      console.log('ğŸ“Š å¼€å§‹AIé¢è¯•æ€»ç»“åˆ†æ...');
      updateInterviewStatus('æ­£åœ¨è¿›è¡ŒAIåˆ†æè¯„åˆ†...');
      
      try {
        const summaryResponse = await fetch('/api/interview/run-summary', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            username: currentUser
          })
        });
        
        const summaryResult = await summaryResponse.json();
        
        if (summaryResult.success) {
          console.log('âœ… é¢è¯•æ€»ç»“åˆ†æå®Œæˆ');
          updateInterviewStatus('AIåˆ†æå®Œæˆï¼');
          showNotification('ğŸ‰ é¢è¯•å®Œæˆï¼AIåˆ†æå·²ç”Ÿæˆ', 'success');
          
          // 4. æ›´æ–°æŒ‰é’®çŠ¶æ€
          document.getElementById('startInterviewBtn').disabled = false;
          document.getElementById('mainStartInterviewBtn').disabled = false;
          document.getElementById('pauseInterviewBtn').disabled = true;
          document.getElementById('stopInterviewBtn').disabled = true;
          
          // 5. å»¶è¿Ÿ3ç§’åè·³è½¬åˆ°ç»“æœé¡µé¢
          setTimeout(() => {
            console.log('ğŸ”„ è·³è½¬åˆ°é¢è¯•ç»“æœé¡µé¢');
            window.location.href = '/interview-result';
          }, 3000);
          
        } else {
          console.error('âŒ é¢è¯•æ€»ç»“åˆ†æå¤±è´¥:', summaryResult.message);
          updateInterviewStatus('åˆ†æå¤±è´¥ï¼Œä½†é¢è¯•å·²å®Œæˆ');
          showNotification('é¢è¯•å®Œæˆï¼Œä½†AIåˆ†æå¤±è´¥', 'warning');
          
          // å³ä½¿åˆ†æå¤±è´¥ï¼Œä¹Ÿè¦è·³è½¬åˆ°ç»“æœé¡µé¢
          setTimeout(() => {
            window.location.href = '/interview-result';
          }, 5000);
        }
        
      } catch (error) {
        console.error('âŒ è¿è¡Œé¢è¯•æ€»ç»“æ—¶å‘ç”Ÿé”™è¯¯:', error);
        updateInterviewStatus('é¢è¯•å·²å®Œæˆ');
        showNotification('é¢è¯•å®Œæˆï¼', 'success');
        
        // å‘ç”Ÿé”™è¯¯æ—¶ä¹Ÿè·³è½¬åˆ°ç»“æœé¡µé¢
        setTimeout(() => {
          window.location.href = '/interview-result';
        }, 3000);
      }
    }
    
    // æš‚åœé¢è¯•
    function pauseInterview() {
      if (!interviewActive) return;
      
      console.log('â¸ï¸ é¢è¯•å·²æš‚åœ');
      interviewState = InterviewState.PAUSED;
      awaitingAnswer = false;
      
      // åœæ­¢å½“å‰çš„è¯­éŸ³æ’­æ”¾å’Œå½•éŸ³
      if (ttsActive) {
        stopTTSPlayback();
      }
      if (asrActive) {
        stopASRRecognition();
      }
      
      updateInterviewStatus('é¢è¯•å·²æš‚åœ');
      
      // æ›´æ–°æŒ‰é’®çŠ¶æ€
      document.getElementById('startInterviewBtn').disabled = false;
      document.getElementById('mainStartInterviewBtn').disabled = false;
      document.getElementById('pauseInterviewBtn').disabled = true;
      
      showNotification('â¸ï¸ é¢è¯•å·²æš‚åœ', 'info');
    }
    
    // åœæ­¢é¢è¯•
    function stopInterview() {
      if (!interviewActive) return;
      
      console.log('ğŸ›‘ é¢è¯•å·²åœæ­¢');
      interviewActive = false;
      interviewState = InterviewState.NOT_STARTED;
      awaitingAnswer = false;
      
      // åœæ­¢æ‰€æœ‰æ’­æ”¾å’Œå½•éŸ³
      if (ttsActive) {
        stopTTSPlayback();
      }
      if (asrActive) {
        stopASRRecognition();
      }
      
      // é‡ç½®çŠ¶æ€
      currentSectionIndex = 0;
      currentQuestionIndex = 0;
      
      // æ›´æ–°æŒ‰é’®çŠ¶æ€
      document.getElementById('startInterviewBtn').disabled = false;
      document.getElementById('mainStartInterviewBtn').disabled = false;
      document.getElementById('pauseInterviewBtn').disabled = true;
      document.getElementById('stopInterviewBtn').disabled = true;
      
      updateInterviewStatus('é¢è¯•å·²åœæ­¢');
      updateInterviewProgress();
      
      showNotification('ğŸ›‘ é¢è¯•å·²åœæ­¢', 'info');
    }
    
    // ä¿å­˜é¢è¯•ç»“æœ
    async function saveInterviewResults() {
      try {
        console.log('ğŸ’¾ ä¿å­˜é¢è¯•ç»“æœ...');
        
        const qaData = generateQAMarkdown();
        
        const response = await fetch('/api/interview/save-results', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            username: currentUser,
            qa_content: qaData,
            interview_data: interviewData,
            reverse_qa_data: reverseQAData, // åŒ…å«åé—®ç¯èŠ‚æ•°æ®
            config: interviewConfig
          })
        });
        
        const result = await response.json();
        
        if (result.success) {
          console.log('âœ… é¢è¯•ç»“æœä¿å­˜æˆåŠŸ');
        } else {
          console.error('âŒ ä¿å­˜é¢è¯•ç»“æœå¤±è´¥:', result.message);
          showNotification('ä¿å­˜é¢è¯•ç»“æœå¤±è´¥', 'error');
        }
        
      } catch (error) {
        console.error('âŒ ä¿å­˜é¢è¯•ç»“æœæ—¶å‘ç”Ÿé”™è¯¯:', error);
        showNotification('ä¿å­˜é¢è¯•ç»“æœæ—¶å‘ç”Ÿé”™è¯¯', 'error');
      }
    }
    
    // ç”ŸæˆQA markdownæ ¼å¼
    function generateQAMarkdown() {
      const timestamp = new Date().toLocaleString('zh-CN', {
        year: 'numeric',
        month: '2-digit', 
        day: '2-digit',
        hour: '2-digit',
        minute: '2-digit',
        second: '2-digit'
      });
      
      let markdown = `\n\n<!-- START: é¢è¯•è®°å½• - ${timestamp} -->\n`;
      markdown += `## é¢è¯•è®°å½• - ${timestamp}\n\n`;
      markdown += `**é¢è¯•è€…ï¼š** ${interviewConfig.interview_config.candidate_name}\n`;
      markdown += `**èŒä½ï¼š** ${interviewConfig.interview_config.position}\n`;
      markdown += `**å…¬å¸ï¼š** ${interviewConfig.interview_config.target_company}\n`;
      markdown += `**é¢è¯•æ¨¡å¼ï¼š** ${interviewConfig.interview_config.strict_mode ? 'ä¸¥æ ¼æ¨¡å¼' : 'æ™®é€šæ¨¡å¼'}\n\n`;
      
      let currentSection = '';
      let questionCount = 0;
      
      // å¤„ç†æ™®é€šé¢è¯•é—®ç­”
      for (const item of interviewData) {
        if (item.section !== currentSection) {
          if (currentSection) {
            markdown += `<!-- END: ${currentSection} -->\n\n`;
          }
          currentSection = item.section;
          questionCount = 0;
          markdown += `<!-- START: ${currentSection} -->\n`;
          markdown += `## ${currentSection} - ${timestamp}\n\n`;
        }
        
        questionCount++;
        
        if (item.section === 'è‡ªæˆ‘ä»‹ç»') {
          markdown += `**é¢è¯•å®˜å¼€åœºç™½ï¼š**\n${item.question}\n\n`;
        } else {
          markdown += `**é¢è¯•å®˜é—®é¢˜${questionCount}ï¼š**\n${item.question}\n\n`;
        }
        
        if (item.answer) {
          markdown += `**é¢è¯•è€…å›ç­”ï¼š**\n${item.answer}\n\n`;
        } else {
          markdown += `**é¢è¯•è€…å›ç­”ï¼š**\nï¼ˆæœªå›ç­”æˆ–è¯†åˆ«å¤±è´¥ï¼‰\n\n`;
        }
      }
      
      if (currentSection) {
        markdown += `<!-- END: ${currentSection} -->\n\n`;
      }
      
      // å¤„ç†åé—®ç¯èŠ‚
      if (reverseQAData && reverseQAData.length > 0) {
        markdown += `<!-- START: åé—®ç¯èŠ‚ -->\n`;
        markdown += `## åé—®ç¯èŠ‚ - ${timestamp}\n\n`;
        
        for (const reverseItem of reverseQAData) {
          markdown += `### ç¬¬${reverseItem.round}è½®åé—® - ${new Date(reverseItem.timestamp).toLocaleString('zh-CN')}\n`;
          markdown += `**é—®é¢˜ç±»å‹**: ${reverseItem.questionType || 'æœªåˆ†ç±»'}\n`;
          markdown += `**é¢è¯•è€…é—®é¢˜**: ${reverseItem.userQuestion || 'ï¼ˆæœªæé—®ï¼‰'}\n`;
          markdown += `**é¢è¯•å®˜å›ç­”**: ${reverseItem.aiAnswer || 'ï¼ˆæœªå›ç­”ï¼‰'}\n\n`;
        }
        
        markdown += `<!-- END: åé—®ç¯èŠ‚ -->\n\n`;
      }
      
      markdown += `<!-- END: é¢è¯•è®°å½• - ${timestamp} -->\n`;
      
      return markdown;
    }
    
    // å…¨å±€é¢è¯•å‡½æ•°
    window.startInterview = startInterview;
    window.pauseInterview = pauseInterview;
    window.stopInterview = stopInterview;
    
    // å¤„ç†é¢è¯•å›ç­”
    async function handleInterviewAnswer(answer) {
      if (!awaitingAnswer || !interviewActive) return;
      
      console.log(`âœ… æ”¶åˆ°é¢è¯•å›ç­”: ${answer}`);
      awaitingAnswer = false;
      
      // ä¿å­˜å›ç­”åˆ°å½“å‰é—®é¢˜
      if (interviewData.length > 0) {
        const currentQuestion = interviewData[interviewData.length - 1];
        currentQuestion.answer = answer;
        currentQuestion.answered_at = new Date().toISOString();
      }
      
      // åœæ­¢ASRè¯†åˆ«
      if (asrActive) {
        stopASRRecognition();
      }
      
      updateInterviewStatus('å›ç­”å·²è®°å½•ï¼Œå‡†å¤‡ä¸‹ä¸€é¢˜...');
      
      // å»¶è¿Ÿ2ç§’åè¿›å…¥ä¸‹ä¸€é¢˜
      setTimeout(async () => {
        if (currentSection === 'è‡ªæˆ‘ä»‹ç»') {
          // è‡ªæˆ‘ä»‹ç»å®Œæˆï¼Œè¿›å…¥ä¸‹ä¸€ä¸ªæ¿å—
          await nextSection();
        } else {
          // è¿›å…¥ä¸‹ä¸€é¢˜æˆ–ä¸‹ä¸€ä¸ªæ¿å—
          await nextQuestion();
        }
      }, 2000);
    }
    
    // å…¨å±€å›ç­”å¤„ç†å‡½æ•°
    window.handleInterviewAnswer = handleInterviewAnswer;
    
    // ==================== åé—®ç¯èŠ‚åŠŸèƒ½ ====================
    
    // å¼€å§‹åé—®ç¯èŠ‚
    async function startReverseQASection() {
      console.log('ğŸ”„ å¼€å§‹åé—®ç¯èŠ‚');
      reverseQAActive = true;
      interviewState = InterviewState.REVERSE_QA;
      currentReverseRound = 0;
      reverseQAData = [];
      
      updateInterviewStatus('åé—®ç¯èŠ‚');
      updateInterviewProgress();
      
      // å¼€å§‹ç¬¬ä¸€è½®åé—®
      await conductReverseQARound();
    }
    
    // è¿›è¡Œä¸€è½®åé—®
    async function conductReverseQARound() {
      if (currentReverseRound >= maxReverseRounds) {
        console.log('   åé—®ç¯èŠ‚å·²è¾¾åˆ°æœ€å¤§è½®æ•°ï¼Œç»“æŸ');
        await finalizeInterview();
        return;
      }
      
      currentReverseRound++;
      console.log(`ğŸ”„ å¼€å§‹ç¬¬ ${currentReverseRound} è½®åé—®`);
      
      // éšæœºé€‰æ‹©åé—®æç¤ºè¯­
      let questionPrompt;
      if (currentReverseRound === 1) {
        questionPrompt = reverseQuestionPrompts[0]; // ç¬¬ä¸€è½®å›ºå®šä½¿ç”¨ç¬¬ä¸€ä¸ª
      } else {
        const randomIndex = Math.floor(Math.random() * (reverseQuestionPrompts.length - 1)) + 1;
        questionPrompt = reverseQuestionPrompts[randomIndex];
      }
      
      console.log(`ğŸ¤ åé—®æç¤ºè¯­: ${questionPrompt}`);
      updateInterviewStatus(`ç¬¬${currentReverseRound}è½®åé—® - è¯·æé—®`);
      
      // è®°å½•åé—®è½®æ¬¡å¼€å§‹
      const reverseRoundData = {
        round: currentReverseRound,
        prompt: questionPrompt,
        timestamp: new Date().toISOString(),
        userQuestion: null,
        aiAnswer: null,
        questionType: null
      };
      reverseQAData.push(reverseRoundData);
      
      // TTSåˆæˆåé—®æç¤ºè¯­
      await speakReverseQuestion(questionPrompt);
    }
    
    // è¯­éŸ³åˆæˆåé—®é—®é¢˜
    async function speakReverseQuestion(text) {
      console.log(`ğŸµ å¼€å§‹åˆæˆåé—®æç¤ºè¯­...`);
      
      // è®¾ç½®TTSæ–‡æœ¬
      const ttsTextArea = document.getElementById('ttsTextArea');
      if (ttsTextArea) {
        ttsTextArea.value = text;
      }
      
      // å¯ç”¨TTSåŠŸèƒ½ï¼ˆå¦‚æœæœªå¯ç”¨ï¼‰
      if (!systemSettings.ttsEnabled) {
        systemSettings.ttsEnabled = true;
        const ttsToggle = document.querySelector('[data-setting="ttsEnabled"]');
        if (ttsToggle) {
          ttsToggle.classList.add('active');
        }
        startTTS();
      }
      
      // è®¾ç½®éŸ³é¢‘æ’­æ”¾å®Œæˆåçš„å›è°ƒ
      return new Promise((resolve) => {
        // è®¾ç½®å…¨å±€å›è°ƒï¼Œå½“éŸ³é¢‘æ’­æ”¾å®Œæˆæ—¶è°ƒç”¨
        window.interviewTTSCallback = async () => {
          console.log('ğŸµ åé—®æç¤ºè¯­æ’­æ”¾å®Œæˆï¼Œå¼€å§‹å½•éŸ³è¯†åˆ«ç”¨æˆ·é—®é¢˜');
          
          // å»¶è¿Ÿ1ç§’åå¼€å§‹ASRè¯†åˆ«ç”¨æˆ·é—®é¢˜
          setTimeout(async () => {
            await startReverseQuestionRecording();
            resolve();
          }, 1000);
          
          // æ¸…é™¤å›è°ƒ
          window.interviewTTSCallback = null;
        };
        
        // å¼€å§‹åˆæˆ
        startTTSSynthesis();
      });
    }
    
    // å¼€å§‹å½•éŸ³è¯†åˆ«ç”¨æˆ·çš„åé—®
    async function startReverseQuestionRecording() {
      console.log('ğŸ™ï¸ å¼€å§‹å½•éŸ³è¯†åˆ«ç”¨æˆ·çš„åé—®...');
      
      // å¯ç”¨ASRåŠŸèƒ½ï¼ˆå¦‚æœæœªå¯ç”¨ï¼‰
      if (!systemSettings.asrRecognition) {
        systemSettings.asrRecognition = true;
        const asrToggle = document.querySelector('[data-setting="asrRecognition"]');
        if (asrToggle) {
          asrToggle.classList.add('active');
        }
        
        // æ˜¾ç¤ºASRç»“æœåŒºåŸŸ
        if (!asrResultsVisible) {
          toggleASRResults();
        }
      }
      
      // å¼€å§‹æ™ºèƒ½ASRè¯†åˆ«
      if (!asrActive) {
        startSmartASR();
      }
      
      awaitingAnswer = true;
      interviewState = InterviewState.REVERSE_QA_WAITING;
      updateInterviewStatus(`ç¬¬${currentReverseRound}è½®åé—® - è¯·æå‡ºæ‚¨çš„é—®é¢˜`);
    }
    
    // å¤„ç†åé—®ç¯èŠ‚çš„ç”¨æˆ·é—®é¢˜
    async function handleReverseUserQuestion(userQuestion) {
      if (!reverseQAActive || !awaitingAnswer) return;
      
      console.log(`ğŸ”„ æ”¶åˆ°ç”¨æˆ·åé—®: ${userQuestion}`);
      awaitingAnswer = false;
      
      // ä¿å­˜ç”¨æˆ·é—®é¢˜åˆ°å½“å‰è½®æ¬¡
      if (reverseQAData.length > 0) {
        const currentRound = reverseQAData[reverseQAData.length - 1];
        currentRound.userQuestion = userQuestion;
        currentRound.questionReceived = new Date().toISOString();
      }
      
      // åœæ­¢ASRè¯†åˆ«
      if (asrActive) {
        stopASRRecognition();
      }
      
      updateInterviewStatus(`ç¬¬${currentReverseRound}è½®åé—® - æ­£åœ¨åˆ†æé—®é¢˜...`);
      
      // è°ƒç”¨æ˜Ÿç«å¤§æ¨¡å‹åˆ†æé—®é¢˜
      const analysisResult = await analyzeUserQuestionWithSpark(userQuestion);
      
      // æ£€æŸ¥ç”¨æˆ·æ˜¯å¦æƒ³è¦åœæ­¢
      if (analysisResult.want_to_stop) {
        console.log('ğŸ¯ ç”¨æˆ·æƒ³è¦ç»“æŸåé—®ç¯èŠ‚');
        await finalizeInterview();
        return;
      }
      
      // ä¿å­˜AIå›ç­”
      if (reverseQAData.length > 0) {
        const currentRound = reverseQAData[reverseQAData.length - 1];
        currentRound.aiAnswer = analysisResult.answer;
        currentRound.questionType = analysisResult.question_type;
        currentRound.aiResponseTime = new Date().toISOString();
      }
      
      console.log(`ğŸ¤– AIå›ç­”: ${analysisResult.answer}`);
      updateInterviewStatus(`ç¬¬${currentReverseRound}è½®åé—® - æ­£åœ¨æ’­æ”¾å›ç­”...`);
      
      // TTSåˆæˆæ’­æ”¾AIå›ç­”
      await speakReverseAnswer(analysisResult.answer);
    }
    
    // è¯­éŸ³åˆæˆAIå›ç­”
    async function speakReverseAnswer(answer) {
      console.log(`ğŸµ å¼€å§‹åˆæˆAIå›ç­”...`);
      
      // è®¾ç½®TTSæ–‡æœ¬
      const ttsTextArea = document.getElementById('ttsTextArea');
      if (ttsTextArea) {
        ttsTextArea.value = answer;
      }
      
      // è®¾ç½®éŸ³é¢‘æ’­æ”¾å®Œæˆåçš„å›è°ƒ
      return new Promise((resolve) => {
        // è®¾ç½®å…¨å±€å›è°ƒï¼Œå½“éŸ³é¢‘æ’­æ”¾å®Œæˆæ—¶è°ƒç”¨
        window.interviewTTSCallback = async () => {
          console.log('ğŸµ AIå›ç­”æ’­æ”¾å®Œæˆ');
          
          // å»¶è¿Ÿ2ç§’åè¿›è¡Œä¸‹ä¸€è½®æˆ–ç»“æŸ
          setTimeout(async () => {
            if (currentReverseRound < maxReverseRounds) {
              await conductReverseQARound(); // è¿›è¡Œä¸‹ä¸€è½®
            } else {
              await finalizeInterview(); // ç»“æŸé¢è¯•
            }
            resolve();
          }, 2000);
          
          // æ¸…é™¤å›è°ƒ
          window.interviewTTSCallback = null;
        };
        
        // å¼€å§‹åˆæˆ
        startTTSSynthesis();
      });
    }
    
    // ä½¿ç”¨æ˜Ÿç«å¤§æ¨¡å‹åˆ†æç”¨æˆ·é—®é¢˜
    async function analyzeUserQuestionWithSpark(userQuestion) {
      try {
        const targetCompany = interviewConfig?.interview_config?.target_company || 'æŸå…¬å¸';
        const position = interviewConfig?.interview_config?.position || 'æŸå²—ä½';
        const techDomain = interviewConfig?.interview_config?.tech_domain || 'ç›¸å…³æŠ€æœ¯é¢†åŸŸ';
        const candidateName = interviewConfig?.interview_config?.candidate_name || 'é¢è¯•è€…';
        
        const prompt = `
è¿™æ˜¯ä¸€ä¸ªé¢è¯•åé—®ç¯èŠ‚ï¼Œé¢è¯•è€…å‘é¢è¯•å®˜æé—®ã€‚è¯·åˆ†æç”¨æˆ·çš„é—®é¢˜å¹¶å›ç­”ã€‚

ã€é¢è¯•èƒŒæ™¯ä¿¡æ¯ã€‘ï¼š
- ç›®æ ‡å…¬å¸ï¼š${targetCompany}
- é¢è¯•å²—ä½ï¼š${position}
- æŠ€æœ¯é¢†åŸŸï¼š${techDomain}
- é¢è¯•è€…ï¼š${candidateName}

ç”¨æˆ·é—®é¢˜ï¼š"${userQuestion}"

è¯·è¿”å›JSONæ ¼å¼çš„å“åº”ï¼ŒåŒ…å«ä»¥ä¸‹å­—æ®µï¼š
1. "want_to_stop": boolean - åˆ¤æ–­ç”¨æˆ·æ˜¯å¦æƒ³è¦ç»“æŸåé—®ç¯èŠ‚ï¼ˆå¦‚"æ²¡æœ‰äº†"ã€"ç»“æŸ"ã€"åœæ­¢"ç­‰ï¼‰
2. "answer": string - å¯¹ç”¨æˆ·é—®é¢˜çš„ä¸“ä¸šå›ç­”
3. "question_type": string - é—®é¢˜ç±»å‹ï¼ˆå¦‚"è–ªèµ„ç¦åˆ©"ã€"å·¥ä½œå†…å®¹"ã€"å…¬å¸æ–‡åŒ–"ã€"å‘å±•å‰æ™¯"ç­‰ï¼‰

æ³¨æ„ï¼š
- å¦‚æœç”¨æˆ·æœ‰ä¸æƒ³ç»§ç»­é—®ç­”çš„æ„æ„¿æ—¶ï¼Œå°†want_to_stopè®¾ä¸ºtrueï¼Œä»¥åœæ­¢é—®ç­”ã€‚
- å›ç­”è¦ä¸“ä¸šã€è¯¦ç»†ï¼Œç¬¦åˆé¢è¯•å®˜çš„èº«ä»½ï¼Œä½†è¦å°½é‡ç®€æ´ï¼Œä¸è¦å•°å—¦ã€‚
- å›ç­”æ—¶è¦ç»“åˆ${targetCompany}çš„èƒŒæ™¯å’Œ${position}å²—ä½çš„ç‰¹ç‚¹
- å¦‚æœé—®é¢˜ä¸æ¸…æ¥šï¼Œå¯ä»¥è¦æ±‚ç”¨æˆ·æ¾„æ¸…

è¿”å›æ ¼å¼ï¼š
{
    "want_to_stop": false,
    "answer": "å…·ä½“çš„å›ç­”å†…å®¹",
    "question_type": "é—®é¢˜ç±»å‹"
}`;
        
        console.log('ğŸ¤– æ­£åœ¨è°ƒç”¨æ˜Ÿç«å¤§æ¨¡å‹åˆ†æé—®é¢˜...');
        
        const response = await fetch('/api/interview/analyze-reverse-question', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            prompt: prompt,
            user_question: userQuestion,
            interview_config: interviewConfig?.interview_config || {}
          })
        });
        
        const result = await response.json();
        
        if (result.success) {
          console.log('âœ… æ˜Ÿç«å¤§æ¨¡å‹åˆ†æå®Œæˆ');
          return result.analysis;
        } else {
          console.error('âŒ æ˜Ÿç«å¤§æ¨¡å‹è°ƒç”¨å¤±è´¥:', result.message);
          return {
            want_to_stop: false,
            answer: "æŠ±æ­‰ï¼Œæˆ‘æš‚æ—¶æ— æ³•ç†è§£æ‚¨çš„é—®é¢˜ï¼Œè¯·æ‚¨å†è¯¦ç»†è¯´æ˜ä¸€ä¸‹ã€‚",
            question_type: "æœªè¯†åˆ«"
          };
        }
        
      } catch (error) {
        console.error('âŒ è°ƒç”¨æ˜Ÿç«å¤§æ¨¡å‹åˆ†ææ—¶å‘ç”Ÿé”™è¯¯:', error);
        return {
          want_to_stop: false,
          answer: "æŠ±æ­‰ï¼Œç³»ç»Ÿæš‚æ—¶æ— æ³•å¤„ç†æ‚¨çš„é—®é¢˜ï¼Œè¯·ç¨åå†è¯•ã€‚",
          question_type: "ç³»ç»Ÿé”™è¯¯"
        };
      }
    }
    
    // å…¨å±€åé—®å¤„ç†å‡½æ•°
    window.handleReverseUserQuestion = handleReverseUserQuestion;
  	</script>
</body>
</html>