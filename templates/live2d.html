<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>AI面试官 - 智能面试系统</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='css/index.css') }}">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    body {
      margin: 0;
      overflow: hidden;
      background-color: #f0f0f0;
      font-family: 'Inter', sans-serif;
    }
    
    canvas#live2d {
      width: 100vw;
      height: 100vh;
      position: absolute;
      top: 0;
      left: 0;
      z-index: 10;
    }
    
    /* 面试控制面板 */
    .interview-controls {
      position: fixed;
      top: 20px;
      right: 20px;
      background: rgba(255, 255, 255, 0.1);
      backdrop-filter: blur(20px);
      border-radius: 20px;
      padding: 20px;
      border: 1px solid rgba(255, 255, 255, 0.2);
      z-index: 20;
      min-width: 250px;
    }
    
    .control-title {
      color: white;
      font-size: 1.2rem;
      margin-bottom: 15px;
      text-align: center;
      font-weight: 600;
    }
    
    .control-btn {
      width: 100%;
      padding: 12px;
      margin: 8px 0;
      border: none;
      border-radius: 10px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      cursor: pointer;
      transition: all 0.3s ease;
      font-size: 14px;
      font-weight: 500;
    }
    
    .control-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 25px rgba(102, 126, 234, 0.4);
    }
    
    .control-btn:disabled {
      opacity: 0.6;
      cursor: not-allowed;
      transform: none;
    }
    
    .status-text {
      color: rgba(255, 255, 255, 0.8);
      font-size: 12px;
      text-align: center;
      margin: 10px 0;
      min-height: 20px;
    }
    
    /* 聊天区域 */
    .chat-area {
      position: fixed;
      bottom: 20px;
      left: 20px;
      right: 20px;
      background: rgba(255, 255, 255, 0.1);
      backdrop-filter: blur(20px);
      border-radius: 20px;
      padding: 20px;
      border: 1px solid rgba(255, 255, 255, 0.2);
      z-index: 20;
      max-height: 200px;
      display: flex;
      flex-direction: column;
    }
    
    .chat-messages {
      flex: 1;
      overflow-y: auto;
      margin-bottom: 15px;
      max-height: 120px;
    }
    
    .message {
      margin-bottom: 10px;
      padding: 8px 12px;
      border-radius: 10px;
      max-width: 80%;
      word-wrap: break-word;
      font-size: 14px;
    }
    
    .message.interviewer {
      background: rgba(102, 126, 234, 0.3);
      color: white;
      border: 1px solid rgba(102, 126, 234, 0.5);
      margin-right: auto;
    }
    
    .message.candidate {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      margin-left: auto;
    }
    
    .chat-input {
      display: flex;
      gap: 10px;
    }
    
    .chat-input input {
      flex: 1;
      padding: 12px;
      border: 1px solid rgba(255, 255, 255, 0.2);
      border-radius: 10px;
      background: rgba(255, 255, 255, 0.1);
      color: white;
      font-size: 14px;
    }
    
    .chat-input input:focus {
      outline: none;
      border-color: #667eea;
      box-shadow: 0 0 15px rgba(102, 126, 234, 0.3);
    }
    
    .chat-input input::placeholder {
      color: rgba(255, 255, 255, 0.5);
    }
    
    .send-btn {
      padding: 12px 20px;
      border: none;
      border-radius: 10px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      cursor: pointer;
      transition: all 0.3s ease;
    }
    
    .send-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
    }
    
    /* 返回按钮 */
    .back-btn {
      position: fixed;
      top: 20px;
      right: 140px;
      background: rgba(255, 255, 255, 0.1);
      border: 1px solid rgba(255, 255, 255, 0.2);
      color: white;
      padding: 15px 25px;
      border-radius: 30px;
      cursor: pointer;
      transition: all 0.3s ease;
      backdrop-filter: blur(10px);
      z-index: 100;
      font-size: 16px;
      font-weight: 500;
    }
    
    .back-btn:hover {
      background: rgba(255, 255, 255, 0.2);
      transform: translateY(-2px);
    }
    
    /* 主界面开始面试按钮 */
    .main-start-interview-btn {
      position: fixed;
      top: 20px;
      left: 80px;
      background: rgba(255, 255, 255, 0.1);
      border: 1px solid rgba(255, 255, 255, 0.2);
      color: white;
      padding: 12px 20px;
      border-radius: 12px;
      cursor: pointer;
      font-size: 16px;
      transition: all 0.3s ease;
      backdrop-filter: blur(10px);
      z-index: 100;
      display: flex;
      align-items: center;
      gap: 6px;
    }
    
    .main-start-interview-btn:hover {
      background: rgba(255, 255, 255, 0.2);
      transform: translateY(-2px);
    }
    
    .main-start-interview-btn:disabled {
      opacity: 0.6;
      cursor: not-allowed;
      transform: none;
    }
    
    /* 波动效果样式 */
    .rocket-wave {
      position: fixed;
      pointer-events: none;
      z-index: 9999;
      border: 2px solid rgba(255, 255, 255, 0.3);
      border-radius: 50%;
      animation: waveExpand 2s ease-out forwards;
    }
    
    @keyframes waveExpand {
      0% {
        width: 0;
        height: 0;
        opacity: 1;
        transform: translate(-50%, -50%);
      }
      100% {
        width: 200px;
        height: 200px;
        opacity: 0;
        transform: translate(-50%, -50%);
      }
    }
    
    /* 响应式设计 */
    @media (max-width: 768px) {
      .interview-controls {
        top: 10px;
        right: 10px;
        left: 10px;
        min-width: auto;
      }
      
      .chat-area {
        bottom: 10px;
        left: 10px;
        right: 10px;
      }
    }
    
    /* 通知动画 */
    @keyframes slideIn {
      from {
        transform: translateX(100%);
        opacity: 0;
      }
      to {
        transform: translateX(0);
        opacity: 1;
      }
    }
    
    @keyframes slideOut {
      from {
        transform: translateX(0);
        opacity: 1;
      }
      to {
        transform: translateX(100%);
        opacity: 0;
      }
    }
    
    /* AI思考动画 */
    .ai-thinking {
      position: fixed;
      bottom: 80px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(255, 255, 255, 0.1);
      backdrop-filter: blur(20px);
      border-radius: 20px;
      padding: 15px 25px;
      border: 1px solid rgba(255, 255, 255, 0.2);
      z-index: 1000;
      display: none;
      flex-direction: column;
      align-items: center;
      gap: 10px;
      min-width: 280px;
    }
    
    .thinking-progress {
      display: flex;
      align-items: center;
      gap: 15px;
      width: 100%;
      position: relative;
    }
    
    .thinking-icon {
      width: 35px;
      height: 35px;
      border-radius: 50%;
      background: rgba(255, 255, 255, 0.2);
      display: flex;
      align-items: center;
      justify-content: center;
      color: rgba(255, 255, 255, 0.4);
      font-size: 16px;
      transition: all 0.5s ease;
      position: relative;
      z-index: 2;
      flex-shrink: 0;
    }
    
    .thinking-icon.active {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      box-shadow: 0 0 20px rgba(102, 126, 234, 0.5);
      transform: scale(1.1);
    }
    
    .progress-line1 {
      flex: 1;
      height: 3px;
      background: rgba(255, 255, 255, 0.2);
      border-radius: 2px;
      position: relative;
      overflow: hidden;
    }

	.progress-line2 {
      flex: 1;
      height: 3px;
      background: rgba(255, 255, 255, 0.2);
      border-radius: 2px;
      position: relative;
      overflow: hidden;
    }
    
    .progress-fill1 {
	  height: 100%;
	  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
	  width: 0%;
	  border-radius: 2px;
	  transition: none; /* 默认无动画 */
	}
    
	.progress-fill2 {
	  height: 100%;
	  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
	  width: 0%;
	  border-radius: 2px;
	  transition: none; /* 默认无动画 */
	}

    .progress-fill1.animate {
      transition: width 1s ease;
    }
    
    .progress-fill2.animate {
      transition: width 1s ease;
    }
    
    /* 系统设置面板 */
    .system-settings {
      position: fixed;
      top: 20px;
      right: 20px;
      z-index: 200;
    }
    
    .settings-toggle {
      width: 50px;
      height: 50px;
      border-radius: 50%;
      background: rgba(255, 255, 255, 0.1);
      backdrop-filter: blur(20px);
      border: 1px solid rgba(255, 255, 255, 0.2);
      color: white;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 20px;
      transition: all 0.3s ease;
    }
    
    .settings-toggle:hover {
      background: rgba(255, 255, 255, 0.2);
      transform: rotate(90deg);
    }
    
    .settings-panel {
      position: absolute;
      top: 60px;
      right: 0;
      background: rgba(255, 255, 255, 0.1);
      backdrop-filter: blur(20px);
      border-radius: 15px;
      padding: 20px;
      border: 1px solid rgba(255, 255, 255, 0.2);
      min-width: 280px;
      display: none;
      flex-direction: column;
      gap: 15px;
      animation: slideDown 0.3s ease;
      max-height: 90vh;
      overflow-y: auto;
    }
    
    .settings-panel.show {
      display: flex;
    }
    
    @keyframes slideDown {
      from {
        opacity: 0;
        transform: translateY(-20px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }
    
    .panel-title {
      color: white;
      font-size: 18px;
      font-weight: 600;
      text-align: center;
      margin-bottom: 10px;
      border-bottom: 1px solid rgba(255, 255, 255, 0.2);
      padding-bottom: 10px;
    }
    
    .setting-item {
      display: flex;
      align-items: center;
      justify-content: space-between;
      color: white;
      font-size: 14px;
      padding: 8px 0;
    }
    
    .setting-label {
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .setting-toggle {
      width: 50px;
      height: 25px;
      border-radius: 15px;
      background: rgba(255, 255, 255, 0.2);
      position: relative;
      cursor: pointer;
      transition: all 0.3s ease;
    }
    
    .setting-toggle.active {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    }
    
    .toggle-slider {
      width: 21px;
      height: 21px;
      border-radius: 50%;
      background: white;
      position: absolute;
      top: 2px;
      left: 2px;
      transition: all 0.3s ease;
    }
    
    .setting-toggle.active .toggle-slider {
      transform: translateX(25px);
    }
    
    .setting-button {
      background: rgba(255, 255, 255, 0.1);
      border: 1px solid rgba(255, 255, 255, 0.2);
      color: white;
      padding: 8px 16px;
      border-radius: 8px;
      cursor: pointer;
      font-size: 12px;
      transition: all 0.3s ease;
    }
    
    .setting-button:hover {
      background: rgba(255, 255, 255, 0.2);
      transform: translateY(-2px);
    }
    
    .debug-info {
      background: rgba(0, 0, 0, 0.3);
      border-radius: 8px;
      padding: 10px;
      font-size: 12px;
      color: rgba(255, 255, 255, 0.8);
      font-family: 'Courier New', monospace;
      max-height: 150px;
      overflow-y: auto;
      white-space: pre-wrap;
    }
    
    /* ASR转写结果显示区域 */
    .asr-results {
      position: fixed;
      bottom: 250px;
      left: 20px;
      width: 400px;
      max-height: 300px;
      background: rgba(255, 255, 255, 0.1);
      backdrop-filter: blur(20px);
      border-radius: 15px;
      padding: 15px;
      border: 1px solid rgba(255, 255, 255, 0.2);
      z-index: 20;
      display: none;
      flex-direction: column;
      gap: 10px;
    }
    
    .asr-results.show {
      display: flex;
    }
    
    .asr-title {
      color: white;
      font-size: 16px;
      font-weight: 600;
      text-align: center;
      margin-bottom: 10px;
      border-bottom: 1px solid rgba(255, 255, 255, 0.2);
      padding-bottom: 8px;
    }
    
    .asr-content {
      flex: 1;
      overflow-y: auto;
      max-height: 200px;
    }
    
    .asr-text {
      padding: 8px 12px;
      margin: 5px 0;
      border-left: 3px solid #4CAF50;
      background: rgba(255, 255, 255, 0.1);
      border-radius: 6px;
      color: white;
      font-size: 13px;
      line-height: 1.4;
    }
    
    .asr-final {
      padding: 12px 16px;
      margin: 8px 0;
      border-left: 4px solid #2196F3;
      background: rgba(33, 150, 243, 0.2);
      border-radius: 8px;
      color: white;
      font-weight: 500;
      font-size: 14px;
    }
    
    .asr-status {
      text-align: center;
      color: rgba(255, 255, 255, 0.7);
      font-size: 12px;
      padding: 5px;
      font-style: italic;
    }
    
    .asr-sentence {
      padding: 6px 10px;
      margin: 3px 0;
      background: rgba(255, 255, 255, 0.05);
      border-radius: 4px;
      border-left: 2px solid #007bff;
      color: rgba(255, 255, 255, 0.9);
      font-size: 12px;
    }
    
    /* ASR状态指示器 */
    .asr-indicator {
      position: fixed;
      top: 80px;
      left: 20px;
      background: rgba(255, 255, 255, 0.1);
      backdrop-filter: blur(10px);
      border-radius: 25px;
      padding: 8px 15px;
      border: 1px solid rgba(255, 255, 255, 0.2);
      z-index: 150;
      display: none;
      align-items: center;
      gap: 8px;
      color: white;
      font-size: 13px;
    }
    
    .asr-indicator.show {
      display: flex;
    }
    
    .asr-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: #4CAF50;
      animation: pulse 1.5s infinite;
    }
    
    .asr-dot.recording {
      background: #f44336;
      animation: blink 0.8s infinite;
    }
    
    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }
    
    @keyframes blink {
      0%, 50% { opacity: 1; }
      51%, 100% { opacity: 0; }
    }
  </style>
</head>
<body>
  <!-- 火箭鼠标样式 -->
  <div class="rocket-cursor" id="rocketCursor">
    <div class="rocket-nose"></div>
    <div class="rocket-body"></div>
    <div class="rocket-fins"></div>
    <div class="rocket-engine"></div>
  </div>
  
  <!-- 高级粒子效果容器 -->
  <div class="particles-container">
    <canvas id="particles-canvas"></canvas>
  </div>
  
  <!-- 背景流星效果 -->
  <div class="meteor-container"></div>
  
  <!-- 星光特效 -->
  <div class="stars-container"></div>
  
  <!-- 星空装饰元素 -->
  <!-- 行星悬浮 -->
  <div class="planet saturn"></div>
  <div class="planet jupiter"></div>
  
  <!-- 望远镜 -->
  <div class="telescope"></div>
  
  <!-- 观星小人 -->
  <div class="stargazer"></div>
  
  <!-- 星座图案 -->
  <div class="constellation big-dipper"></div>
  <div class="constellation orion"></div>
  
  <!-- 流星痕迹 -->
  <div class="meteor-trail left"></div>
  <div class="meteor-trail right"></div>
  <div class="meteor-trail center"></div>
  
  <!-- 空间站 -->
  <div class="space-station right"></div>
  
  <!-- 返回按钮 -->
  <button class="back-btn" onclick="goBack()">
    <i class="fas fa-arrow-left"></i> 返回主页
  </button>

  <!-- 主界面开始面试按钮 -->
  <button class="main-start-interview-btn" onclick="startInterview()" id="mainStartInterviewBtn" disabled>
    <i class="fas fa-play"></i> 开始面试
  </button>

  <!-- AI思考动画 -->
  <div class="ai-thinking" id="aiThinking">
    <div class="thinking-progress">
      <div class="thinking-icon" id="thinkingIcon1">
        <i class="fas fa-broadcast-tower"></i>
      </div>
      <div class="progress-line1">
        <div class="progress-fill1" id="progressFill1"></div>
      </div>
      <div class="thinking-icon" id="thinkingIcon2">
        <i class="fas fa-satellite"></i>
      </div>
      <div class="progress-line2">
        <div class="progress-fill2" id="progressFill2"></div>
      </div>
      <div class="thinking-icon" id="thinkingIcon3">
        <i class="fa-solid fa-podcast"></i>
      </div>
    </div>
  </div>
  
  <!-- ASR状态指示器
  <div class="asr-indicator" id="asrIndicator">
    <div class="asr-dot" id="asrDot"></div>
    <span id="asrStatus">未连接</span>
  </div> -->
  
  <!-- 系统设置面板 -->
  <div class="system-settings">
    <div class="settings-toggle" onclick="toggleSettings()">
      <i class="fas fa-cog"></i>
    </div>
    <div class="settings-panel" id="settingsPanel">
      <div class="panel-title">
        <i class="fas fa-tools"></i> 系统设置
      </div>
            <!-- 面试功能区域 -->
      <div class="setting-item" style="border-top: 1px solid rgba(255, 255, 255, 0.2); margin-top: 15px; padding-top: 15px;">
        <div class="setting-label" style="width: 100%; flex-direction: column; align-items: stretch; gap: 10px;">
          <div style="display: flex; align-items: center; gap: 8px;">
            <i class="fas fa-user-tie"></i>
            <span>AI面试系统</span>
          </div>
          
          <!-- 面试状态显示 -->
          <div id="interviewStatus" style="
            background: rgba(255, 255, 255, 0.1);
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 12px;
            text-align: center;
            color: rgba(255, 255, 255, 0.8);
          ">正在初始化...</div>
          
          <!-- 面试进度 -->
          <div id="interviewProgress" style="display: none;">
            <div style="font-size: 11px; color: rgba(255, 255, 255, 0.6); margin-bottom: 4px;">
              <span id="currentSection">准备中</span> (<span id="questionProgress">0/0</span>)
            </div>
            <div style="background: rgba(255, 255, 255, 0.2); height: 4px; border-radius: 2px; overflow: hidden;">
              <div id="progressBar" style="
                height: 100%;
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                width: 0%;
                transition: width 0.3s ease;
              "></div>
            </div>
          </div>
          
          <!-- 面试控制按钮 -->
          <div style="display: flex; gap: 5px; margin-top: 8px;">
            <button class="setting-button" onclick="startInterview()" id="startInterviewBtn" style="flex: 1;" disabled>
              <i class="fas fa-play"></i> 开始面试
            </button>
            <button class="setting-button" onclick="pauseInterview()" id="pauseInterviewBtn" style="flex: 1;" disabled>
              <i class="fas fa-pause"></i> 暂停
            </button>
            <button class="setting-button" onclick="stopInterview()" id="stopInterviewBtn" style="flex: 1;" disabled>
              <i class="fas fa-stop"></i> 结束
            </button>
          </div>
        </div>
      </div>
      
      <div class="setting-item">
        <div class="setting-label">
          <i class="fas fa-volume-up"></i>
          <span>语音播放</span>
        </div>
        <div class="setting-toggle" onclick="toggleSetting(this, 'voice')" data-setting="voice">
          <div class="toggle-slider"></div>
        </div>
      </div>
      
      <div class="setting-item">
        <div class="setting-label">
          <i class="fas fa-microphone"></i>
          <span>语调分析</span>
        </div>
        <div class="setting-toggle active" onclick="toggleSetting(this, 'voiceAnalysis')" data-setting="voiceAnalysis">
          <div class="toggle-slider"></div>
        </div>
      </div>
      
      <div class="setting-item">
        <div class="setting-label">
          <i class="fas fa-microphone"></i>
          <span>自动录音</span>
        </div>
        <div class="setting-toggle" onclick="toggleSetting(this, 'autoRecord')" data-setting="autoRecord">
          <div class="toggle-slider"></div>
        </div>
      </div>
      
      <!-- 新增ASR语音识别开关 -->
      <div class="setting-item">
        <div class="setting-label">
          <i class="fas fa-comments"></i>
          <span>ASR语音识别</span>
        </div>
        <div class="setting-toggle" onclick="toggleSetting(this, 'asrRecognition')" data-setting="asrRecognition">
          <div class="toggle-slider"></div>
        </div>
      </div>
      
      <!-- 新增TTS语音合成开关 -->
      <div class="setting-item">
        <div class="setting-label">
          <i class="fas fa-volume-up"></i>
          <span>TTS语音合成</span>
        </div>
        <div class="setting-toggle" onclick="toggleSetting(this, 'ttsEnabled')" data-setting="ttsEnabled">
          <div class="toggle-slider"></div>
        </div>
      </div>
      
      <div class="setting-item">
        <div class="setting-label">
          <i class="fas fa-camera"></i>
          <span>微表情识别</span>
        </div>
        <div class="setting-toggle active" onclick="toggleSetting(this, 'facialAnalysis')" data-setting="facialAnalysis">
          <div class="toggle-slider"></div>
        </div>
      </div>
    
      <div class="setting-item">
        <div class="setting-label">
          <i class="fas fa-eye"></i>
          <span>鼠标跟随</span>
        </div>
        <div class="setting-toggle active" onclick="toggleSetting(this, 'mouseFollow')" data-setting="mouseFollow">
          <div class="toggle-slider"></div>
        </div>
      </div>
      
      <div class="setting-item">
        <div class="setting-label">
          <i class="fas fa-rocket"></i>
          <span>粒子特效</span>
        </div>
        <div class="setting-toggle active" onclick="toggleSetting(this, 'particles')" data-setting="particles">
          <div class="toggle-slider"></div>
        </div>
      </div>
      
      <!-- TTS文本输入区域 -->
      <div class="setting-item" id="ttsTextInput" style="display: none; flex-direction: column; align-items: stretch;">
        <div class="setting-label" style="margin-bottom: 8px;">
          <i class="fas fa-edit"></i>
          <span>合成文本 (聆小琪)</span>
        </div>
        <textarea id="ttsTextArea" placeholder="请输入要合成的文本..." style="
          width: 100%;
          min-height: 60px;
          padding: 8px;
          border: 1px solid rgba(255, 255, 255, 0.3);
          border-radius: 6px;
          background: rgba(255, 255, 255, 0.1);
          color: white;
          font-size: 12px;
          resize: vertical;
          margin-bottom: 8px;
        ">你好，我是AI面试官，很高兴为您提供服务。请问有什么可以帮助您的吗？</textarea>
        <div style="display: flex; gap: 5px;">
          <button class="setting-button" onclick="startTTSSynthesis()" id="ttsStartBtn" style="flex: 1;">
            <i class="fas fa-play"></i> 开始合成
          </button>
          <button class="setting-button" onclick="stopTTSPlayback()" id="ttsStopBtn" style="flex: 1;" disabled>
            <i class="fas fa-stop"></i> 停止播放
          </button>
        </div>
        <div id="ttsStatus" style="
          text-align: center;
          color: rgba(255, 255, 255, 0.7);
          font-size: 11px;
          margin-top: 4px;
          min-height: 16px;
        ">待机中</div>
      </div>
      
      <div class="setting-item">
        <button class="setting-button" onclick="testThinking()">
          <i class="fas fa-play"></i> 测试思考动画
        </button>
        <button class="setting-button" onclick="resetAnimation()">
          <i class="fas fa-stop"></i> 重置动画
        </button>
      </div>
      
      <div class="setting-item">
        <button class="setting-button" onclick="toggleFacialAnalysis()">
          <i class="fas fa-camera"></i> <span id="facialBtn">停止分析</span>
        </button>
        <button class="setting-button" onclick="toggleVoiceAnalysis()">
          <i class="fas fa-microphone"></i> <span id="voiceBtn">停止录音</span>
        </button>
      </div>
      
      <!-- 新增ASR控制按钮 -->
      <div class="setting-item">
        <button class="setting-button" onclick="startSmartASR()">
          <i class="fas fa-comments"></i> <span id="asrBtn">开始智能识别</span>
        </button>
        <button class="setting-button" onclick="toggleASRResults()">
          <i class="fas fa-eye"></i> <span id="asrResultsBtn">显示转写</span>
        </button>
      </div>
      
      <!-- ASR转写结果显示区域 -->
      <div class="setting-item" style="border-top: 1px solid rgba(255, 255, 255, 0.2); margin-top: 15px; padding-top: 15px;">
        <div class="asr-results" id="asrResults" style="
          position: relative;
          bottom: auto;
          left: auto;
          width: auto;
          max-height: 200px;
          background: rgba(255, 255, 255, 0.05);
          backdrop-filter: none;
          border-radius: 8px;
          padding: 10px;
          border: 1px solid rgba(255, 255, 255, 0.1);
          z-index: auto;
          display: none;
          flex-direction: column;
          gap: 8px;
        ">
          <div class="asr-title" style="
            color: white;
            font-size: 14px;
            font-weight: 600;
            text-align: center;
            margin-bottom: 8px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            padding-bottom: 6px;
          ">
            <i class="fas fa-microphone"></i> 语音转写结果
          </div>
          <div class="asr-content" id="asrContent" style="
            flex: 1;
            overflow-y: auto;
            max-height: 150px;
          ">
            <div class="asr-status">等待语音输入...</div>
          </div>
        </div>
      </div>
      
      <div class="setting-item">
        <button class="setting-button" onclick="resetLive2D()">
          <i class="fas fa-redo"></i> 重置模型
        </button>
        <button class="setting-button" onclick="toggleDebugInfo()">
          <i class="fas fa-bug"></i> 调试信息
        </button>
      </div>
      
      <div class="setting-item">
        <button class="setting-button" onclick="exportSettings()">
          <i class="fas fa-download"></i> 导出设置
        </button>
      </div>
      

      
      <div class="debug-info" id="debugInfo" style="display: none;">
        Live2D状态: 正常
        动画状态: 空闲
        音频状态: 未初始化
        性能: 60 FPS
            </div>
            </div>
          </div>
          
  <!-- 黑洞转场效果 -->
  <div class="blackhole-transition" id="blackholeTransition">
    <div class="blackhole-circle"></div>
    <div class="blackhole-vortex"></div>
    <div class="blackhole-streams">
      <div class="particle"></div>
      <div class="particle"></div>
      <div class="particle"></div>
      <div class="particle"></div>
      <div class="particle"></div>
      <div class="particle"></div>
      <div class="particle"></div>
      <div class="particle"></div>
      <div class="particle"></div>
      <div class="particle"></div>
      <div class="particle"></div>
      <div class="particle"></div>
      <div class="particle"></div>
      <div class="particle"></div>
      <div class="particle"></div>
      <div class="particle"></div>
      <div class="particle"></div>
      <div class="particle"></div>
      <div class="particle"></div>
      <div class="particle"></div>
      <div class="particle"></div>
      <div class="particle"></div>
      <div class="particle"></div>
      <div class="particle"></div>
      <div class="particle"></div>
      <div class="particle"></div>
      <div class="particle"></div>
      <div class="particle"></div>
      <div class="particle"></div>
      <div class="particle"></div>
      <div class="particle"></div>
      <div class="particle"></div>
      <div class="particle"></div>
      <div class="particle"></div>
      <div class="particle"></div>
      <div class="particle"></div>
      <div class="particle"></div>
      <div class="particle"></div>
        </div>
      </div>
      
  <!-- Live2D 数字人 -->
  	<canvas id="live2d"></canvas>
  
  <!-- SocketIO CDN -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>
  
  <!-- importmap -->
  	<script type="importmap">
	{
  		"imports": {
    			"pixi.js": "https://cdn.jsdelivr.net/npm/pixi.js/dist/pixi.min.mjs",
    			"@pixi/sound": "https://cdn.jsdelivr.net/npm/@pixi/sound@6.0.1/dist/pixi-sound.mjs",
    			"easy-live2d": "https://cdn.jsdelivr.net/npm/easy-live2d/dist/index.js"
  		}
	}
	</script>
  
  <!-- Live2D Core -->
  <script src="/live2d/Core/live2dcubismcore.js"></script>
  
  <!-- 背景特效脚本 -->
  <script src="{{ url_for('static', filename='js/index.js') }}"></script>
  
  <!-- Live2D 和面试逻辑 -->
	<script type="module">
   		import { Application, Ticker } from 'pixi.js';
    		import { Live2DSprite, Config } from 'easy-live2d'

    		Config.MotionGroupIdle = 'Idle'; 
    		Config.MouseFollow = false;
    		const live2dSprite = new Live2DSprite();
    
    let app;
    let interviewActive = false;
    let currentQuestion = 0;
    const questions = [
      "请先自我介绍一下",
      "说说你最大的优势是什么？",
      "你为什么选择这个职位？",
      "描述一下你的职业规划",
      "你如何处理工作中的压力？"
    ];
    
    // 初始化Live2D
    async function initLive2D() {
      try {
        await live2dSprite.init({
          modelPath: '/live2d/assets/haru/haru_greeter_t05.model3.json',
      			ticker: Ticker.shared
    		});

			function resizeModel() {
            	const canvas = document.getElementById('live2d');

          console.log(window.devicePixelRatio);
          
          const screenWidth = window.innerWidth * window.devicePixelRatio / 1.5;
          const screenHeight = window.innerHeight * window.devicePixelRatio / 1.5;
				
            	canvas.width = screenWidth;
            	canvas.height = screenHeight;
            
            	live2dSprite.width = 3 * screenWidth;
				live2dSprite.height = 3 * screenHeight;
				live2dSprite.x = -0.75 * screenWidth;
          live2dSprite.y = -1.5 * screenHeight;
			}

			const canvas = document.getElementById('live2d');
        app = new Application();
      				await app.init({
        				view: document.getElementById('live2d'),
        				backgroundAlpha: 0, 
      				});
        
			window.addEventListener('resize', resizeModel);
			resizeModel();
      		app.stage.addChild(live2dSprite);
        
        console.log('Live2D模型加载成功');
        updateStatus('Live2D面试官已就绪');
        
        // 3秒后自动播放太空信息传输动画演示
        setTimeout(() => {
          showThinking();
        }, 3000);
        
      } catch (error) {
        console.error('Live2D模型加载失败:', error);
        updateStatus('模型加载失败，请刷新页面重试');
      }
    }
    
    function updateStatus(text) {
      console.log('状态更新:', text);
    }
    
    // 初始化页面
    document.addEventListener('DOMContentLoaded', function() {
      // 初始化背景特效
      new RocketCursorSystem();
      new ParticleSystem();
      new StarSystem();
      new MeteorSystem();
      
      // 初始化Live2D
      initLive2D();
      
      // 添加鼠标特效
      addMouseEffects();
      
      // 初始化设置
      updateDebugInfo();
      
      // 初始化ASR系统（会在连接成功后自动初始化TTS）
      initASRSystem();
      
      // 初始化面试系统
      setTimeout(() => {
        initInterviewSystem();
      }, 2000); // 延迟2秒确保其他系统初始化完成
      
      // 自动启动微表情分析（如果设置为开启）
      setTimeout(() => {
        if (systemSettings.facialAnalysis) {
          console.log('🎬 自动启动微表情肢体分析...');
          startFacialAnalysis();
        }
      }, 2000); // 延迟2秒启动，确保Live2D加载完成
      
      // 自动启动语调分析（如果设置为开启）
      setTimeout(() => {
        if (systemSettings.voiceAnalysis) {
          console.log('🎤 自动启动语调分析...');
          startVoiceAnalysis();
        }
      }, 3000); // 延迟3秒启动，确保微表情分析先启动
    });
    
    // 页面离开时自动停止分析
    window.addEventListener('beforeunload', function() {
      if (facialAnalysisRunning) {
        console.log('🛑 页面离开，自动停止微表情分析');
        // 发送同步请求停止分析
        navigator.sendBeacon('/api/interview/stop-facial-analysis', JSON.stringify({}));
        stopAnalysisStatusMonitoring();
      }
      
      if (voiceAnalysisRunning) {
        console.log('🛑 页面离开，自动停止语调分析');
        // 发送同步请求停止分析
        navigator.sendBeacon('/api/interview/stop-voice-analysis', JSON.stringify({}));
        stopVoiceStatusMonitoring();
      }
      
      // 停止ASR识别
      if (asrActive) {
        console.log('🛑 页面离开，自动停止ASR识别');
        stopASRRecognition();
      }
      
      // 停止TTS播放和清理资源
      if (ttsAudioPlayer && !ttsAudioPlayer.paused) {
        console.log('🛑 页面离开，自动停止TTS播放');
        ttsAudioPlayer.pause();
        
        // 停止数字人嘴部动画
        if (live2dSprite && live2dSprite.stopVoice) {
          try {
            live2dSprite.stopVoice();
          } catch (error) {
            console.warn('停止嘴部动画失败:', error);
          }
        }
        
        // 清理音频URL资源
        if (ttsAudioPlayer.src && ttsAudioPlayer.src.startsWith('blob:')) {
          URL.revokeObjectURL(ttsAudioPlayer.src);
        }
      }
    });
    
    // 页面隐藏时暂停分析
    document.addEventListener('visibilitychange', function() {
      if (document.hidden) {
        console.log('⏸️ 页面隐藏，暂停状态监控');
        stopAnalysisStatusMonitoring();
        stopVoiceStatusMonitoring();
      } else {
        console.log('▶️ 页面显示，恢复状态监控');
        if (facialAnalysisRunning) {
          startAnalysisStatusMonitoring();
        }
        if (voiceAnalysisRunning) {
          startVoiceStatusMonitoring();
        }
      }
    });
    
    // 添加鼠标特效
    function addMouseEffects() {
      const interactiveElements = document.querySelectorAll('.setting-button, .settings-toggle, .back-btn');
      
      interactiveElements.forEach(element => {
        element.addEventListener('mouseenter', function(event) {
          const wave = document.createElement('div');
          wave.className = 'rocket-wave';
          wave.style.left = event.clientX + 'px';
          wave.style.top = event.clientY + 'px';
          document.body.appendChild(wave);
          
          setTimeout(() => {
            if (document.body.contains(wave)) {
              document.body.removeChild(wave);
            }
          }, 2000);
        });
      });
    }
    
    // 返回主页
    window.goBack = function() {
      const blackhole = document.getElementById('blackholeTransition');
      blackhole.style.display = 'flex';
      blackhole.classList.add('active');
      
      setTimeout(() => {
        window.location.href = '/';
      }, 1000);
    }
    
    // AI思考动画相关功能
    let thinkingAnimationTimeout;
    
    function showThinking() {
      const thinkingDiv = document.getElementById('aiThinking');
      thinkingDiv.style.display = 'flex';
      
      // 重置所有状态
      resetThinkingAnimation();
      
      // 阶段1: 激活第一个图标，然后填充第一个进度条
      setTimeout(() => {
        activateThinkingIcon(1);
        setTimeout(() => {
          fillProgressBar(1);
        }, 100);
      }, 200);
      
      // 阶段2: 激活第二个图标，然后填充第二个进度条
      setTimeout(() => {
        activateThinkingIcon(2);
        setTimeout(() => {
          fillProgressBar(2);
        }, 100);
      }, 1200);
      
      // 阶段3: 激活第三个图标
      setTimeout(() => {
        activateThinkingIcon(3);
      }, 2200);
      
      // 3秒后隐藏
      thinkingAnimationTimeout = setTimeout(() => {
        hideThinking();
      }, 3000);
    }
    
    function hideThinking() {
      const thinkingDiv = document.getElementById('aiThinking');
      thinkingDiv.style.display = 'none';
      resetThinkingAnimation();
    }
    
    // 重置动画
    function resetThinkingAnimation() {
      const progressFills = document.querySelectorAll('.progress-fill1, .progress-fill2');
      progressFills.forEach(fill => {
        fill.style.width = '0%';
        fill.classList.remove('animate');
      });
      
      const icons = document.querySelectorAll('.thinking-icon');
      icons.forEach(icon => {
        icon.classList.remove('active');
      });
    }
    
    // 激活图标
    function activateThinkingIcon(iconNumber) {
      const icon = document.getElementById(`thinkingIcon${iconNumber}`);
      if (icon) {
        icon.classList.add('active');
        console.log(`激活图标 ${iconNumber}: ${getIconName(iconNumber)}`);
      }
    }
    
    // 填充进度条
    function fillProgressBar(progressNumber) {
      const progressFill = document.getElementById(`progressFill${progressNumber}`);
      if (progressFill) {
        console.log(`开始填充进度条 ${progressNumber}`);
        
        // 确保只增加宽度，为每个进度条分别添加动画
        if (progressNumber === 1) {
          progressFill.classList.add('animate');  // 开启动画
          progressFill.style.width = '100%';
        } 
		else if (progressNumber === 2) {
          progressFill.classList.add('animate');  // 开启动画
          progressFill.style.width = '100%';
        }
        
        console.log(`进度条 ${progressNumber} 开始动画到 100%`);
      }
    }
    
    function getIconName(step) {
      const names = ['信号发射', '卫星传输', '语音接收'];
      return names[step - 1] || '未知';
    }
    
    // 系统设置面板功能
    let settingsVisible = false;
    let systemSettings = {
      voice: false,
      voiceAnalysis: true, // 语调分析默认开启
      autoRecord: false,
      facialAnalysis: true, // 微表情识别默认开启
      mouseFollow: true,
      particles: true,
      asrRecognition: false, // 新增ASR语音识别设置
      ttsEnabled: false // 新增TTS语音合成设置
    };
    
    // 微表情分析相关变量
    let facialAnalysisRunning = false;
    let analysisStatusInterval = null;
    let currentAnalysisCount = 0;
    
    // 语调分析相关变量
    let voiceAnalysisRunning = false;
    let voiceStatusInterval = null;
    let isRecording = false;
    
    // 媒体流相关变量
    let videoStream = null;
    let audioStream = null;
    let mediaRecorder = null;
    let recordedChunks = [];
    
    // ==================== ASR相关变量和功能 ====================
    let asrSocket = null;
    let asrActive = false;
    let asrRecording = false;
    let asrAudioContext = null;
    let asrProcessor = null;
    let asrResultsVisible = false;
    
    // 初始化ASR系统
    function initASRSystem() {
      console.log('🎙️ 初始化ASR语音识别系统...');
      
      // 连接到ASR服务器（端口5000 - 集成到主服务器）
      try {
        asrSocket = io('http://localhost:5000');
        
        // ASR Socket事件处理
        asrSocket.on('connect', function() {
          console.log('✅ ASR服务器已连接');
          updateASRStatus('已连接', false);
          
          // 在ASR连接成功后初始化TTS系统
          initTTSSystem();
        });
        
        asrSocket.on('disconnect', function() {
          console.log('❌ ASR服务器断开连接');
          updateASRStatus('未连接', false);
          asrActive = false;
          asrRecording = false;
          updateASRButton();
        });
        
        asrSocket.on('asr_connected', function() {
          console.log('🧠 ASR智能语音识别已连接');
          updateASRStatus('识别就绪', false);
        });
        
        asrSocket.on('asr_smart_started', function(data) {
          console.log('🔴 智能录音已启动:', data.message);
          updateASRStatus('智能录音中', true);
          asrRecording = true;
          showASRResults();
          showNotification('🎙️ 智能语音识别已启动', 'success');
        });
        
        asrSocket.on('asr_disconnected', function() {
          console.log('⏹️ ASR语音识别已断开');
          updateASRStatus('已断开', false);
          asrActive = false;
          asrRecording = false;
          updateASRButton();
        });
        
        asrSocket.on('asr_auto_stopped', function() {
          console.log('🛑 智能录音已自动停止');
          updateASRStatus('自动停止', false);
          asrActive = false;
          asrRecording = false;
          updateASRButton();
          showNotification('🛑 智能识别已自动停止', 'info');
        });
        
        asrSocket.on('asr_result', function(data) {
          if (data.text) {
            console.log('📝 实时转写:', data.text);
            addASRResult(data.text, 'realtime');
          }
        });
        
        asrSocket.on('asr_final_result', function(data) {
          console.log('🎯 最终结果:', data);
          addASRResult(`最终结果 (${data.count}句话): ${data.full_text}`, 'final');
          
          // 如果有多个句子，显示分句详情
          if (data.sentences && data.sentences.length > 1) {
            data.sentences.forEach((sentence, index) => {
              addASRResult(`${index + 1}. ${sentence}`, 'sentence');
            });
          }
          
          // 面试系统：处理用户回答
          if (awaitingAnswer && data.full_text) {
            if (interviewState === InterviewState.REVERSE_QA_WAITING) {
              // 反问环节处理
              handleReverseUserQuestion(data.full_text);
            } else {
              // 普通面试回答处理
              handleInterviewAnswer(data.full_text);
            }
          }
          
          showNotification(`🎯 识别完成！共${data.count}句话`, 'success');
        });
        
        asrSocket.on('asr_error', function(data) {
          console.error('❌ ASR错误:', data.error);
          addASRResult(`错误: ${data.error}`, 'error');
          updateASRStatus('发生错误', false);
          showNotification('ASR识别发生错误', 'error');
        });
        
      } catch (error) {
        console.error('ASR连接失败:', error);
        updateASRStatus('连接失败', false);
      }
    }
    
    // 开始智能ASR识别
    async function startSmartASR() {
      if (asrActive) {
        stopASRRecognition();
        return;
      }
      
      try {
        console.log('🎙️ 启动智能ASR识别...');
        
        // 清空之前的结果
        clearASRResults();
        
        // 初始化录音
        await initASRRecording();
        
        // 发送开始智能识别命令
        asrSocket.emit('start_smart_asr');
        
        asrActive = true;
        updateASRButton();
        updateASRStatus('启动中...', false);
        
      } catch (error) {
        console.error('启动ASR失败:', error);
        showNotification('无法访问麦克风，请检查权限设置', 'error');
        updateASRStatus('启动失败', false);
      }
    }
    
    // 停止ASR识别
    function stopASRRecognition() {
      if (!asrActive) return;
      
      console.log('🛑 停止ASR识别...');
      
      asrActive = false;
      asrRecording = false;
      updateASRButton();
      updateASRStatus('停止中...', false);
      
      // 停止录音处理器
      if (asrProcessor) {
        asrProcessor.disconnect();
        asrProcessor = null;
      }
      
      if (asrAudioContext) {
        asrAudioContext.close();
        asrAudioContext = null;
      }
      
      // 发送停止命令
      if (asrSocket) {
        asrSocket.emit('stop_asr');
      }
      
      updateASRStatus('已停止', false);
      showNotification('🛑 ASR识别已停止', 'info');
    }
    
    // 初始化ASR录音
    async function initASRRecording() {
      const stream = await navigator.mediaDevices.getUserMedia({ 
        audio: {
          sampleRate: 16000,
          channelCount: 1,
          sampleSize: 16
        } 
      });
      
      asrAudioContext = new AudioContext({ sampleRate: 16000 });
      const source = asrAudioContext.createMediaStreamSource(stream);
      asrProcessor = asrAudioContext.createScriptProcessor(1024, 1, 1);
      
      asrProcessor.onaudioprocess = function(e) {
        if (asrActive && asrRecording) {
          const audioData = e.inputBuffer.getChannelData(0);
          // 转换为16位PCM
          const pcmData = new Int16Array(audioData.length);
          for (let i = 0; i < audioData.length; i++) {
            pcmData[i] = audioData[i] * 32767;
          }
          
          // 转换为base64并发送
          const audioBytes = new Uint8Array(pcmData.buffer);
          const base64Audio = btoa(String.fromCharCode.apply(null, audioBytes));
          asrSocket.emit('audio_data', { audio: base64Audio });
        }
      };
      
      source.connect(asrProcessor);
      asrProcessor.connect(asrAudioContext.destination);
      
      console.log('✅ ASR录音初始化完成');
    }
    
    // 更新ASR状态
    function updateASRStatus(status, isRecording) {
      const asrIndicator = document.getElementById('asrIndicator');
      const asrStatus = document.getElementById('asrStatus');
      const asrDot = document.getElementById('asrDot');
      
      if (asrIndicator && asrStatus && asrDot) {
        asrStatus.textContent = status;
        
        if (isRecording) {
          asrDot.classList.add('recording');
          asrIndicator.classList.add('show');
        } else {
          asrDot.classList.remove('recording');
          if (status === '未连接' || status === '连接失败') {
            asrIndicator.classList.remove('show');
          } else {
            asrIndicator.classList.add('show');
          }
        }
      }
    }
    
    // 更新ASR按钮
    function updateASRButton() {
      const asrBtn = document.getElementById('asrBtn');
      if (asrBtn) {
        asrBtn.textContent = asrActive ? '停止识别' : '开始智能识别';
      }
    }
    
    // 显示/隐藏ASR结果
    function toggleASRResults() {
      const asrResults = document.getElementById('asrResults');
      const asrResultsBtn = document.getElementById('asrResultsBtn');
      
      asrResultsVisible = !asrResultsVisible;
      
      if (asrResultsVisible) {
        asrResults.classList.add('show');
        asrResultsBtn.textContent = '隐藏转写';
      } else {
        asrResults.classList.remove('show');
        asrResultsBtn.textContent = '显示转写';
      }
    }
    
    // 显示ASR结果区域
    function showASRResults() {
      const asrResults = document.getElementById('asrResults');
      const asrResultsBtn = document.getElementById('asrResultsBtn');
      
      if (!asrResultsVisible) {
        asrResults.classList.add('show');
        asrResultsBtn.textContent = '隐藏转写';
        asrResultsVisible = true;
      }
    }
    
    // 添加ASR结果
    function addASRResult(text, type = 'realtime') {
      const asrContent = document.getElementById('asrContent');
      
      if (!asrContent) return;
      
      // 如果是第一次添加结果，清除等待消息
      const statusMsg = asrContent.querySelector('.asr-status');
      if (statusMsg && statusMsg.textContent === '等待语音输入...') {
        asrContent.innerHTML = '';
      }
      
      const resultDiv = document.createElement('div');
      
      switch (type) {
        case 'realtime':
          resultDiv.className = 'asr-text';
          resultDiv.textContent = text;
          break;
        case 'final':
          resultDiv.className = 'asr-final';
          resultDiv.textContent = text;
          break;
        case 'sentence':
          resultDiv.className = 'asr-sentence';
          resultDiv.textContent = text;
          break;
        case 'error':
          resultDiv.className = 'asr-text';
          resultDiv.style.color = '#f44336';
          resultDiv.textContent = text;
          break;
        default:
          resultDiv.className = 'asr-text';
          resultDiv.textContent = text;
      }
      
      asrContent.appendChild(resultDiv);
      asrContent.scrollTop = asrContent.scrollHeight;
    }
    
    // 清空ASR结果
    function clearASRResults() {
      const asrContent = document.getElementById('asrContent');
      if (asrContent) {
        asrContent.innerHTML = '<div class="asr-status">等待语音输入...</div>';
      }
    }
    
    // 全局ASR函数
    window.startSmartASR = startSmartASR;
    window.toggleASRResults = toggleASRResults;
    
    // ==================== 原有功能保持不变 ====================
    
    window.toggleSettings = function() {
      const panel = document.getElementById('settingsPanel');
      settingsVisible = !settingsVisible;
      
      if (settingsVisible) {
        panel.classList.add('show');
      } else {
        panel.classList.remove('show');
      }
    }
    
    window.toggleSetting = function(element, settingName) {
      const isActive = element.classList.contains('active');
      
      if (isActive) {
        element.classList.remove('active');
        systemSettings[settingName] = false;
      } else {
        element.classList.add('active');
        systemSettings[settingName] = true;
      }
      
      // 应用设置
      applySystemSetting(settingName, systemSettings[settingName]);
      updateDebugInfo();
    }
    
    // 微表情分析功能
    async function startFacialAnalysis() {
      if (facialAnalysisRunning) {
        console.log('微表情分析已在运行中');
        return;
      }
      
      try {
        console.log('🎬 启动微表情肢体分析...');
        
        // 请求摄像头权限
        await requestCameraPermission();
        
        const response = await fetch('/api/interview/start-facial-analysis', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          }
        });
        
        const data = await response.json();
        
        if (data.success) {
          facialAnalysisRunning = true;
          console.log('✅ 微表情分析已启动:', data.message);
          
          // 开始定期拍照分析
          startPeriodicPhotoCapture();
          
          // 开始定期检查状态
          startAnalysisStatusMonitoring();
          updateDebugInfo();
          updateFacialAnalysisButton();
          
          // 显示启动通知
          showNotification('📹 微表情肢体分析已启动', 'success');
        } else {
          console.error('❌ 启动失败:', data.message);
          showNotification('启动微表情分析失败: ' + data.message, 'error');
        }
      } catch (error) {
        console.error('微表情分析启动错误:', error);
        showNotification('摄像头访问失败，请检查权限设置', 'error');
      }
    }
    
    function startPeriodicPhotoCapture() {
      if (!videoStream || !facialAnalysisRunning) return;
      
      // 每10秒拍照一次
      const captureInterval = setInterval(async () => {
        if (!facialAnalysisRunning) {
          clearInterval(captureInterval);
          return;
        }
        
        try {
          // 创建canvas来捕获视频帧
          const canvas = document.createElement('canvas');
          const video = document.createElement('video');
          video.srcObject = videoStream;
          video.play();
          
          video.onloadedmetadata = () => {
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            
            const ctx = canvas.getContext('2d');
            ctx.drawImage(video, 0, 0);
            
            // 转换为blob并发送到后端
            canvas.toBlob(async (blob) => {
              const formData = new FormData();
              formData.append('image', blob, 'capture.jpg');
              
              try {
                const response = await fetch('/api/interview/analyze-photo', {
                  method: 'POST',
                  body: formData
                });
                
                const result = await response.json();
                if (result.success) {
                  currentAnalysisCount++;
                  console.log(`📊 第${currentAnalysisCount}次分析完成:`, result.analysis);
                  updateDebugInfo();
                }
              } catch (error) {
                console.error('照片分析失败:', error);
              }
            }, 'image/jpeg', 0.8);
          };
        } catch (error) {
          console.error('拍照失败:', error);
        }
      }, 10000); // 10秒间隔
    }
    
    async function stopFacialAnalysis() {
      if (!facialAnalysisRunning) {
        console.log('微表情分析未在运行');
        return;
      }
      
      try {
        console.log('🛑 停止微表情肢体分析...');
        
        const response = await fetch('/api/interview/stop-facial-analysis', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          }
        });
        
        const data = await response.json();
        
        if (data.success) {
          facialAnalysisRunning = false;
          stopAnalysisStatusMonitoring();
          
          // 停止摄像头流
          if (videoStream) {
            videoStream.getTracks().forEach(track => track.stop());
            videoStream = null;
          }
          
          console.log('✅ 微表情分析已停止:', data.message);
          console.log('📊 分析总结:', data.summary);
          
          updateDebugInfo();
          updateFacialAnalysisButton();
          
          // 显示停止通知和结果摘要
          if (data.summary) {
            const avgScore = data.summary.overall_score || 0;
            showNotification(`📹 分析完成！综合得分: ${avgScore}/10`, 'success');
          } else {
            showNotification('📹 微表情分析已停止', 'success');
          }
        } else {
          console.error('❌ 停止失败:', data.message);
          showNotification('停止分析失败: ' + data.message, 'error');
        }
      } catch (error) {
        console.error('停止微表情分析错误:', error);
        showNotification('停止分析时发生错误', 'error');
      }
    }
    
    async function requestCameraPermission() {
      try {
        videoStream = await navigator.mediaDevices.getUserMedia({ 
          video: { width: 640, height: 480 },
          audio: false 
        });
        
        console.log('✅ 摄像头权限已获取，视频流已启动');
        return true;
      } catch (error) {
        console.error('❌ 摄像头权限获取失败:', error);
        throw new Error('无法访问摄像头，请检查浏览器权限设置');
      }
    }
    
    function startAnalysisStatusMonitoring() {
      // 每5秒检查一次分析状态
      analysisStatusInterval = setInterval(async () => {
        try {
          const response = await fetch('/api/interview/facial-analysis-status');
          const data = await response.json();
          
          if (data.success) {
            facialAnalysisRunning = data.is_running;
            currentAnalysisCount = data.analysis_count;
            
            // 如果分析意外停止，更新状态
            if (!data.is_running && facialAnalysisRunning) {
              facialAnalysisRunning = false;
              stopAnalysisStatusMonitoring();
              showNotification('微表情分析已自动停止', 'info');
            }
            
            updateDebugInfo();
          }
        } catch (error) {
          console.error('状态监控错误:', error);
        }
      }, 5000);
    }
    
    function stopAnalysisStatusMonitoring() {
      if (analysisStatusInterval) {
        clearInterval(analysisStatusInterval);
        analysisStatusInterval = null;
      }
    }
    
    // 语调分析功能
    async function startVoiceAnalysis() {
      if (voiceAnalysisRunning) {
        console.log('语调分析已在运行中');
        return;
      }
      
      try {
        console.log('🎤 启动语调分析...');
        
        // 请求麦克风权限
        await requestMicrophonePermission();
        
        const response = await fetch('/api/interview/start-voice-analysis', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          }
        });
        
        const data = await response.json();
        
        if (data.success) {
          voiceAnalysisRunning = true;
          console.log('✅ 语调分析已启动:', data.message);
          
          // 开始浏览器端录音
          startBrowserRecording();
          
          // 开始定期检查状态
          startVoiceStatusMonitoring();
          updateDebugInfo();
          updateVoiceAnalysisButton();
          
          // 显示启动通知
          showNotification('🎤 语调分析已启动', 'success');
        } else {
          console.error('❌ 启动失败:', data.message);
          showNotification('启动语调分析失败: ' + data.message, 'error');
        }
      } catch (error) {
        console.error('语调分析启动错误:', error);
        showNotification('麦克风访问失败，请检查权限设置', 'error');
      }
    }
    
    function startBrowserRecording() {
      if (!audioStream || !voiceAnalysisRunning) return;
      
      try {
        recordedChunks = [];
        
        // 使用MediaRecorder录音
        mediaRecorder = new MediaRecorder(audioStream, {
          mimeType: 'audio/webm;codecs=opus'
        });
        
        mediaRecorder.ondataavailable = (event) => {
          if (event.data.size > 0) {
            recordedChunks.push(event.data);
          }
        };
        
        mediaRecorder.onstop = async () => {
          // 录音结束，发送到后端分析
          if (recordedChunks.length > 0) {
            const audioBlob = new Blob(recordedChunks, { type: 'audio/webm' });
            await sendAudioForAnalysis(audioBlob);
          }
        };
        
        // 开始录音
        mediaRecorder.start(1000); // 每秒保存一次数据
        isRecording = true;
        console.log('🎤 浏览器录音已开始');
        
      } catch (error) {
        console.error('录音启动失败:', error);
        showNotification('录音启动失败', 'error');
      }
    }
    
    async function sendAudioForAnalysis(audioBlob) {
      try {
        const formData = new FormData();
        formData.append('audio', audioBlob, 'recording.webm');
        
        console.log('📤 发送音频数据进行分析...');
        
        const response = await fetch('/api/interview/analyze-audio', {
          method: 'POST',
          body: formData
        });
        
        const result = await response.json();
        if (result.success) {
          console.log('🎵 语调分析完成:', result.analysis);
          
          // 显示分析结果通知
          if (result.analysis && result.analysis.analysis_info) {
            const overallScore = result.analysis.analysis_info.overall_score || 0;
            showNotification(`🎤 语调分析完成！综合得分: ${overallScore.toFixed(2)}/1.0`, 'success');
          } else {
            showNotification('🎤 语调分析完成，结果已保存', 'success');
          }
          
          // 更新调试信息
          updateDebugInfo();
          
        } else {
          console.error('❌ 分析失败:', result.message);
          showNotification('语调分析失败: ' + result.message, 'error');
        }
      } catch (error) {
        console.error('音频分析失败:', error);
        showNotification('音频分析时发生错误', 'error');
      }
    }
    
    async function stopVoiceAnalysis() {
      if (!voiceAnalysisRunning) {
        console.log('语调分析未在运行');
        return;
      }
      
      try {
        console.log('🛑 停止语调分析...');
        
        // 停止录音
        if (mediaRecorder && mediaRecorder.state !== 'inactive') {
          mediaRecorder.stop();
          // 等待录音数据处理完成
          await new Promise(resolve => {
            mediaRecorder.onstop = async () => {
              if (recordedChunks.length > 0) {
                const audioBlob = new Blob(recordedChunks, { type: 'audio/webm' });
                console.log('🎵 开始分析录音数据...');
                await sendAudioForAnalysis(audioBlob);
              }
              resolve();
            };
          });
        }
        
        // 停止麦克风流
        if (audioStream) {
          audioStream.getTracks().forEach(track => track.stop());
          audioStream = null;
        }
        
        voiceAnalysisRunning = false;
        isRecording = false;
        stopVoiceStatusMonitoring();
        
        // 通知后端停止状态监控
        const response = await fetch('/api/interview/stop-voice-analysis', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ browser_mode: true })
        });
        
        const data = await response.json();
        
        console.log('✅ 语调分析已停止');
        updateDebugInfo();
        updateVoiceAnalysisButton();
        
        // 显示停止通知
        showNotification('🎤 语调分析已停止，正在处理数据...', 'success');
        
      } catch (error) {
        console.error('停止语调分析错误:', error);
        showNotification('停止分析时发生错误', 'error');
      }
    }
    
    async function requestMicrophonePermission() {
      try {
        audioStream = await navigator.mediaDevices.getUserMedia({ 
          audio: { 
            sampleRate: 44100,
            channelCount: 1,
            echoCancellation: true,
            noiseSuppression: true 
          }
        });
        
        console.log('✅ 麦克风权限已获取，音频流已启动');
        return true;
      } catch (error) {
        console.error('❌ 麦克风权限获取失败:', error);
        throw new Error('无法访问麦克风，请检查浏览器权限设置');
      }
    }
    
    function startVoiceStatusMonitoring() {
      // 每5秒检查一次分析状态
      voiceStatusInterval = setInterval(async () => {
        try {
          const response = await fetch('/api/interview/voice-analysis-status');
          const data = await response.json();
          
          if (data.success) {
            voiceAnalysisRunning = data.is_running;
            isRecording = data.is_recording;
            
            // 如果分析意外停止，更新状态
            if (!data.is_running && voiceAnalysisRunning) {
              voiceAnalysisRunning = false;
              isRecording = false;
              stopVoiceStatusMonitoring();
              showNotification('语调分析已自动停止', 'info');
            }
            
            updateDebugInfo();
          }
        } catch (error) {
          console.error('语调状态监控错误:', error);
        }
      }, 5000);
    }
    
    function stopVoiceStatusMonitoring() {
      if (voiceStatusInterval) {
        clearInterval(voiceStatusInterval);
        voiceStatusInterval = null;
      }
    }
    
    function showNotification(message, type = 'info') {
      // 创建通知元素
      const notification = document.createElement('div');
      notification.className = `notification ${type}`;
      notification.style.cssText = `
        position: fixed;
        top: 80px;
        right: 20px;
        background: ${type === 'success' ? 'rgba(76, 175, 80, 0.9)' : 
                     type === 'error' ? 'rgba(244, 67, 54, 0.9)' : 
                     'rgba(33, 150, 243, 0.9)'};
        color: white;
        padding: 12px 20px;
        border-radius: 8px;
        z-index: 1001;
        backdrop-filter: blur(10px);
        box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        animation: slideIn 0.3s ease;
        max-width: 300px;
        word-wrap: break-word;
      `;
      notification.textContent = message;
      
      // 添加到页面
      document.body.appendChild(notification);
      
      // 3秒后自动移除
      setTimeout(() => {
        if (document.body.contains(notification)) {
          notification.style.animation = 'slideOut 0.3s ease';
          setTimeout(() => {
            if (document.body.contains(notification)) {
              document.body.removeChild(notification);
            }
          }, 300);
        }
      }, 3000);
    }
    
    function applySystemSetting(settingName, value) {
      switch (settingName) {
        case 'mouseFollow':
          if (window.Config && live2dSprite) {
            window.Config.MouseFollow = value;
          }
          break;
        case 'particles':
          const particlesCanvas = document.getElementById('particles-canvas');
          if (particlesCanvas) {
            particlesCanvas.style.display = value ? 'block' : 'none';
          }
          break;
        case 'voice':
          console.log('语音播放:', value ? '开启' : '关闭');
          break;
        case 'voiceAnalysis':
          console.log('语调分析:', value ? '开启' : '关闭');
          if (value && !voiceAnalysisRunning) {
            // 如果开启且未运行，则启动
            startVoiceAnalysis();
          } else if (!value && voiceAnalysisRunning) {
            // 如果关闭且正在运行，则停止
            stopVoiceAnalysis();
          }
          break;
        case 'autoRecord':
          console.log('自动录音:', value ? '开启' : '关闭');
          break;
        case 'facialAnalysis':
          console.log('微表情识别:', value ? '开启' : '关闭');
          if (value && !facialAnalysisRunning) {
            // 如果开启且未运行，则启动
            startFacialAnalysis();
          } else if (!value && facialAnalysisRunning) {
            // 如果关闭且正在运行，则停止
            stopFacialAnalysis();
          }
          break;
        case 'asrRecognition':
          console.log('ASR语音识别:', value ? '开启' : '关闭');
          if (value && !asrActive) {
            // 如果开启且未运行，则启动
            startSmartASR();
          } else if (!value && asrActive) {
            // 如果关闭且正在运行，则停止
            stopASRRecognition();
          }
          break;
        case 'ttsEnabled':
          console.log('TTS语音合成:', value ? '开启' : '关闭');
          if (value && !ttsEnabled) {
            // 如果开启且未运行，则启动
            startTTS();
          } else if (!value && ttsEnabled) {
            // 如果关闭且正在运行，则停止
            stopTTS();
          }
          break;
      }
    }
    
    window.testThinking = function() {
      showThinking();
    }
    
    window.resetAnimation = function() {
      // 清除现有的超时
      if (thinkingAnimationTimeout) {
        clearTimeout(thinkingAnimationTimeout);
      }
      
      // 隐藏动画并重置
      hideThinking();
      console.log('太空信息传输动画已重置');
    }
    
    window.toggleFacialAnalysis = function() {
      const facialBtn = document.getElementById('facialBtn');
      
      if (facialAnalysisRunning) {
        stopFacialAnalysis();
        facialBtn.textContent = '开始分析';
      } else {
        startFacialAnalysis();
        facialBtn.textContent = '停止分析';
      }
    }
    
    window.toggleVoiceAnalysis = function() {
      const voiceBtn = document.getElementById('voiceBtn');
      
      if (voiceAnalysisRunning) {
        stopVoiceAnalysis();
        voiceBtn.textContent = '开始录音';
      } else {
        startVoiceAnalysis();
        voiceBtn.textContent = '停止录音';
      }
    }
    
    // 更新按钮文本的函数
    function updateFacialAnalysisButton() {
      const facialBtn = document.getElementById('facialBtn');
      if (facialBtn) {
        facialBtn.textContent = facialAnalysisRunning ? '停止分析' : '开始分析';
      }
    }
    
    function updateVoiceAnalysisButton() {
      const voiceBtn = document.getElementById('voiceBtn');
      if (voiceBtn) {
        voiceBtn.textContent = voiceAnalysisRunning ? '停止录音' : '开始录音';
      }
    }
    
    window.resetLive2D = function() {
      if (live2dSprite && app) {
        // 重置Live2D模型位置
        const canvas = document.getElementById('live2d');
        const screenWidth = window.innerWidth * window.devicePixelRatio / 1.5;
        const screenHeight = window.innerHeight * window.devicePixelRatio / 1.5;
        
        live2dSprite.width = 3 * screenWidth;
        live2dSprite.height = 3 * screenHeight;
        live2dSprite.x = -0.75 * screenWidth;
        live2dSprite.y = -1.5 * screenHeight;
        
        updateDebugInfo();
        console.log('Live2D模型已重置');
      }
    }
    
    window.toggleDebugInfo = function() {
      const debugInfo = document.getElementById('debugInfo');
      const isVisible = debugInfo.style.display !== 'none';
      
      if (isVisible) {
        debugInfo.style.display = 'none';
      } else {
        debugInfo.style.display = 'block';
        updateDebugInfo();
      }
    }
    
    function updateDebugInfo() {
      const debugInfo = document.getElementById('debugInfo');
      const timestamp = new Date().toLocaleTimeString();
      
      let info = `更新时间: ${timestamp}\n`;
      info += `Live2D状态: ${live2dSprite ? '正常' : '未加载'}\n`;
      info += `动画状态: 太空信息传输\n`;
      info += `音频状态: ${systemSettings.voice ? '已启用' : '未启用'}\n`;
      info += `鼠标跟随: ${systemSettings.mouseFollow ? '开启' : '关闭'}\n`;
      info += `粒子特效: ${systemSettings.particles ? '开启' : '关闭'}\n`;
      info += `微表情识别: ${systemSettings.facialAnalysis ? '开启' : '关闭'}\n`;
      info += `分析状态: ${facialAnalysisRunning ? '运行中' : '已停止'}\n`;
      info += `分析次数: ${currentAnalysisCount}\n`;
      info += `语调分析: ${systemSettings.voiceAnalysis ? '开启' : '关闭'}\n`;
      info += `录音状态: ${voiceAnalysisRunning ? (isRecording ? '录音中' : '准备中') : '已停止'}\n`;
      info += `ASR识别: ${systemSettings.asrRecognition ? '开启' : '关闭'}\n`;
      info += `ASR状态: ${asrActive ? (asrRecording ? '录音识别中' : '准备中') : '已停止'}\n`;
      info += `ASR连接: ${asrSocket && asrSocket.connected ? '已连接' : '未连接'}\n`;
      info += `TTS合成: ${systemSettings.ttsEnabled ? '开启' : '关闭'}\n`;
      info += `TTS状态: ${ttsActive ? '合成中' : (ttsAudioPlayer && !ttsAudioPlayer.paused ? '播放中' : '已停止')}\n`;
      info += `屏幕尺寸: ${window.innerWidth}x${window.innerHeight}\n`;
      info += `设备像素比: ${window.devicePixelRatio}\n`;
      info += `传输动画: 信号→卫星→语音`;
      
      debugInfo.textContent = info;
    }
    
    window.exportSettings = function() {
      const settings = {
        systemSettings: systemSettings,
        timestamp: new Date().toISOString(),
        userAgent: navigator.userAgent,
        screenSize: {
          width: window.innerWidth,
          height: window.innerHeight,
          devicePixelRatio: window.devicePixelRatio
        },
        asrStatus: {
          active: asrActive,
          recording: asrRecording,
          connected: asrSocket && asrSocket.connected
        },
        ttsStatus: {
          enabled: ttsEnabled,
          active: ttsActive,
          playing: ttsAudioPlayer && !ttsAudioPlayer.paused,
          currentSession: currentTTSSession
        }
      };
      
      const dataStr = JSON.stringify(settings, null, 2);
      const dataBlob = new Blob([dataStr], {type: 'application/json'});
      const url = URL.createObjectURL(dataBlob);
      
      const link = document.createElement('a');
      link.href = url;
      link.download = 'live2d_settings.json';
      link.click();
      
      URL.revokeObjectURL(url);
      console.log('设置已导出');
    }
    
    // 点击外部关闭设置面板
    document.addEventListener('click', function(event) {
      const settingsPanel = document.getElementById('settingsPanel');
      const settingsToggle = document.querySelector('.settings-toggle');
      
      if (settingsVisible && 
          !settingsPanel.contains(event.target) && 
          !settingsToggle.contains(event.target)) {
        toggleSettings();
      }
    });
    
    // ==================== TTS相关变量和功能 ====================
    let ttsEnabled = false;
    let ttsActive = false;
    let ttsAudioChunks = [];
    let currentTTSSession = null;
    let ttsAudioPlayer = null;
    let ttsWAVFile = null;
    
    // WAV文件头生成工具
    function createWAVHeader(dataLength, sampleRate = 24000, channels = 1, bitsPerSample = 16) {
      const buffer = new ArrayBuffer(44);
      const view = new DataView(buffer);
      
      // RIFF chunk descriptor
      view.setUint32(0, 0x52494646, false); // "RIFF"
      view.setUint32(4, 36 + dataLength, true); // File size - 8
      view.setUint32(8, 0x57415645, false); // "WAVE"
      
      // fmt sub-chunk
      view.setUint32(12, 0x666d7420, false); // "fmt "
      view.setUint32(16, 16, true); // Subchunk1Size (16 for PCM)
      view.setUint16(20, 1, true); // AudioFormat (1 for PCM)
      view.setUint16(22, channels, true); // NumChannels
      view.setUint32(24, sampleRate, true); // SampleRate
      view.setUint32(28, sampleRate * channels * bitsPerSample / 8, true); // ByteRate
      view.setUint16(32, channels * bitsPerSample / 8, true); // BlockAlign
      view.setUint16(34, bitsPerSample, true); // BitsPerSample
      
      // data sub-chunk
      view.setUint32(36, 0x64617461, false); // "data"
      view.setUint32(40, dataLength, true); // Subchunk2Size
      
      return new Uint8Array(buffer);
    }
    
    function createWAVFile(pcmData) {
      const wavHeader = createWAVHeader(pcmData.length);
      const wavFile = new Uint8Array(wavHeader.length + pcmData.length);
      wavFile.set(wavHeader, 0);
      wavFile.set(pcmData, wavHeader.length);
      return wavFile;
    }
    
    // 初始化TTS系统
    function initTTSSystem() {
      console.log('🎤 初始化TTS语音合成系统...');
      
      // 确保使用已存在的asrSocket连接
      if (!asrSocket) {
        console.error('❌ ASR Socket未初始化，无法使用TTS功能');
        return;
      }
      
      // TTS Socket事件处理
      asrSocket.on('tts_synthesis_started', (data) => {
        console.log('🎵 TTS合成已启动:', data.session_id);
        currentTTSSession = data.session_id;
        ttsAudioChunks = [];
        ttsActive = true;
        updateTTSStatus('合成中...', false);
        updateTTSButtons();
        showNotification('🎵 开始语音合成...', 'info');
      });
      
      asrSocket.on('tts_audio_chunk', (data) => {
        if (data.session_id === currentTTSSession) {
          ttsAudioChunks.push(data);
          console.log(`🎵 收到TTS音频块 #${data.chunk_number}`);
          updateTTSStatus(`合成中... (${data.chunk_number}块)`, false);
        }
      });
      
      asrSocket.on('tts_synthesis_complete', (data) => {
        if (data.session_id === currentTTSSession) {
          console.log('🎵 TTS合成完成，共', data.total_chunks, '个音频块');
          ttsActive = false;
          updateTTSStatus('合成完成', false);
          updateTTSButtons();
          
          // 生成WAV文件并播放
          if (ttsAudioChunks.length > 0) {
            generateAndPlayTTSAudio();
          }
          
          showNotification(`🎵 语音合成完成！共${data.total_chunks}个音频块`, 'success');
        }
      });
      
      asrSocket.on('tts_synthesis_error', (data) => {
        console.error('❌ TTS合成错误:', data.error);
        ttsActive = false;
        updateTTSStatus('合成失败', false);
        updateTTSButtons();
        showNotification('TTS合成失败: ' + data.error, 'error');
        
        // 🧠 合成失败时隐藏思考动画
        hideThinking();
        console.log('🧠 隐藏思考动画 - TTS合成失败');
      });
      
      console.log('✅ TTS系统初始化完成，复用ASR Socket连接');
    }
    
    // 生成并播放TTS音频
    function generateAndPlayTTSAudio() {
      try {
        console.log('🎵 开始生成WAV音频文件...');
        
        // 合并所有PCM音频块
        const allPCMData = ttsAudioChunks.map(chunk => {
          const binaryString = atob(chunk.audio_data);
          const bytes = new Uint8Array(binaryString.length);
          for (let i = 0; i < binaryString.length; i++) {
            bytes[i] = binaryString.charCodeAt(i);
          }
          return bytes;
        });
        
        // 计算总长度并合并PCM数据
        const totalLength = allPCMData.reduce((sum, arr) => sum + arr.length, 0);
        const mergedPCM = new Uint8Array(totalLength);
        
        let offset = 0;
        for (const data of allPCMData) {
          mergedPCM.set(data, offset);
          offset += data.length;
        }
        
        // 创建WAV文件
        ttsWAVFile = createWAVFile(mergedPCM);
        const wavBlob = new Blob([ttsWAVFile], { type: 'audio/wav' });
        const url = URL.createObjectURL(wavBlob);
        
        // 创建或更新音频播放器
        if (!ttsAudioPlayer) {
          ttsAudioPlayer = new Audio();
          ttsAudioPlayer.onerror = () => {
            updateTTSStatus('播放失败', false);
            showNotification('音频播放失败', 'error');
            
            // 播放失败时也要清理资源
            if (ttsAudioPlayer.src && ttsAudioPlayer.src.startsWith('blob:')) {
              URL.revokeObjectURL(ttsAudioPlayer.src);
            }
          };
        }
        
        // 设置音频源但不播放HTML Audio
        ttsAudioPlayer.src = url;
        
        // 只使用Live2D的语音播放功能，避免重复播放
        if (live2dSprite && live2dSprite.playVoice) {
          try {
            // 🧠 隐藏思考动画 - 开始播放语音时
            hideThinking();
            console.log('🧠 隐藏思考动画 - 开始播放合成语音');
            
            // 计算音频时长（估算）
            const audioContext = new AudioContext();
            fetch(url)
              .then(response => response.arrayBuffer())
              .then(data => audioContext.decodeAudioData(data))
              .then(audioBuffer => {
                const duration = audioBuffer.duration * 1000; // 转换为毫秒
                console.log(`🎵 音频时长: ${(duration/1000).toFixed(2)}秒`);
                
                // 设置定时器监听播放完成
                setTimeout(() => {
                  updateTTSStatus('播放完成', false);
                  updateTTSButtons();
                  
                  console.log('🎭 数字人语音播放已完成');
                  
                  // 📡 触发思考动画 - 语音播放完成时
                  console.log('🧠 触发思考动画 - 语音播放完成，AI准备回应');
                  setTimeout(() => {
                    showThinking();
                  }, 500); // 延迟500ms后播放思考动画，让用户感受到自然的停顿
                  
                  // 🎯 面试系统回调 - 音频播放完成
                  if (window.interviewTTSCallback && typeof window.interviewTTSCallback === 'function') {
                    console.log('🎯 调用面试系统TTS完成回调');
                    window.interviewTTSCallback();
                  }
                  
                  // 清理音频URL资源
                  if (ttsAudioPlayer.src && ttsAudioPlayer.src.startsWith('blob:')) {
                    URL.revokeObjectURL(ttsAudioPlayer.src);
                  }
                }, duration + 100); // 添加100ms缓冲时间
              })
              .catch(error => {
                console.warn('无法获取音频时长，使用默认监听方式:', error);
                
                // 备用方案：使用Audio元素监听
                const tempAudio = new Audio(url);
                tempAudio.addEventListener('loadedmetadata', () => {
                  const duration = tempAudio.duration * 1000;
                  console.log(`🎵 音频时长（备用）: ${(duration/1000).toFixed(2)}秒`);
                  
                  setTimeout(() => {
                    updateTTSStatus('播放完成', false);
                    updateTTSButtons();
                    
                    console.log('🎭 数字人语音播放已完成');
                    
                    // 📡 触发思考动画 - 语音播放完成时
                    console.log('🧠 触发思考动画 - 语音播放完成，AI准备回应');
                    setTimeout(() => {
                      showThinking();
                    }, 500);
                    
                    // 🎯 面试系统回调 - 音频播放完成（备用）
                    if (window.interviewTTSCallback && typeof window.interviewTTSCallback === 'function') {
                      console.log('🎯 调用面试系统TTS完成回调（备用）');
                      window.interviewTTSCallback();
                    }
                    
                    // 清理音频URL资源
                    if (ttsAudioPlayer.src && ttsAudioPlayer.src.startsWith('blob:')) {
                      URL.revokeObjectURL(ttsAudioPlayer.src);
                    }
                  }, duration + 100);
                });
              });
            
            // 只使用Live2D播放语音（包含嘴部同步）
            live2dSprite.playVoice({
              voicePath: url,
              immediate: true
            });
            
            console.log('🎵 TTS音频开始播放（Live2D）');
            console.log('🎭 数字人嘴部动画已绑定到TTS音频');
            updateTTSStatus('播放中...', true);
            updateTTSButtons();
            showNotification('🎵 开始播放语音', 'success');
            
          } catch (error) {
            console.error('Live2D语音播放失败:', error);
            updateTTSStatus('播放失败', false);
            showNotification('语音播放失败', 'error');
            
            // Live2D播放失败时隐藏思考动画
            hideThinking();
          }
        } else {
          console.warn('🎭 Live2D模型未加载，使用HTML Audio播放');
          
          // 如果Live2D不可用，才使用HTML Audio播放
          ttsAudioPlayer.onended = () => {
            updateTTSStatus('播放完成', false);
            updateTTSButtons();
            
            // 📡 触发思考动画 - 语音播放完成时
            console.log('🧠 触发思考动画 - 语音播放完成，AI准备回应');
            setTimeout(() => {
              showThinking();
            }, 500);
            
            // 🎯 面试系统回调 - 音频播放完成（HTML Audio模式）
            if (window.interviewTTSCallback && typeof window.interviewTTSCallback === 'function') {
              console.log('🎯 调用面试系统TTS完成回调（HTML Audio模式）');
              window.interviewTTSCallback();
            }
            
            // 清理音频URL资源
            if (ttsAudioPlayer.src && ttsAudioPlayer.src.startsWith('blob:')) {
              URL.revokeObjectURL(ttsAudioPlayer.src);
            }
          };
          
          ttsAudioPlayer.play().then(() => {
            console.log('🎵 TTS音频开始播放（HTML Audio备用）');
            updateTTSStatus('播放中...', true);
            updateTTSButtons();
            showNotification('🎵 开始播放语音', 'success');
            
            // 🧠 隐藏思考动画 - 开始播放语音时
            hideThinking();
            console.log('🧠 隐藏思考动画 - 开始播放合成语音');
          }).catch((error) => {
            console.error('播放失败:', error);
            updateTTSStatus('播放失败', false);
            showNotification('音频播放失败，请检查浏览器设置', 'error');
            
            // 播放失败时也隐藏思考动画
            hideThinking();
          });
        }
        
        console.log(`✅ WAV文件已生成 (${(ttsWAVFile.length / 1024).toFixed(1)} KB)`);
        
      } catch (error) {
        console.error('生成WAV文件失败:', error);
        updateTTSStatus('生成失败', false);
        showNotification('音频生成失败', 'error');
      }
    }
    
    // 开始TTS合成
    function startTTSSynthesis() {
      const text = document.getElementById('ttsTextArea').value.trim();
      
      if (!text) {
        showNotification('请输入要合成的文本', 'error');
        return;
      }
      
      if (ttsActive) {
        showNotification('正在合成中，请稍候', 'error');
        return;
      }
      
      console.log('🎵 开始TTS合成:', text);
      ttsActive = true;
      updateTTSButtons();
      updateTTSStatus('准备合成...', false);
      
      // 📡 触发思考动画 - 语音合成开始时
      console.log('🧠 触发思考动画 - 开始语音合成处理');
      showThinking();
      
      // 发送TTS合成请求
      asrSocket.emit('tts_synthesize', { text: text });
    }
    
    // 停止TTS播放
    function stopTTSPlayback() {
      if (ttsAudioPlayer && !ttsAudioPlayer.paused) {
        ttsAudioPlayer.pause();
        ttsAudioPlayer.currentTime = 0;
        updateTTSStatus('已停止', false);
        updateTTSButtons();
        showNotification('🛑 语音播放已停止', 'info');
        
        // 🧠 手动停止播放时隐藏思考动画
        hideThinking();
        console.log('🧠 隐藏思考动画 - 手动停止TTS播放');
        
        // 停止Live2D语音播放和嘴部动画
        if (live2dSprite && live2dSprite.stopVoice) {
          try {
            live2dSprite.stopVoice();
            console.log('🎭 Live2D语音播放和嘴部动画已停止（功能关闭）');
          } catch (error) {
            console.warn('🎭 停止Live2D语音播放失败:', error);
          }
        }
        
        // 清理音频URL资源
        if (ttsAudioPlayer.src && ttsAudioPlayer.src.startsWith('blob:')) {
          URL.revokeObjectURL(ttsAudioPlayer.src);
        }
      }
    }
    
    // 更新TTS状态
    function updateTTSStatus(status, isPlaying) {
      const ttsStatus = document.getElementById('ttsStatus');
      if (ttsStatus) {
        ttsStatus.textContent = status;
        
        if (isPlaying) {
          ttsStatus.style.color = '#4CAF50';
        } else if (status.includes('失败') || status.includes('错误')) {
          ttsStatus.style.color = '#f44336';
        } else {
          ttsStatus.style.color = 'rgba(255, 255, 255, 0.7)';
        }
      }
    }
    
    // 更新TTS按钮状态
    function updateTTSButtons() {
      const startBtn = document.getElementById('ttsStartBtn');
      const stopBtn = document.getElementById('ttsStopBtn');
      
      if (startBtn) {
        startBtn.disabled = ttsActive;
      }
      
      if (stopBtn) {
        const isPlaying = ttsAudioPlayer && !ttsAudioPlayer.paused;
        stopBtn.disabled = !isPlaying;
      }
    }
    
    // 显示/隐藏TTS文本输入区域
    function toggleTTSInput(show) {
      const ttsInput = document.getElementById('ttsTextInput');
      if (ttsInput) {
        ttsInput.style.display = show ? 'flex' : 'none';
      }
    }
    
    // TTS功能控制
    function startTTS() {
      ttsEnabled = true;
      toggleTTSInput(true);
      console.log('🎵 TTS功能已启用');
    }
    
    function stopTTS() {
      ttsEnabled = false;
      toggleTTSInput(false);
      
      // 🧠 关闭TTS功能时隐藏思考动画
      hideThinking();
      console.log('🧠 隐藏思考动画 - TTS功能已关闭');
      
      // 停止当前播放
      if (ttsAudioPlayer && !ttsAudioPlayer.paused) {
        ttsAudioPlayer.pause();
        
        // 停止数字人嘴部动画
        if (live2dSprite && live2dSprite.stopVoice) {
          try {
            live2dSprite.stopVoice();
            console.log('🎭 数字人嘴部动画已停止（功能关闭）');
          } catch (error) {
            console.warn('🎭 停止嘴部动画失败:', error);
          }
        }
        
        // 清理音频URL资源
        if (ttsAudioPlayer.src && ttsAudioPlayer.src.startsWith('blob:')) {
          URL.revokeObjectURL(ttsAudioPlayer.src);
        }
      }
      
      ttsActive = false;
      updateTTSButtons();
      updateTTSStatus('已禁用', false);
      console.log('   TTS功能已禁用');
    }
    
    // 全局TTS函数
    window.startTTSSynthesis = startTTSSynthesis;
    window.stopTTSPlayback = stopTTSPlayback;
    
    // ==================== 面试系统相关变量 ====================

    let currentUser = null;
    let interviewConfig = null;
    let interviewQuestions = null;
    let currentSection = null;
    let currentSectionIndex = 0;
    let currentQuestionIndex = 0;
    let selectedSections = [];
    let interviewData = []; // 存储面试问答数据
    let awaitingAnswer = false;
    
    // 反问环节相关变量
    let reverseQAActive = false;
    let reverseQAData = [];
    let currentReverseRound = 0;
    const maxReverseRounds = 2; // 最多2轮反问
    
    // 反问提示语列表
    const reverseQuestionPrompts = [
      "接下来是反问环节，你有什么想问的吗？",
      "还有其他问题吗？",
      "您还有什么想了解的吗？",
      "有什么问题想要咨询的吗？",
      "还有什么疑问需要解答吗？",
      "您还想了解哪些方面的情况？",
      "有什么其他想知道的吗？",
      "还需要了解什么信息吗？"
    ];
    
    // 面试状态枚举
    const InterviewState = {
      NOT_STARTED: 'not_started',
      INTRODUCTION: 'introduction',
      QUESTIONING: 'questioning', 
      WAITING_ANSWER: 'waiting_answer',
      NEXT_QUESTION: 'next_question',
      SECTION_COMPLETE: 'section_complete',
      REVERSE_QA: 'reverse_qa',
      REVERSE_QA_WAITING: 'reverse_qa_waiting',
      INTERVIEW_COMPLETE: 'interview_complete',
      PAUSED: 'paused'
    };
    
    let interviewState = InterviewState.NOT_STARTED;
    
    // 初始化面试系统
    async function initInterviewSystem() {
      console.log('🎯 初始化面试系统...');
      
      try {
        // 获取当前用户信息（使用sessionStorage）
        const user = sessionStorage.getItem('user');
        if (!user) {
          console.warn('⚠️ 未找到登录用户，无法启动面试');
          updateInterviewStatus('请先登录');
          document.getElementById('startInterviewBtn').disabled = true;
          return;
        }
        
        const userData = JSON.parse(user);
        currentUser = userData.username;
        console.log(`👤 当前用户: ${currentUser}`);
        
        // 加载用户的面试配置
        await loadInterviewConfig();
        
        // 更新面试状态显示
        updateInterviewStatus('面试已就绪，点击开始面试');
        document.getElementById('startInterviewBtn').disabled = false;
        document.getElementById('mainStartInterviewBtn').disabled = false;
        
      } catch (error) {
        console.error('❌ 初始化面试系统失败:', error);
        updateInterviewStatus('初始化失败');
        document.getElementById('startInterviewBtn').disabled = true;
        document.getElementById('mainStartInterviewBtn').disabled = true;
      }
    }
    
    // 加载面试配置
    async function loadInterviewConfig() {
      try {
        console.log(`📋 加载用户 ${currentUser} 的面试配置...`);
        
        // 加载面试配置
        const configResponse = await fetch(`/uploads/${currentUser}/interview_config.json`);
        if (!configResponse.ok) {
          throw new Error('面试配置文件不存在');
        }
        interviewConfig = await configResponse.json();
        
        // 加载面试题目
        const questionsResponse = await fetch(`/uploads/${currentUser}/interview_questions.json`);
        if (!questionsResponse.ok) {
          throw new Error('面试题目文件不存在');
        }
        interviewQuestions = await questionsResponse.json();
        
        // 获取选定的面试板块
        selectedSections = interviewConfig.interview_config.selected_sections || [];
        
        console.log('✅ 面试配置加载成功');
        console.log(`📝 面试板块: ${selectedSections.join(', ')}`);
        console.log(`👤 面试者: ${interviewConfig.interview_config.candidate_name}`);
        console.log(`🎯 职位: ${interviewConfig.interview_config.position}`);
        console.log(`🏢 公司: ${interviewConfig.interview_config.target_company}`);
        
      } catch (error) {
        console.error('❌ 加载面试配置失败:', error);
        throw error;
      }
    }
    
    // 更新面试状态显示
    function updateInterviewStatus(status) {
      const statusElement = document.getElementById('interviewStatus');
      if (statusElement) {
        statusElement.textContent = status;
      }
    }
    
    // 更新面试进度
    function updateInterviewProgress() {
      const progressElement = document.getElementById('interviewProgress');
      const currentSectionElement = document.getElementById('currentSection');
      const questionProgressElement = document.getElementById('questionProgress');
      const progressBarElement = document.getElementById('progressBar');
      
      if (progressElement && currentSectionElement && questionProgressElement && progressBarElement) {
        if (interviewActive && selectedSections.length > 0) {
          progressElement.style.display = 'block';
          
          const sectionName = selectedSections[currentSectionIndex] || '未知';
          currentSectionElement.textContent = sectionName;
          
          // 计算当前板块的题目数量
          let totalQuestions = 0;
          let currentQuestionNum = currentQuestionIndex + 1;
          
          if (sectionName !== '自我介绍' && interviewQuestions && interviewQuestions.questions[sectionName]) {
            totalQuestions = interviewQuestions.questions[sectionName].length;
          } else if (sectionName === '自我介绍') {
            totalQuestions = 1;
          }
          
          questionProgressElement.textContent = `${currentQuestionNum}/${totalQuestions}`;
          
          // 计算总体进度
          const totalSections = selectedSections.length;
          const completedSections = currentSectionIndex;
          const sectionProgress = totalQuestions > 0 ? (currentQuestionIndex / totalQuestions) : 0;
          const totalProgress = ((completedSections + sectionProgress) / totalSections) * 100;
          
          progressBarElement.style.width = `${Math.min(100, totalProgress)}%`;
        } else {
          progressElement.style.display = 'none';
        }
      }
    }
    
    // 开始面试
    async function startInterview() {
      if (!currentUser || !interviewConfig || !selectedSections.length) {
        showNotification('面试配置未就绪，请检查登录状态和配置文件', 'error');
        return;
      }
      
      console.log('🎯 开始面试...');
      interviewActive = true;
      interviewState = InterviewState.INTRODUCTION;
      currentSectionIndex = 0;
      currentQuestionIndex = 0;
      interviewData = [];
      
      // 更新按钮状态
      document.getElementById('startInterviewBtn').disabled = true;
      document.getElementById('mainStartInterviewBtn').disabled = true;
      document.getElementById('pauseInterviewBtn').disabled = false;
      document.getElementById('stopInterviewBtn').disabled = false;
      
      updateInterviewStatus('面试进行中...');
      updateInterviewProgress();
      
      // 开始第一个板块
      await startCurrentSection();
    }
    
    // 开始当前板块
    async function startCurrentSection() {
      if (currentSectionIndex >= selectedSections.length) {
        await completeInterview();
        return;
      }
      
      currentSection = selectedSections[currentSectionIndex];
      currentQuestionIndex = 0;
      
      console.log(`📋 开始面试板块: ${currentSection}`);
      updateInterviewProgress();
      
      if (currentSection === '自我介绍') {
        await startIntroductionSection();
      } else {
        await startQuestionSection();
      }
    }
    
    // 开始自我介绍板块
    async function startIntroductionSection() {
      const candidateName = interviewConfig.interview_config.candidate_name;
      const strictMode = interviewConfig.interview_config.strict_mode;
      
      let introText;
      if (strictMode) {
        introText = `你好${candidateName}，我是今天的面试官。本次面试将采用严格模式进行，请认真回答每个问题。现在，请先做一段详细的自我介绍，包括您的教育背景、工作经验和个人优势。`;
      } else {
        introText = `你好${candidateName}，我是今天的面试官，很高兴见到您。请先做一段自我介绍，让我们更好地了解您。`;
      }
      
      console.log(`🎤 面试官: ${introText}`);
      
      // 记录问题
      const questionData = {
        section: '自我介绍',
        question: '请开始您的自我介绍',
        timestamp: new Date().toISOString(),
        answer: null
      };
      interviewData.push(questionData);
      
      // TTS语音合成
      await speakQuestion(introText);
      
      // 等待用户回答
      awaitingAnswer = true;
      interviewState = InterviewState.WAITING_ANSWER;
      updateInterviewStatus('请开始自我介绍...');
    }
    
    // 开始题目板块
    async function startQuestionSection() {
      const questions = interviewQuestions.questions[currentSection];
      
      if (!questions || questions.length === 0) {
        console.warn(`⚠️ 板块 ${currentSection} 没有题目，跳过`);
        await nextSection();
        return;
      }
      
      await askCurrentQuestion();
    }
    
    // 提问当前题目
    async function askCurrentQuestion() {
      const questions = interviewQuestions.questions[currentSection];
      
      if (currentQuestionIndex >= questions.length) {
        await nextSection();
        return;
      }
      
      const question = questions[currentQuestionIndex];
      const questionText = question.question;
      
      console.log(`❓ 第${currentQuestionIndex + 1}题: ${questionText}`);
      
      // 记录问题
      const questionData = {
        section: currentSection,
        question: questionText,
        questionIndex: currentQuestionIndex + 1,
        importance: question.importance,
        difficulty: question.difficulty,
        timestamp: new Date().toISOString(),
        answer: null
      };
      interviewData.push(questionData);
      
      // TTS语音合成
      await speakQuestion(questionText);
      
      // 等待用户回答
      awaitingAnswer = true;
      interviewState = InterviewState.WAITING_ANSWER;
      updateInterviewStatus(`正在提问第${currentQuestionIndex + 1}题...`);
      updateInterviewProgress();
    }
    
    // 语音合成问题
    async function speakQuestion(text) {
      console.log(`🎵 开始语音合成问题...`);
      
      // 设置TTS文本
      const ttsTextArea = document.getElementById('ttsTextArea');
      if (ttsTextArea) {
        ttsTextArea.value = text;
      }
      
      // 启用TTS功能（如果未启用）
      if (!systemSettings.ttsEnabled) {
        systemSettings.ttsEnabled = true;
        const ttsToggle = document.querySelector('[data-setting="ttsEnabled"]');
        if (ttsToggle) {
          ttsToggle.classList.add('active');
        }
        startTTS();
      }
      
      // 设置音频播放完成后的回调
      return new Promise((resolve) => {
        // 设置全局回调，当音频播放完成时调用
        window.interviewTTSCallback = async () => {
          console.log('🎵 面试TTS播放完成，开始ASR识别');
          
          // 延迟1秒后开始ASR识别，给用户反应时间
          setTimeout(async () => {
            await startAnswerRecording();
            resolve();
          }, 1000);
          
          // 清除回调
          window.interviewTTSCallback = null;
        };
        
        // 开始合成
        startTTSSynthesis();
      });
    }
    
    // 开始录音识别答案
    async function startAnswerRecording() {
      console.log('🎙️ 开始录音识别用户回答...');
      
      // 启用ASR功能（如果未启用）
      if (!systemSettings.asrRecognition) {
        systemSettings.asrRecognition = true;
        const asrToggle = document.querySelector('[data-setting="asrRecognition"]');
        if (asrToggle) {
          asrToggle.classList.add('active');
        }
        
        // 显示ASR结果区域
        if (!asrResultsVisible) {
          toggleASRResults();
        }
      }
      
      // 开始智能ASR识别
      if (!asrActive) {
        startSmartASR();
      }
      
      updateInterviewStatus('请回答问题（正在录音识别）...');
    }
    
    // 下一题
    async function nextQuestion() {
      currentQuestionIndex++;
      await askCurrentQuestion();
    }
    
    // 下一个板块
    async function nextSection() {
      console.log(`✅ 板块 ${currentSection} 完成`);
      currentSectionIndex++;
      await startCurrentSection();
    }
    
    // 完成面试
    async function completeInterview() {
      console.log('🎉 所有面试板块完成！');
      
      // 检查是否包含反问环节
      if (selectedSections.includes('反问环节')) {
        console.log('🔄 开始反问环节...');
        await startReverseQASection();
        return;
      }
      
      // 如果没有反问环节，直接结束面试
      await finalizeInterview();
    }
    
    // 最终结束面试
    async function finalizeInterview() {
      console.log('🎉 面试完全结束！');
      interviewActive = false;
      interviewState = InterviewState.INTERVIEW_COMPLETE;
      awaitingAnswer = false;
      reverseQAActive = false;
      
      // 1. 停止所有分析功能
      console.log('🛑 正在关闭所有分析功能...');
      updateInterviewStatus('正在关闭分析功能...');
      
      // 停止ASR识别
      if (asrActive) {
        console.log('🛑 停止ASR识别');
        stopASRRecognition();
      }
      
      // 停止微表情分析
      if (typeof stopFacialAnalysis === 'function') {
        console.log('🛑 停止微表情分析');
        await stopFacialAnalysis();
      }
      
      // 停止语调分析  
      if (typeof stopVoiceAnalysis === 'function') {
        console.log('🛑 停止语调分析');
        await stopVoiceAnalysis();
      }
      
      // 等待分析完成
      await new Promise(resolve => setTimeout(resolve, 2000));
      
      // 2. 保存面试结果
      console.log('💾 保存面试结果...');
      updateInterviewStatus('正在保存面试数据...');
      await saveInterviewResults();
      
      // 3. 运行面试总结分析
      console.log('📊 开始AI面试总结分析...');
      updateInterviewStatus('正在进行AI分析评分...');
      
      try {
        const summaryResponse = await fetch('/api/interview/run-summary', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            username: currentUser
          })
        });
        
        const summaryResult = await summaryResponse.json();
        
        if (summaryResult.success) {
          console.log('✅ 面试总结分析完成');
          updateInterviewStatus('AI分析完成！');
          showNotification('🎉 面试完成！AI分析已生成', 'success');
          
          // 4. 更新按钮状态
          document.getElementById('startInterviewBtn').disabled = false;
          document.getElementById('mainStartInterviewBtn').disabled = false;
          document.getElementById('pauseInterviewBtn').disabled = true;
          document.getElementById('stopInterviewBtn').disabled = true;
          
          // 5. 延迟3秒后跳转到结果页面
          setTimeout(() => {
            console.log('🔄 跳转到面试结果页面');
            window.location.href = '/interview-result';
          }, 3000);
          
        } else {
          console.error('❌ 面试总结分析失败:', summaryResult.message);
          updateInterviewStatus('分析失败，但面试已完成');
          showNotification('面试完成，但AI分析失败', 'warning');
          
          // 即使分析失败，也要跳转到结果页面
          setTimeout(() => {
            window.location.href = '/interview-result';
          }, 5000);
        }
        
      } catch (error) {
        console.error('❌ 运行面试总结时发生错误:', error);
        updateInterviewStatus('面试已完成');
        showNotification('面试完成！', 'success');
        
        // 发生错误时也跳转到结果页面
        setTimeout(() => {
          window.location.href = '/interview-result';
        }, 3000);
      }
    }
    
    // 暂停面试
    function pauseInterview() {
      if (!interviewActive) return;
      
      console.log('⏸️ 面试已暂停');
      interviewState = InterviewState.PAUSED;
      awaitingAnswer = false;
      
      // 停止当前的语音播放和录音
      if (ttsActive) {
        stopTTSPlayback();
      }
      if (asrActive) {
        stopASRRecognition();
      }
      
      updateInterviewStatus('面试已暂停');
      
      // 更新按钮状态
      document.getElementById('startInterviewBtn').disabled = false;
      document.getElementById('mainStartInterviewBtn').disabled = false;
      document.getElementById('pauseInterviewBtn').disabled = true;
      
      showNotification('⏸️ 面试已暂停', 'info');
    }
    
    // 停止面试
    function stopInterview() {
      if (!interviewActive) return;
      
      console.log('🛑 面试已停止');
      interviewActive = false;
      interviewState = InterviewState.NOT_STARTED;
      awaitingAnswer = false;
      
      // 停止所有播放和录音
      if (ttsActive) {
        stopTTSPlayback();
      }
      if (asrActive) {
        stopASRRecognition();
      }
      
      // 重置状态
      currentSectionIndex = 0;
      currentQuestionIndex = 0;
      
      // 更新按钮状态
      document.getElementById('startInterviewBtn').disabled = false;
      document.getElementById('mainStartInterviewBtn').disabled = false;
      document.getElementById('pauseInterviewBtn').disabled = true;
      document.getElementById('stopInterviewBtn').disabled = true;
      
      updateInterviewStatus('面试已停止');
      updateInterviewProgress();
      
      showNotification('🛑 面试已停止', 'info');
    }
    
    // 保存面试结果
    async function saveInterviewResults() {
      try {
        console.log('💾 保存面试结果...');
        
        const qaData = generateQAMarkdown();
        
        const response = await fetch('/api/interview/save-results', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            username: currentUser,
            qa_content: qaData,
            interview_data: interviewData,
            reverse_qa_data: reverseQAData, // 包含反问环节数据
            config: interviewConfig
          })
        });
        
        const result = await response.json();
        
        if (result.success) {
          console.log('✅ 面试结果保存成功');
        } else {
          console.error('❌ 保存面试结果失败:', result.message);
          showNotification('保存面试结果失败', 'error');
        }
        
      } catch (error) {
        console.error('❌ 保存面试结果时发生错误:', error);
        showNotification('保存面试结果时发生错误', 'error');
      }
    }
    
    // 生成QA markdown格式
    function generateQAMarkdown() {
      const timestamp = new Date().toLocaleString('zh-CN', {
        year: 'numeric',
        month: '2-digit', 
        day: '2-digit',
        hour: '2-digit',
        minute: '2-digit',
        second: '2-digit'
      });
      
      let markdown = `\n\n<!-- START: 面试记录 - ${timestamp} -->\n`;
      markdown += `## 面试记录 - ${timestamp}\n\n`;
      markdown += `**面试者：** ${interviewConfig.interview_config.candidate_name}\n`;
      markdown += `**职位：** ${interviewConfig.interview_config.position}\n`;
      markdown += `**公司：** ${interviewConfig.interview_config.target_company}\n`;
      markdown += `**面试模式：** ${interviewConfig.interview_config.strict_mode ? '严格模式' : '普通模式'}\n\n`;
      
      let currentSection = '';
      let questionCount = 0;
      
      // 处理普通面试问答
      for (const item of interviewData) {
        if (item.section !== currentSection) {
          if (currentSection) {
            markdown += `<!-- END: ${currentSection} -->\n\n`;
          }
          currentSection = item.section;
          questionCount = 0;
          markdown += `<!-- START: ${currentSection} -->\n`;
          markdown += `## ${currentSection} - ${timestamp}\n\n`;
        }
        
        questionCount++;
        
        if (item.section === '自我介绍') {
          markdown += `**面试官开场白：**\n${item.question}\n\n`;
        } else {
          markdown += `**面试官问题${questionCount}：**\n${item.question}\n\n`;
        }
        
        if (item.answer) {
          markdown += `**面试者回答：**\n${item.answer}\n\n`;
        } else {
          markdown += `**面试者回答：**\n（未回答或识别失败）\n\n`;
        }
      }
      
      if (currentSection) {
        markdown += `<!-- END: ${currentSection} -->\n\n`;
      }
      
      // 处理反问环节
      if (reverseQAData && reverseQAData.length > 0) {
        markdown += `<!-- START: 反问环节 -->\n`;
        markdown += `## 反问环节 - ${timestamp}\n\n`;
        
        for (const reverseItem of reverseQAData) {
          markdown += `### 第${reverseItem.round}轮反问 - ${new Date(reverseItem.timestamp).toLocaleString('zh-CN')}\n`;
          markdown += `**问题类型**: ${reverseItem.questionType || '未分类'}\n`;
          markdown += `**面试者问题**: ${reverseItem.userQuestion || '（未提问）'}\n`;
          markdown += `**面试官回答**: ${reverseItem.aiAnswer || '（未回答）'}\n\n`;
        }
        
        markdown += `<!-- END: 反问环节 -->\n\n`;
      }
      
      markdown += `<!-- END: 面试记录 - ${timestamp} -->\n`;
      
      return markdown;
    }
    
    // 全局面试函数
    window.startInterview = startInterview;
    window.pauseInterview = pauseInterview;
    window.stopInterview = stopInterview;
    
    // 处理面试回答
    async function handleInterviewAnswer(answer) {
      if (!awaitingAnswer || !interviewActive) return;
      
      console.log(`✅ 收到面试回答: ${answer}`);
      awaitingAnswer = false;
      
      // 保存回答到当前问题
      if (interviewData.length > 0) {
        const currentQuestion = interviewData[interviewData.length - 1];
        currentQuestion.answer = answer;
        currentQuestion.answered_at = new Date().toISOString();
      }
      
      // 停止ASR识别
      if (asrActive) {
        stopASRRecognition();
      }
      
      updateInterviewStatus('回答已记录，准备下一题...');
      
      // 延迟2秒后进入下一题
      setTimeout(async () => {
        if (currentSection === '自我介绍') {
          // 自我介绍完成，进入下一个板块
          await nextSection();
        } else {
          // 进入下一题或下一个板块
          await nextQuestion();
        }
      }, 2000);
    }
    
    // 全局回答处理函数
    window.handleInterviewAnswer = handleInterviewAnswer;
    
    // ==================== 反问环节功能 ====================
    
    // 开始反问环节
    async function startReverseQASection() {
      console.log('🔄 开始反问环节');
      reverseQAActive = true;
      interviewState = InterviewState.REVERSE_QA;
      currentReverseRound = 0;
      reverseQAData = [];
      
      updateInterviewStatus('反问环节');
      updateInterviewProgress();
      
      // 开始第一轮反问
      await conductReverseQARound();
    }
    
    // 进行一轮反问
    async function conductReverseQARound() {
      if (currentReverseRound >= maxReverseRounds) {
        console.log('   反问环节已达到最大轮数，结束');
        await finalizeInterview();
        return;
      }
      
      currentReverseRound++;
      console.log(`🔄 开始第 ${currentReverseRound} 轮反问`);
      
      // 随机选择反问提示语
      let questionPrompt;
      if (currentReverseRound === 1) {
        questionPrompt = reverseQuestionPrompts[0]; // 第一轮固定使用第一个
      } else {
        const randomIndex = Math.floor(Math.random() * (reverseQuestionPrompts.length - 1)) + 1;
        questionPrompt = reverseQuestionPrompts[randomIndex];
      }
      
      console.log(`🎤 反问提示语: ${questionPrompt}`);
      updateInterviewStatus(`第${currentReverseRound}轮反问 - 请提问`);
      
      // 记录反问轮次开始
      const reverseRoundData = {
        round: currentReverseRound,
        prompt: questionPrompt,
        timestamp: new Date().toISOString(),
        userQuestion: null,
        aiAnswer: null,
        questionType: null
      };
      reverseQAData.push(reverseRoundData);
      
      // TTS合成反问提示语
      await speakReverseQuestion(questionPrompt);
    }
    
    // 语音合成反问问题
    async function speakReverseQuestion(text) {
      console.log(`🎵 开始合成反问提示语...`);
      
      // 设置TTS文本
      const ttsTextArea = document.getElementById('ttsTextArea');
      if (ttsTextArea) {
        ttsTextArea.value = text;
      }
      
      // 启用TTS功能（如果未启用）
      if (!systemSettings.ttsEnabled) {
        systemSettings.ttsEnabled = true;
        const ttsToggle = document.querySelector('[data-setting="ttsEnabled"]');
        if (ttsToggle) {
          ttsToggle.classList.add('active');
        }
        startTTS();
      }
      
      // 设置音频播放完成后的回调
      return new Promise((resolve) => {
        // 设置全局回调，当音频播放完成时调用
        window.interviewTTSCallback = async () => {
          console.log('🎵 反问提示语播放完成，开始录音识别用户问题');
          
          // 延迟1秒后开始ASR识别用户问题
          setTimeout(async () => {
            await startReverseQuestionRecording();
            resolve();
          }, 1000);
          
          // 清除回调
          window.interviewTTSCallback = null;
        };
        
        // 开始合成
        startTTSSynthesis();
      });
    }
    
    // 开始录音识别用户的反问
    async function startReverseQuestionRecording() {
      console.log('🎙️ 开始录音识别用户的反问...');
      
      // 启用ASR功能（如果未启用）
      if (!systemSettings.asrRecognition) {
        systemSettings.asrRecognition = true;
        const asrToggle = document.querySelector('[data-setting="asrRecognition"]');
        if (asrToggle) {
          asrToggle.classList.add('active');
        }
        
        // 显示ASR结果区域
        if (!asrResultsVisible) {
          toggleASRResults();
        }
      }
      
      // 开始智能ASR识别
      if (!asrActive) {
        startSmartASR();
      }
      
      awaitingAnswer = true;
      interviewState = InterviewState.REVERSE_QA_WAITING;
      updateInterviewStatus(`第${currentReverseRound}轮反问 - 请提出您的问题`);
    }
    
    // 处理反问环节的用户问题
    async function handleReverseUserQuestion(userQuestion) {
      if (!reverseQAActive || !awaitingAnswer) return;
      
      console.log(`🔄 收到用户反问: ${userQuestion}`);
      awaitingAnswer = false;
      
      // 保存用户问题到当前轮次
      if (reverseQAData.length > 0) {
        const currentRound = reverseQAData[reverseQAData.length - 1];
        currentRound.userQuestion = userQuestion;
        currentRound.questionReceived = new Date().toISOString();
      }
      
      // 停止ASR识别
      if (asrActive) {
        stopASRRecognition();
      }
      
      updateInterviewStatus(`第${currentReverseRound}轮反问 - 正在分析问题...`);
      
      // 调用星火大模型分析问题
      const analysisResult = await analyzeUserQuestionWithSpark(userQuestion);
      
      // 检查用户是否想要停止
      if (analysisResult.want_to_stop) {
        console.log('🎯 用户想要结束反问环节');
        await finalizeInterview();
        return;
      }
      
      // 保存AI回答
      if (reverseQAData.length > 0) {
        const currentRound = reverseQAData[reverseQAData.length - 1];
        currentRound.aiAnswer = analysisResult.answer;
        currentRound.questionType = analysisResult.question_type;
        currentRound.aiResponseTime = new Date().toISOString();
      }
      
      console.log(`🤖 AI回答: ${analysisResult.answer}`);
      updateInterviewStatus(`第${currentReverseRound}轮反问 - 正在播放回答...`);
      
      // TTS合成播放AI回答
      await speakReverseAnswer(analysisResult.answer);
    }
    
    // 语音合成AI回答
    async function speakReverseAnswer(answer) {
      console.log(`🎵 开始合成AI回答...`);
      
      // 设置TTS文本
      const ttsTextArea = document.getElementById('ttsTextArea');
      if (ttsTextArea) {
        ttsTextArea.value = answer;
      }
      
      // 设置音频播放完成后的回调
      return new Promise((resolve) => {
        // 设置全局回调，当音频播放完成时调用
        window.interviewTTSCallback = async () => {
          console.log('🎵 AI回答播放完成');
          
          // 延迟2秒后进行下一轮或结束
          setTimeout(async () => {
            if (currentReverseRound < maxReverseRounds) {
              await conductReverseQARound(); // 进行下一轮
            } else {
              await finalizeInterview(); // 结束面试
            }
            resolve();
          }, 2000);
          
          // 清除回调
          window.interviewTTSCallback = null;
        };
        
        // 开始合成
        startTTSSynthesis();
      });
    }
    
    // 使用星火大模型分析用户问题
    async function analyzeUserQuestionWithSpark(userQuestion) {
      try {
        const targetCompany = interviewConfig?.interview_config?.target_company || '某公司';
        const position = interviewConfig?.interview_config?.position || '某岗位';
        const techDomain = interviewConfig?.interview_config?.tech_domain || '相关技术领域';
        const candidateName = interviewConfig?.interview_config?.candidate_name || '面试者';
        
        const prompt = `
这是一个面试反问环节，面试者向面试官提问。请分析用户的问题并回答。

【面试背景信息】：
- 目标公司：${targetCompany}
- 面试岗位：${position}
- 技术领域：${techDomain}
- 面试者：${candidateName}

用户问题："${userQuestion}"

请返回JSON格式的响应，包含以下字段：
1. "want_to_stop": boolean - 判断用户是否想要结束反问环节（如"没有了"、"结束"、"停止"等）
2. "answer": string - 对用户问题的专业回答
3. "question_type": string - 问题类型（如"薪资福利"、"工作内容"、"公司文化"、"发展前景"等）

注意：
- 如果用户有不想继续问答的意愿时，将want_to_stop设为true，以停止问答。
- 回答要专业、详细，符合面试官的身份，但要尽量简洁，不要啰嗦。
- 回答时要结合${targetCompany}的背景和${position}岗位的特点
- 如果问题不清楚，可以要求用户澄清

返回格式：
{
    "want_to_stop": false,
    "answer": "具体的回答内容",
    "question_type": "问题类型"
}`;
        
        console.log('🤖 正在调用星火大模型分析问题...');
        
        const response = await fetch('/api/interview/analyze-reverse-question', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            prompt: prompt,
            user_question: userQuestion,
            interview_config: interviewConfig?.interview_config || {}
          })
        });
        
        const result = await response.json();
        
        if (result.success) {
          console.log('✅ 星火大模型分析完成');
          return result.analysis;
        } else {
          console.error('❌ 星火大模型调用失败:', result.message);
          return {
            want_to_stop: false,
            answer: "抱歉，我暂时无法理解您的问题，请您再详细说明一下。",
            question_type: "未识别"
          };
        }
        
      } catch (error) {
        console.error('❌ 调用星火大模型分析时发生错误:', error);
        return {
          want_to_stop: false,
          answer: "抱歉，系统暂时无法处理您的问题，请稍后再试。",
          question_type: "系统错误"
        };
      }
    }
    
    // 全局反问处理函数
    window.handleReverseUserQuestion = handleReverseUserQuestion;
  	</script>
</body>
</html>