<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>AIé¢è¯•å®˜ - æ™ºèƒ½é¢è¯•ç³»ç»Ÿ</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='css/index.css') }}">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    body {
      margin: 0;
      overflow: hidden;
      background-color: #f0f0f0;
      font-family: 'Inter', sans-serif;
    }
    
    canvas#live2d {
      width: 100vw;
      height: 100vh;
      position: absolute;
      top: 0;
      left: 0;
      z-index: 10;
    }
    
    /* é¢è¯•æ§åˆ¶é¢æ¿ */
    .interview-controls {
      position: fixed;
      top: 20px;
      right: 20px;
      background: rgba(255, 255, 255, 0.1);
      backdrop-filter: blur(20px);
      border-radius: 20px;
      padding: 20px;
      border: 1px solid rgba(255, 255, 255, 0.2);
      z-index: 20;
      min-width: 250px;
    }
    
    .control-title {
      color: white;
      font-size: 1.2rem;
      margin-bottom: 15px;
      text-align: center;
      font-weight: 600;
    }
    
    .control-btn {
      width: 100%;
      padding: 12px;
      margin: 8px 0;
      border: none;
      border-radius: 10px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      cursor: pointer;
      transition: all 0.3s ease;
      font-size: 14px;
      font-weight: 500;
    }
    
    .control-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 25px rgba(102, 126, 234, 0.4);
    }
    
    .control-btn:disabled {
      opacity: 0.6;
      cursor: not-allowed;
      transform: none;
    }
    
    .status-text {
      color: rgba(255, 255, 255, 0.8);
      font-size: 12px;
      text-align: center;
      margin: 10px 0;
      min-height: 20px;
    }
    
    /* èŠå¤©åŒºåŸŸ */
    .chat-area {
      position: fixed;
      bottom: 20px;
      left: 20px;
      right: 20px;
      background: rgba(255, 255, 255, 0.1);
      backdrop-filter: blur(20px);
      border-radius: 20px;
      padding: 20px;
      border: 1px solid rgba(255, 255, 255, 0.2);
      z-index: 20;
      max-height: 200px;
      display: flex;
      flex-direction: column;
    }
    
    .chat-messages {
      flex: 1;
      overflow-y: auto;
      margin-bottom: 15px;
      max-height: 120px;
    }
    
    .message {
      margin-bottom: 10px;
      padding: 8px 12px;
      border-radius: 10px;
      max-width: 80%;
      word-wrap: break-word;
      font-size: 14px;
    }
    
    .message.interviewer {
      background: rgba(102, 126, 234, 0.3);
      color: white;
      border: 1px solid rgba(102, 126, 234, 0.5);
      margin-right: auto;
    }
    
    .message.candidate {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      margin-left: auto;
    }
    
    .chat-input {
      display: flex;
      gap: 10px;
    }
    
    .chat-input input {
      flex: 1;
      padding: 12px;
      border: 1px solid rgba(255, 255, 255, 0.2);
      border-radius: 10px;
      background: rgba(255, 255, 255, 0.1);
      color: white;
      font-size: 14px;
    }
    
    .chat-input input:focus {
      outline: none;
      border-color: #667eea;
      box-shadow: 0 0 15px rgba(102, 126, 234, 0.3);
    }
    
    .chat-input input::placeholder {
      color: rgba(255, 255, 255, 0.5);
    }
    
    .send-btn {
      padding: 12px 20px;
      border: none;
      border-radius: 10px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      cursor: pointer;
      transition: all 0.3s ease;
    }
    
    .send-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
    }
    
    /* è¿”å›æŒ‰é’® */
    .back-btn {
      position: fixed;
      top: 20px;
      left: 20px;
      background: rgba(255, 255, 255, 0.1);
      border: 1px solid rgba(255, 255, 255, 0.2);
      color: white;
      padding: 10px 15px;
      border-radius: 25px;
      cursor: pointer;
      transition: all 0.3s ease;
      backdrop-filter: blur(10px);
      z-index: 100;
    }
    
    .back-btn:hover {
      background: rgba(255, 255, 255, 0.2);
      transform: translateY(-2px);
    }
    
    /* æ³¢åŠ¨æ•ˆæœæ ·å¼ */
    .rocket-wave {
      position: fixed;
      pointer-events: none;
      z-index: 9999;
      border: 2px solid rgba(255, 255, 255, 0.3);
      border-radius: 50%;
      animation: waveExpand 2s ease-out forwards;
    }
    
    @keyframes waveExpand {
      0% {
        width: 0;
        height: 0;
        opacity: 1;
        transform: translate(-50%, -50%);
      }
      100% {
        width: 200px;
        height: 200px;
        opacity: 0;
        transform: translate(-50%, -50%);
      }
    }
    
    /* å“åº”å¼è®¾è®¡ */
    @media (max-width: 768px) {
      .interview-controls {
        top: 10px;
        right: 10px;
        left: 10px;
        min-width: auto;
      }
      
      .chat-area {
        bottom: 10px;
        left: 10px;
        right: 10px;
      }
    }
    
    /* é€šçŸ¥åŠ¨ç”» */
    @keyframes slideIn {
      from {
        transform: translateX(100%);
        opacity: 0;
      }
      to {
        transform: translateX(0);
        opacity: 1;
      }
    }
    
    @keyframes slideOut {
      from {
        transform: translateX(0);
        opacity: 1;
      }
      to {
        transform: translateX(100%);
        opacity: 0;
      }
    }
    
    /* AIæ€è€ƒåŠ¨ç”» */
    .ai-thinking {
      position: fixed;
      bottom: 80px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(255, 255, 255, 0.1);
      backdrop-filter: blur(20px);
      border-radius: 20px;
      padding: 15px 25px;
      border: 1px solid rgba(255, 255, 255, 0.2);
      z-index: 1000;
      display: none;
      flex-direction: column;
      align-items: center;
      gap: 10px;
      min-width: 280px;
    }
    
    .thinking-progress {
      display: flex;
      align-items: center;
      gap: 15px;
      width: 100%;
      position: relative;
    }
    
    .thinking-icon {
      width: 35px;
      height: 35px;
      border-radius: 50%;
      background: rgba(255, 255, 255, 0.2);
      display: flex;
      align-items: center;
      justify-content: center;
      color: rgba(255, 255, 255, 0.4);
      font-size: 16px;
      transition: all 0.5s ease;
      position: relative;
      z-index: 2;
      flex-shrink: 0;
    }
    
    .thinking-icon.active {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      box-shadow: 0 0 20px rgba(102, 126, 234, 0.5);
      transform: scale(1.1);
    }
    
    .progress-line1 {
      flex: 1;
      height: 3px;
      background: rgba(255, 255, 255, 0.2);
      border-radius: 2px;
      position: relative;
      overflow: hidden;
    }

	.progress-line2 {
      flex: 1;
      height: 3px;
      background: rgba(255, 255, 255, 0.2);
      border-radius: 2px;
      position: relative;
      overflow: hidden;
    }
    
    .progress-fill1 {
	  height: 100%;
	  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
	  width: 0%;
	  border-radius: 2px;
	  transition: none; /* é»˜è®¤æ— åŠ¨ç”» */
	}
    
	.progress-fill2 {
	  height: 100%;
	  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
	  width: 0%;
	  border-radius: 2px;
	  transition: none; /* é»˜è®¤æ— åŠ¨ç”» */
	}

    .progress-fill1.animate {
      transition: width 1s ease;
    }
    
    .progress-fill2.animate {
      transition: width 1s ease;
    }
    
    /* ç³»ç»Ÿè®¾ç½®é¢æ¿ */
    .system-settings {
      position: fixed;
      top: 20px;
      right: 20px;
      z-index: 200;
    }
    
    .settings-toggle {
      width: 50px;
      height: 50px;
      border-radius: 50%;
      background: rgba(255, 255, 255, 0.1);
      backdrop-filter: blur(20px);
      border: 1px solid rgba(255, 255, 255, 0.2);
      color: white;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 20px;
      transition: all 0.3s ease;
    }
    
    .settings-toggle:hover {
      background: rgba(255, 255, 255, 0.2);
      transform: rotate(90deg);
    }
    
    .settings-panel {
      position: absolute;
      top: 60px;
      right: 0;
      background: rgba(255, 255, 255, 0.1);
      backdrop-filter: blur(20px);
      border-radius: 15px;
      padding: 20px;
      border: 1px solid rgba(255, 255, 255, 0.2);
      min-width: 280px;
      display: none;
      flex-direction: column;
      gap: 15px;
      animation: slideDown 0.3s ease;
    }
    
    .settings-panel.show {
      display: flex;
    }
    
    @keyframes slideDown {
      from {
        opacity: 0;
        transform: translateY(-20px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }
    
    .panel-title {
      color: white;
      font-size: 18px;
      font-weight: 600;
      text-align: center;
      margin-bottom: 10px;
      border-bottom: 1px solid rgba(255, 255, 255, 0.2);
      padding-bottom: 10px;
    }
    
    .setting-item {
      display: flex;
      align-items: center;
      justify-content: space-between;
      color: white;
      font-size: 14px;
      padding: 8px 0;
    }
    
    .setting-label {
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .setting-toggle {
      width: 50px;
      height: 25px;
      border-radius: 15px;
      background: rgba(255, 255, 255, 0.2);
      position: relative;
      cursor: pointer;
      transition: all 0.3s ease;
    }
    
    .setting-toggle.active {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    }
    
    .toggle-slider {
      width: 21px;
      height: 21px;
      border-radius: 50%;
      background: white;
      position: absolute;
      top: 2px;
      left: 2px;
      transition: all 0.3s ease;
    }
    
    .setting-toggle.active .toggle-slider {
      transform: translateX(25px);
    }
    
    .setting-button {
      background: rgba(255, 255, 255, 0.1);
      border: 1px solid rgba(255, 255, 255, 0.2);
      color: white;
      padding: 8px 16px;
      border-radius: 8px;
      cursor: pointer;
      font-size: 12px;
      transition: all 0.3s ease;
    }
    
    .setting-button:hover {
      background: rgba(255, 255, 255, 0.2);
      transform: translateY(-2px);
    }
    
    .debug-info {
      background: rgba(0, 0, 0, 0.3);
      border-radius: 8px;
      padding: 10px;
      font-size: 12px;
      color: rgba(255, 255, 255, 0.8);
      font-family: 'Courier New', monospace;
      max-height: 150px;
      overflow-y: auto;
      white-space: pre-wrap;
    }
  </style>
</head>
<body>
  <!-- ç«ç®­é¼ æ ‡æ ·å¼ -->
  <div class="rocket-cursor" id="rocketCursor">
    <div class="rocket-nose"></div>
    <div class="rocket-body"></div>
    <div class="rocket-fins"></div>
    <div class="rocket-engine"></div>
  </div>
  
  <!-- é«˜çº§ç²’å­æ•ˆæœå®¹å™¨ -->
  <div class="particles-container">
    <canvas id="particles-canvas"></canvas>
  </div>
  
  <!-- èƒŒæ™¯æµæ˜Ÿæ•ˆæœ -->
  <div class="meteor-container"></div>
  
  <!-- æ˜Ÿå…‰ç‰¹æ•ˆ -->
  <div class="stars-container"></div>
  
  <!-- æ˜Ÿç©ºè£…é¥°å…ƒç´  -->
  <!-- è¡Œæ˜Ÿæ‚¬æµ® -->
  <div class="planet saturn"></div>
  <div class="planet jupiter"></div>
  
  <!-- æœ›è¿œé•œ -->
  <div class="telescope"></div>
  
  <!-- è§‚æ˜Ÿå°äºº -->
  <div class="stargazer"></div>
  
  <!-- æ˜Ÿåº§å›¾æ¡ˆ -->
  <div class="constellation big-dipper"></div>
  <div class="constellation orion"></div>
  
  <!-- æµæ˜Ÿç—•è¿¹ -->
  <div class="meteor-trail left"></div>
  <div class="meteor-trail right"></div>
  <div class="meteor-trail center"></div>
  
  <!-- ç©ºé—´ç«™ -->
  <div class="space-station right"></div>
  
  <!-- è¿”å›æŒ‰é’® -->
  <button class="back-btn" onclick="goBack()">
    <i class="fas fa-arrow-left"></i> è¿”å›ä¸»é¡µ
  </button>
  
  <!-- AIæ€è€ƒåŠ¨ç”» -->
  <div class="ai-thinking" id="aiThinking">
    <div class="thinking-progress">
      <div class="thinking-icon" id="thinkingIcon1">
        <i class="fas fa-broadcast-tower"></i>
      </div>
      <div class="progress-line1">
        <div class="progress-fill1" id="progressFill1"></div>
      </div>
      <div class="thinking-icon" id="thinkingIcon2">
        <i class="fas fa-satellite"></i>
      </div>
      <div class="progress-line2">
        <div class="progress-fill2" id="progressFill2"></div>
      </div>
      <div class="thinking-icon" id="thinkingIcon3">
        <i class="fa-solid fa-podcast"></i>
      </div>
    </div>
  </div>
  
  <!-- ç³»ç»Ÿè®¾ç½®é¢æ¿ -->
  <div class="system-settings">
    <div class="settings-toggle" onclick="toggleSettings()">
      <i class="fas fa-cog"></i>
    </div>
    <div class="settings-panel" id="settingsPanel">
      <div class="panel-title">
        <i class="fas fa-tools"></i> ç³»ç»Ÿè®¾ç½®
      </div>
      
      <div class="setting-item">
        <div class="setting-label">
          <i class="fas fa-volume-up"></i>
          <span>è¯­éŸ³æ’­æ”¾</span>
        </div>
        <div class="setting-toggle" onclick="toggleSetting(this, 'voice')" data-setting="voice">
          <div class="toggle-slider"></div>
        </div>
      </div>
      
      <div class="setting-item">
        <div class="setting-label">
          <i class="fas fa-microphone"></i>
          <span>è¯­è°ƒåˆ†æ</span>
        </div>
        <div class="setting-toggle active" onclick="toggleSetting(this, 'voiceAnalysis')" data-setting="voiceAnalysis">
          <div class="toggle-slider"></div>
        </div>
      </div>
      
      <div class="setting-item">
        <div class="setting-label">
          <i class="fas fa-microphone"></i>
          <span>è‡ªåŠ¨å½•éŸ³</span>
        </div>
        <div class="setting-toggle" onclick="toggleSetting(this, 'autoRecord')" data-setting="autoRecord">
          <div class="toggle-slider"></div>
        </div>
      </div>
      
      <div class="setting-item">
        <div class="setting-label">
          <i class="fas fa-camera"></i>
          <span>å¾®è¡¨æƒ…è¯†åˆ«</span>
        </div>
        <div class="setting-toggle active" onclick="toggleSetting(this, 'facialAnalysis')" data-setting="facialAnalysis">
          <div class="toggle-slider"></div>
        </div>
      </div>
      
      <div class="setting-item">
        <div class="setting-label">
          <i class="fas fa-eye"></i>
          <span>é¼ æ ‡è·Ÿéš</span>
        </div>
        <div class="setting-toggle active" onclick="toggleSetting(this, 'mouseFollow')" data-setting="mouseFollow">
          <div class="toggle-slider"></div>
        </div>
      </div>
      
      <div class="setting-item">
        <div class="setting-label">
          <i class="fas fa-rocket"></i>
          <span>ç²’å­ç‰¹æ•ˆ</span>
        </div>
        <div class="setting-toggle active" onclick="toggleSetting(this, 'particles')" data-setting="particles">
          <div class="toggle-slider"></div>
        </div>
      </div>
      
      <div class="setting-item">
        <button class="setting-button" onclick="testThinking()">
          <i class="fas fa-play"></i> æµ‹è¯•æ€è€ƒåŠ¨ç”»
        </button>
        <button class="setting-button" onclick="resetAnimation()">
          <i class="fas fa-stop"></i> é‡ç½®åŠ¨ç”»
        </button>
      </div>
      
      <div class="setting-item">
        <button class="setting-button" onclick="toggleFacialAnalysis()">
          <i class="fas fa-camera"></i> <span id="facialBtn">åœæ­¢åˆ†æ</span>
        </button>
        <button class="setting-button" onclick="toggleVoiceAnalysis()">
          <i class="fas fa-microphone"></i> <span id="voiceBtn">åœæ­¢å½•éŸ³</span>
        </button>
      </div>
      
      <div class="setting-item">
        <button class="setting-button" onclick="resetLive2D()">
          <i class="fas fa-redo"></i> é‡ç½®æ¨¡å‹
        </button>
        <button class="setting-button" onclick="toggleDebugInfo()">
          <i class="fas fa-bug"></i> è°ƒè¯•ä¿¡æ¯
        </button>
      </div>
      
      <div class="setting-item">
        <button class="setting-button" onclick="exportSettings()">
          <i class="fas fa-download"></i> å¯¼å‡ºè®¾ç½®
        </button>
      </div>
      
      <div class="debug-info" id="debugInfo" style="display: none;">
        Live2DçŠ¶æ€: æ­£å¸¸
        åŠ¨ç”»çŠ¶æ€: ç©ºé—²
        éŸ³é¢‘çŠ¶æ€: æœªåˆå§‹åŒ–
        æ€§èƒ½: 60 FPS
      </div>
    </div>
  </div>
  
  <!-- é»‘æ´è½¬åœºæ•ˆæœ -->
  <div class="blackhole-transition" id="blackholeTransition">
    <div class="blackhole-circle"></div>
    <div class="blackhole-vortex"></div>
    <div class="blackhole-streams">
      <div class="particle"></div>
      <div class="particle"></div>
      <div class="particle"></div>
      <div class="particle"></div>
      <div class="particle"></div>
      <div class="particle"></div>
      <div class="particle"></div>
      <div class="particle"></div>
      <div class="particle"></div>
      <div class="particle"></div>
      <div class="particle"></div>
      <div class="particle"></div>
      <div class="particle"></div>
      <div class="particle"></div>
      <div class="particle"></div>
      <div class="particle"></div>
      <div class="particle"></div>
      <div class="particle"></div>
      <div class="particle"></div>
      <div class="particle"></div>
      <div class="particle"></div>
      <div class="particle"></div>
      <div class="particle"></div>
      <div class="particle"></div>
      <div class="particle"></div>
      <div class="particle"></div>
      <div class="particle"></div>
      <div class="particle"></div>
      <div class="particle"></div>
      <div class="particle"></div>
    </div>
  </div>
  
  <!-- Live2D æ•°å­—äºº -->
  <canvas id="live2d"></canvas>
  
  <!-- importmap -->
  <script type="importmap">
  {
    "imports": {
      "pixi.js": "https://cdn.jsdelivr.net/npm/pixi.js/dist/pixi.min.mjs",
      "@pixi/sound": "https://cdn.jsdelivr.net/npm/@pixi/sound@6.0.1/dist/pixi-sound.mjs",
      "easy-live2d": "https://cdn.jsdelivr.net/npm/easy-live2d/dist/index.js"
    }
  }
  </script>
  
  <!-- Live2D Core -->
  <script src="/live2d/Core/live2dcubismcore.js"></script>
  
  <!-- èƒŒæ™¯ç‰¹æ•ˆè„šæœ¬ -->
  <script src="{{ url_for('static', filename='js/index.js') }}"></script>
  
  <!-- Live2D å’Œé¢è¯•é€»è¾‘ -->
  <script type="module">
    import { Application, Ticker } from 'pixi.js';
    import { Live2DSprite, Config } from 'easy-live2d'

    Config.MotionGroupIdle = 'Idle'; 
    Config.MouseFollow = false;
    const live2dSprite = new Live2DSprite();
    
    let app;
    let interviewActive = false;
    let currentQuestion = 0;
    const questions = [
      "è¯·å…ˆè‡ªæˆ‘ä»‹ç»ä¸€ä¸‹",
      "è¯´è¯´ä½ æœ€å¤§çš„ä¼˜åŠ¿æ˜¯ä»€ä¹ˆï¼Ÿ",
      "ä½ ä¸ºä»€ä¹ˆé€‰æ‹©è¿™ä¸ªèŒä½ï¼Ÿ",
      "æè¿°ä¸€ä¸‹ä½ çš„èŒä¸šè§„åˆ’",
      "ä½ å¦‚ä½•å¤„ç†å·¥ä½œä¸­çš„å‹åŠ›ï¼Ÿ"
    ];
    
    // åˆå§‹åŒ–Live2D
    async function initLive2D() {
      try {
        await live2dSprite.init({
          modelPath: '/live2d/assets/haru/haru_greeter_t05.model3.json',
          ticker: Ticker.shared
        });

        function resizeModel() {
          const canvas = document.getElementById('live2d');
          
          console.log(window.devicePixelRatio);
          
          const screenWidth = window.innerWidth * window.devicePixelRatio / 1.5;
          const screenHeight = window.innerHeight * window.devicePixelRatio / 1.5;
          
          canvas.width = screenWidth;
          canvas.height = screenHeight;
          
          live2dSprite.width = 3 * screenWidth;
          live2dSprite.height = 3 * screenHeight;
          live2dSprite.x = -0.75 * screenWidth;
          live2dSprite.y = -1.5 * screenHeight;
        }

        const canvas = document.getElementById('live2d');
        app = new Application();
        await app.init({
          view: document.getElementById('live2d'),
          backgroundAlpha: 0, 
        });
        
        window.addEventListener('resize', resizeModel);
        resizeModel();
        app.stage.addChild(live2dSprite);
        
        console.log('Live2Dæ¨¡å‹åŠ è½½æˆåŠŸ');
        updateStatus('Live2Dé¢è¯•å®˜å·²å°±ç»ª');
        
        // 3ç§’åè‡ªåŠ¨æ’­æ”¾å¤ªç©ºä¿¡æ¯ä¼ è¾“åŠ¨ç”»æ¼”ç¤º
        setTimeout(() => {
          showThinking();
        }, 3000);
        
      } catch (error) {
        console.error('Live2Dæ¨¡å‹åŠ è½½å¤±è´¥:', error);
        updateStatus('æ¨¡å‹åŠ è½½å¤±è´¥ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•');
      }
    }
    
    function updateStatus(text) {
      console.log('çŠ¶æ€æ›´æ–°:', text);
    }
    
    // åˆå§‹åŒ–é¡µé¢
    document.addEventListener('DOMContentLoaded', function() {
      // åˆå§‹åŒ–èƒŒæ™¯ç‰¹æ•ˆ
      new RocketCursorSystem();
      new ParticleSystem();
      new StarSystem();
      new MeteorSystem();
      
      // åˆå§‹åŒ–Live2D
      initLive2D();
      
      // æ·»åŠ é¼ æ ‡ç‰¹æ•ˆ
      addMouseEffects();
      
      // åˆå§‹åŒ–è®¾ç½®
      updateDebugInfo();
      
      // è‡ªåŠ¨å¯åŠ¨å¾®è¡¨æƒ…åˆ†æï¼ˆå¦‚æœè®¾ç½®ä¸ºå¼€å¯ï¼‰
      setTimeout(() => {
        if (systemSettings.facialAnalysis) {
          console.log('ğŸ¬ è‡ªåŠ¨å¯åŠ¨å¾®è¡¨æƒ…è‚¢ä½“åˆ†æ...');
          startFacialAnalysis();
        }
      }, 2000); // å»¶è¿Ÿ2ç§’å¯åŠ¨ï¼Œç¡®ä¿Live2DåŠ è½½å®Œæˆ
      
      // è‡ªåŠ¨å¯åŠ¨è¯­è°ƒåˆ†æï¼ˆå¦‚æœè®¾ç½®ä¸ºå¼€å¯ï¼‰
      setTimeout(() => {
        if (systemSettings.voiceAnalysis) {
          console.log('ğŸ¤ è‡ªåŠ¨å¯åŠ¨è¯­è°ƒåˆ†æ...');
          startVoiceAnalysis();
        }
      }, 3000); // å»¶è¿Ÿ3ç§’å¯åŠ¨ï¼Œç¡®ä¿å¾®è¡¨æƒ…åˆ†æå…ˆå¯åŠ¨
    });
    
    // é¡µé¢ç¦»å¼€æ—¶è‡ªåŠ¨åœæ­¢åˆ†æ
    window.addEventListener('beforeunload', function() {
      if (facialAnalysisRunning) {
        console.log('ğŸ›‘ é¡µé¢ç¦»å¼€ï¼Œè‡ªåŠ¨åœæ­¢å¾®è¡¨æƒ…åˆ†æ');
        // å‘é€åŒæ­¥è¯·æ±‚åœæ­¢åˆ†æ
        navigator.sendBeacon('/api/interview/stop-facial-analysis', JSON.stringify({}));
        stopAnalysisStatusMonitoring();
      }
      
      if (voiceAnalysisRunning) {
        console.log('ğŸ›‘ é¡µé¢ç¦»å¼€ï¼Œè‡ªåŠ¨åœæ­¢è¯­è°ƒåˆ†æ');
        // å‘é€åŒæ­¥è¯·æ±‚åœæ­¢åˆ†æ
        navigator.sendBeacon('/api/interview/stop-voice-analysis', JSON.stringify({}));
        stopVoiceStatusMonitoring();
      }
    });
    
    // é¡µé¢éšè—æ—¶æš‚åœåˆ†æ
    document.addEventListener('visibilitychange', function() {
      if (document.hidden) {
        console.log('â¸ï¸ é¡µé¢éšè—ï¼Œæš‚åœçŠ¶æ€ç›‘æ§');
        stopAnalysisStatusMonitoring();
        stopVoiceStatusMonitoring();
      } else {
        console.log('â–¶ï¸ é¡µé¢æ˜¾ç¤ºï¼Œæ¢å¤çŠ¶æ€ç›‘æ§');
        if (facialAnalysisRunning) {
          startAnalysisStatusMonitoring();
        }
        if (voiceAnalysisRunning) {
          startVoiceStatusMonitoring();
        }
      }
    });
    
    // æ·»åŠ é¼ æ ‡ç‰¹æ•ˆ
    function addMouseEffects() {
      const interactiveElements = document.querySelectorAll('.setting-button, .settings-toggle, .back-btn');
      
      interactiveElements.forEach(element => {
        element.addEventListener('mouseenter', function(event) {
          const wave = document.createElement('div');
          wave.className = 'rocket-wave';
          wave.style.left = event.clientX + 'px';
          wave.style.top = event.clientY + 'px';
          document.body.appendChild(wave);
          
          setTimeout(() => {
            if (document.body.contains(wave)) {
              document.body.removeChild(wave);
            }
          }, 2000);
        });
      });
    }
    
    // è¿”å›ä¸»é¡µ
    window.goBack = function() {
      const blackhole = document.getElementById('blackholeTransition');
      blackhole.style.display = 'flex';
      blackhole.classList.add('active');
      
      setTimeout(() => {
        window.location.href = '/';
      }, 1000);
    }
    
    // AIæ€è€ƒåŠ¨ç”»ç›¸å…³åŠŸèƒ½
    let thinkingAnimationTimeout;
    
    function showThinking() {
      const thinkingDiv = document.getElementById('aiThinking');
      thinkingDiv.style.display = 'flex';
      
      // é‡ç½®æ‰€æœ‰çŠ¶æ€
      resetThinkingAnimation();
      
      // é˜¶æ®µ1: æ¿€æ´»ç¬¬ä¸€ä¸ªå›¾æ ‡ï¼Œç„¶åå¡«å……ç¬¬ä¸€ä¸ªè¿›åº¦æ¡
      setTimeout(() => {
        activateThinkingIcon(1);
        setTimeout(() => {
          fillProgressBar(1);
        }, 100);
      }, 200);
      
      // é˜¶æ®µ2: æ¿€æ´»ç¬¬äºŒä¸ªå›¾æ ‡ï¼Œç„¶åå¡«å……ç¬¬äºŒä¸ªè¿›åº¦æ¡
      setTimeout(() => {
        activateThinkingIcon(2);
        setTimeout(() => {
          fillProgressBar(2);
        }, 100);
      }, 1200);
      
      // é˜¶æ®µ3: æ¿€æ´»ç¬¬ä¸‰ä¸ªå›¾æ ‡
      setTimeout(() => {
        activateThinkingIcon(3);
      }, 2200);
      
      // 3ç§’åéšè—
      thinkingAnimationTimeout = setTimeout(() => {
        hideThinking();
      }, 3000);
    }
    
    function hideThinking() {
      const thinkingDiv = document.getElementById('aiThinking');
      thinkingDiv.style.display = 'none';
      resetThinkingAnimation();
    }
    
    // é‡ç½®åŠ¨ç”»
    function resetThinkingAnimation() {
      const progressFills = document.querySelectorAll('.progress-fill1, .progress-fill2');
      progressFills.forEach(fill => {
        fill.style.width = '0%';
        fill.classList.remove('animate');
      });
      
      const icons = document.querySelectorAll('.thinking-icon');
      icons.forEach(icon => {
        icon.classList.remove('active');
      });
    }
    
    // æ¿€æ´»å›¾æ ‡
    function activateThinkingIcon(iconNumber) {
      const icon = document.getElementById(`thinkingIcon${iconNumber}`);
      if (icon) {
        icon.classList.add('active');
        console.log(`æ¿€æ´»å›¾æ ‡ ${iconNumber}: ${getIconName(iconNumber)}`);
      }
    }
    
    // å¡«å……è¿›åº¦æ¡
    function fillProgressBar(progressNumber) {
      const progressFill = document.getElementById(`progressFill${progressNumber}`);
      if (progressFill) {
        console.log(`å¼€å§‹å¡«å……è¿›åº¦æ¡ ${progressNumber}`);
        
        // ç¡®ä¿åªå¢åŠ å®½åº¦ï¼Œä¸ºæ¯ä¸ªè¿›åº¦æ¡åˆ†åˆ«æ·»åŠ åŠ¨ç”»
        if (progressNumber === 1) {
          progressFill.classList.add('animate');  // å¼€å¯åŠ¨ç”»
          progressFill.style.width = '100%';
        } 
		else if (progressNumber === 2) {
          progressFill.classList.add('animate');  // å¼€å¯åŠ¨ç”»
          progressFill.style.width = '100%';
        }
        
        console.log(`è¿›åº¦æ¡ ${progressNumber} å¼€å§‹åŠ¨ç”»åˆ° 100%`);
      }
    }
    
    function getIconName(step) {
      const names = ['ä¿¡å·å‘å°„', 'å«æ˜Ÿä¼ è¾“', 'è¯­éŸ³æ¥æ”¶'];
      return names[step - 1] || 'æœªçŸ¥';
    }
    
    // ç³»ç»Ÿè®¾ç½®é¢æ¿åŠŸèƒ½
    let settingsVisible = false;
    let systemSettings = {
      voice: false,
      voiceAnalysis: true, // è¯­è°ƒåˆ†æé»˜è®¤å¼€å¯
      autoRecord: false,
      facialAnalysis: true, // æ–°å¢å¾®è¡¨æƒ…è¯†åˆ«
      mouseFollow: true,
      particles: true
    };
    
    // å¾®è¡¨æƒ…åˆ†æç›¸å…³å˜é‡
    let facialAnalysisRunning = false;
    let analysisStatusInterval = null;
    let currentAnalysisCount = 0;
    
    // è¯­è°ƒåˆ†æç›¸å…³å˜é‡
    let voiceAnalysisRunning = false;
    let voiceStatusInterval = null;
    let isRecording = false;
    
    // åª’ä½“æµç›¸å…³å˜é‡
    let videoStream = null;
    let audioStream = null;
    let mediaRecorder = null;
    let recordedChunks = [];
    
    window.toggleSettings = function() {
      const panel = document.getElementById('settingsPanel');
      settingsVisible = !settingsVisible;
      
      if (settingsVisible) {
        panel.classList.add('show');
      } else {
        panel.classList.remove('show');
      }
    }
    
    window.toggleSetting = function(element, settingName) {
      const isActive = element.classList.contains('active');
      
      if (isActive) {
        element.classList.remove('active');
        systemSettings[settingName] = false;
      } else {
        element.classList.add('active');
        systemSettings[settingName] = true;
      }
      
      // åº”ç”¨è®¾ç½®
      applySystemSetting(settingName, systemSettings[settingName]);
      updateDebugInfo();
    }
    
    // å¾®è¡¨æƒ…åˆ†æåŠŸèƒ½
    async function startFacialAnalysis() {
      if (facialAnalysisRunning) {
        console.log('å¾®è¡¨æƒ…åˆ†æå·²åœ¨è¿è¡Œä¸­');
        return;
      }
      
      try {
        console.log('ğŸ¬ å¯åŠ¨å¾®è¡¨æƒ…è‚¢ä½“åˆ†æ...');
        
        // è¯·æ±‚æ‘„åƒå¤´æƒé™
        await requestCameraPermission();
        
        const response = await fetch('/api/interview/start-facial-analysis', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          }
        });
        
        const data = await response.json();
        
        if (data.success) {
          facialAnalysisRunning = true;
          console.log('âœ… å¾®è¡¨æƒ…åˆ†æå·²å¯åŠ¨:', data.message);
          
          // å¼€å§‹å®šæœŸæ‹ç…§åˆ†æ
          startPeriodicPhotoCapture();
          
          // å¼€å§‹å®šæœŸæ£€æŸ¥çŠ¶æ€
          startAnalysisStatusMonitoring();
          updateDebugInfo();
          updateFacialAnalysisButton();
          
          // æ˜¾ç¤ºå¯åŠ¨é€šçŸ¥
          showNotification('ğŸ“¹ å¾®è¡¨æƒ…è‚¢ä½“åˆ†æå·²å¯åŠ¨', 'success');
        } else {
          console.error('âŒ å¯åŠ¨å¤±è´¥:', data.message);
          showNotification('å¯åŠ¨å¾®è¡¨æƒ…åˆ†æå¤±è´¥: ' + data.message, 'error');
        }
      } catch (error) {
        console.error('å¾®è¡¨æƒ…åˆ†æå¯åŠ¨é”™è¯¯:', error);
        showNotification('æ‘„åƒå¤´è®¿é—®å¤±è´¥ï¼Œè¯·æ£€æŸ¥æƒé™è®¾ç½®', 'error');
      }
    }
    
    function startPeriodicPhotoCapture() {
      if (!videoStream || !facialAnalysisRunning) return;
      
      // æ¯10ç§’æ‹ç…§ä¸€æ¬¡
      const captureInterval = setInterval(async () => {
        if (!facialAnalysisRunning) {
          clearInterval(captureInterval);
          return;
        }
        
        try {
          // åˆ›å»ºcanvasæ¥æ•è·è§†é¢‘å¸§
          const canvas = document.createElement('canvas');
          const video = document.createElement('video');
          video.srcObject = videoStream;
          video.play();
          
          video.onloadedmetadata = () => {
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            
            const ctx = canvas.getContext('2d');
            ctx.drawImage(video, 0, 0);
            
            // è½¬æ¢ä¸ºblobå¹¶å‘é€åˆ°åç«¯
            canvas.toBlob(async (blob) => {
              const formData = new FormData();
              formData.append('image', blob, 'capture.jpg');
              
              try {
                const response = await fetch('/api/interview/analyze-photo', {
                  method: 'POST',
                  body: formData
                });
                
                const result = await response.json();
                if (result.success) {
                  currentAnalysisCount++;
                  console.log(`ğŸ“Š ç¬¬${currentAnalysisCount}æ¬¡åˆ†æå®Œæˆ:`, result.analysis);
                  updateDebugInfo();
                }
              } catch (error) {
                console.error('ç…§ç‰‡åˆ†æå¤±è´¥:', error);
              }
            }, 'image/jpeg', 0.8);
          };
        } catch (error) {
          console.error('æ‹ç…§å¤±è´¥:', error);
        }
      }, 10000); // 10ç§’é—´éš”
    }
    
    async function stopFacialAnalysis() {
      if (!facialAnalysisRunning) {
        console.log('å¾®è¡¨æƒ…åˆ†ææœªåœ¨è¿è¡Œ');
        return;
      }
      
      try {
        console.log('ğŸ›‘ åœæ­¢å¾®è¡¨æƒ…è‚¢ä½“åˆ†æ...');
        
        const response = await fetch('/api/interview/stop-facial-analysis', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          }
        });
        
        const data = await response.json();
        
        if (data.success) {
          facialAnalysisRunning = false;
          stopAnalysisStatusMonitoring();
          
          // åœæ­¢æ‘„åƒå¤´æµ
          if (videoStream) {
            videoStream.getTracks().forEach(track => track.stop());
            videoStream = null;
          }
          
          console.log('âœ… å¾®è¡¨æƒ…åˆ†æå·²åœæ­¢:', data.message);
          console.log('ğŸ“Š åˆ†ææ€»ç»“:', data.summary);
          
          updateDebugInfo();
          updateFacialAnalysisButton();
          
          // æ˜¾ç¤ºåœæ­¢é€šçŸ¥å’Œç»“æœæ‘˜è¦
          if (data.summary) {
            const avgScore = data.summary.overall_score || 0;
            showNotification(`ğŸ“¹ åˆ†æå®Œæˆï¼ç»¼åˆå¾—åˆ†: ${avgScore}/10`, 'success');
          } else {
            showNotification('ğŸ“¹ å¾®è¡¨æƒ…åˆ†æå·²åœæ­¢', 'success');
          }
        } else {
          console.error('âŒ åœæ­¢å¤±è´¥:', data.message);
          showNotification('åœæ­¢åˆ†æå¤±è´¥: ' + data.message, 'error');
        }
      } catch (error) {
        console.error('åœæ­¢å¾®è¡¨æƒ…åˆ†æé”™è¯¯:', error);
        showNotification('åœæ­¢åˆ†ææ—¶å‘ç”Ÿé”™è¯¯', 'error');
      }
    }
    
    async function requestCameraPermission() {
      try {
        videoStream = await navigator.mediaDevices.getUserMedia({ 
          video: { width: 640, height: 480 },
          audio: false 
        });
        
        console.log('âœ… æ‘„åƒå¤´æƒé™å·²è·å–ï¼Œè§†é¢‘æµå·²å¯åŠ¨');
        return true;
      } catch (error) {
        console.error('âŒ æ‘„åƒå¤´æƒé™è·å–å¤±è´¥:', error);
        throw new Error('æ— æ³•è®¿é—®æ‘„åƒå¤´ï¼Œè¯·æ£€æŸ¥æµè§ˆå™¨æƒé™è®¾ç½®');
      }
    }
    
    function startAnalysisStatusMonitoring() {
      // æ¯5ç§’æ£€æŸ¥ä¸€æ¬¡åˆ†æçŠ¶æ€
      analysisStatusInterval = setInterval(async () => {
        try {
          const response = await fetch('/api/interview/facial-analysis-status');
          const data = await response.json();
          
          if (data.success) {
            facialAnalysisRunning = data.is_running;
            currentAnalysisCount = data.analysis_count;
            
            // å¦‚æœåˆ†ææ„å¤–åœæ­¢ï¼Œæ›´æ–°çŠ¶æ€
            if (!data.is_running && facialAnalysisRunning) {
              facialAnalysisRunning = false;
              stopAnalysisStatusMonitoring();
              showNotification('å¾®è¡¨æƒ…åˆ†æå·²è‡ªåŠ¨åœæ­¢', 'info');
            }
            
            updateDebugInfo();
          }
        } catch (error) {
          console.error('çŠ¶æ€ç›‘æ§é”™è¯¯:', error);
        }
      }, 5000);
    }
    
    function stopAnalysisStatusMonitoring() {
      if (analysisStatusInterval) {
        clearInterval(analysisStatusInterval);
        analysisStatusInterval = null;
      }
    }
    
    // è¯­è°ƒåˆ†æåŠŸèƒ½
    async function startVoiceAnalysis() {
      if (voiceAnalysisRunning) {
        console.log('è¯­è°ƒåˆ†æå·²åœ¨è¿è¡Œä¸­');
        return;
      }
      
      try {
        console.log('ğŸ¤ å¯åŠ¨è¯­è°ƒåˆ†æ...');
        
        // è¯·æ±‚éº¦å…‹é£æƒé™
        await requestMicrophonePermission();
        
        const response = await fetch('/api/interview/start-voice-analysis', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          }
        });
        
        const data = await response.json();
        
        if (data.success) {
          voiceAnalysisRunning = true;
          console.log('âœ… è¯­è°ƒåˆ†æå·²å¯åŠ¨:', data.message);
          
          // å¼€å§‹æµè§ˆå™¨ç«¯å½•éŸ³
          startBrowserRecording();
          
          // å¼€å§‹å®šæœŸæ£€æŸ¥çŠ¶æ€
          startVoiceStatusMonitoring();
          updateDebugInfo();
          updateVoiceAnalysisButton();
          
          // æ˜¾ç¤ºå¯åŠ¨é€šçŸ¥
          showNotification('ğŸ¤ è¯­è°ƒåˆ†æå·²å¯åŠ¨', 'success');
        } else {
          console.error('âŒ å¯åŠ¨å¤±è´¥:', data.message);
          showNotification('å¯åŠ¨è¯­è°ƒåˆ†æå¤±è´¥: ' + data.message, 'error');
        }
      } catch (error) {
        console.error('è¯­è°ƒåˆ†æå¯åŠ¨é”™è¯¯:', error);
        showNotification('éº¦å…‹é£è®¿é—®å¤±è´¥ï¼Œè¯·æ£€æŸ¥æƒé™è®¾ç½®', 'error');
      }
    }
    
    function startBrowserRecording() {
      if (!audioStream || !voiceAnalysisRunning) return;
      
      try {
        recordedChunks = [];
        
        // ä½¿ç”¨MediaRecorderå½•éŸ³
        mediaRecorder = new MediaRecorder(audioStream, {
          mimeType: 'audio/webm;codecs=opus'
        });
        
        mediaRecorder.ondataavailable = (event) => {
          if (event.data.size > 0) {
            recordedChunks.push(event.data);
          }
        };
        
        mediaRecorder.onstop = async () => {
          // å½•éŸ³ç»“æŸï¼Œå‘é€åˆ°åç«¯åˆ†æ
          if (recordedChunks.length > 0) {
            const audioBlob = new Blob(recordedChunks, { type: 'audio/webm' });
            await sendAudioForAnalysis(audioBlob);
          }
        };
        
        // å¼€å§‹å½•éŸ³
        mediaRecorder.start(1000); // æ¯ç§’ä¿å­˜ä¸€æ¬¡æ•°æ®
        isRecording = true;
        console.log('ğŸ¤ æµè§ˆå™¨å½•éŸ³å·²å¼€å§‹');
        
      } catch (error) {
        console.error('å½•éŸ³å¯åŠ¨å¤±è´¥:', error);
        showNotification('å½•éŸ³å¯åŠ¨å¤±è´¥', 'error');
      }
    }
    
    async function sendAudioForAnalysis(audioBlob) {
      try {
        const formData = new FormData();
        formData.append('audio', audioBlob, 'recording.webm');
        
        const response = await fetch('/api/interview/analyze-audio', {
          method: 'POST',
          body: formData
        });
        
        const result = await response.json();
        if (result.success) {
          console.log('ğŸµ è¯­è°ƒåˆ†æå®Œæˆ:', result.analysis);
          
          // ä¿å­˜åˆ†æç»“æœ
          if (result.analysis) {
            const saveResponse = await fetch('/api/interview/save-voice-analysis', {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json'
              },
              body: JSON.stringify({ analysis: result.analysis })
            });
            
            if (saveResponse.ok) {
              console.log('âœ… è¯­è°ƒåˆ†æç»“æœå·²ä¿å­˜');
            }
          }
        }
      } catch (error) {
        console.error('éŸ³é¢‘åˆ†æå¤±è´¥:', error);
      }
    }
    
    async function stopVoiceAnalysis() {
      if (!voiceAnalysisRunning) {
        console.log('è¯­è°ƒåˆ†ææœªåœ¨è¿è¡Œ');
        return;
      }
      
      try {
        console.log('ğŸ›‘ åœæ­¢è¯­è°ƒåˆ†æ...');
        
        const response = await fetch('/api/interview/stop-voice-analysis', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          }
        });
        
        const data = await response.json();
        
        if (data.success) {
          voiceAnalysisRunning = false;
          isRecording = false;
          stopVoiceStatusMonitoring();
          
          // åœæ­¢å½•éŸ³
          if (mediaRecorder && mediaRecorder.state !== 'inactive') {
            mediaRecorder.stop();
          }
          
          // åœæ­¢éº¦å…‹é£æµ
          if (audioStream) {
            audioStream.getTracks().forEach(track => track.stop());
            audioStream = null;
          }
          
          console.log('âœ… è¯­è°ƒåˆ†æå·²åœæ­¢:', data.message);
          console.log('ğŸ“Š åˆ†æç»“æœ:', data.result);
          
          updateDebugInfo();
          updateVoiceAnalysisButton();
          
          // æ˜¾ç¤ºåœæ­¢é€šçŸ¥å’Œç»“æœæ‘˜è¦
          if (data.result && data.result.analysis_info) {
            const overallScore = data.result.analysis_info.overall_score || 0;
            showNotification(`ğŸ¤ è¯­è°ƒåˆ†æå®Œæˆï¼ç»¼åˆå¾—åˆ†: ${overallScore.toFixed(2)}/1`, 'success');
          } else {
            showNotification('ğŸ¤ è¯­è°ƒåˆ†æå·²åœæ­¢', 'success');
          }
        } else {
          console.error('âŒ åœæ­¢å¤±è´¥:', data.message);
          showNotification('åœæ­¢è¯­è°ƒåˆ†æå¤±è´¥: ' + data.message, 'error');
        }
      } catch (error) {
        console.error('åœæ­¢è¯­è°ƒåˆ†æé”™è¯¯:', error);
        showNotification('åœæ­¢åˆ†ææ—¶å‘ç”Ÿé”™è¯¯', 'error');
      }
    }
    
    async function requestMicrophonePermission() {
      try {
        audioStream = await navigator.mediaDevices.getUserMedia({ 
          audio: { 
            sampleRate: 44100,
            channelCount: 1,
            echoCancellation: true,
            noiseSuppression: true 
          }
        });
        
        console.log('âœ… éº¦å…‹é£æƒé™å·²è·å–ï¼ŒéŸ³é¢‘æµå·²å¯åŠ¨');
        return true;
      } catch (error) {
        console.error('âŒ éº¦å…‹é£æƒé™è·å–å¤±è´¥:', error);
        throw new Error('æ— æ³•è®¿é—®éº¦å…‹é£ï¼Œè¯·æ£€æŸ¥æµè§ˆå™¨æƒé™è®¾ç½®');
      }
    }
    
    function startVoiceStatusMonitoring() {
      // æ¯5ç§’æ£€æŸ¥ä¸€æ¬¡åˆ†æçŠ¶æ€
      voiceStatusInterval = setInterval(async () => {
        try {
          const response = await fetch('/api/interview/voice-analysis-status');
          const data = await response.json();
          
          if (data.success) {
            voiceAnalysisRunning = data.is_running;
            isRecording = data.is_recording;
            
            // å¦‚æœåˆ†ææ„å¤–åœæ­¢ï¼Œæ›´æ–°çŠ¶æ€
            if (!data.is_running && voiceAnalysisRunning) {
              voiceAnalysisRunning = false;
              isRecording = false;
              stopVoiceStatusMonitoring();
              showNotification('è¯­è°ƒåˆ†æå·²è‡ªåŠ¨åœæ­¢', 'info');
            }
            
            updateDebugInfo();
          }
        } catch (error) {
          console.error('è¯­è°ƒçŠ¶æ€ç›‘æ§é”™è¯¯:', error);
        }
      }, 5000);
    }
    
    function stopVoiceStatusMonitoring() {
      if (voiceStatusInterval) {
        clearInterval(voiceStatusInterval);
        voiceStatusInterval = null;
      }
    }
    
    function showNotification(message, type = 'info') {
      // åˆ›å»ºé€šçŸ¥å…ƒç´ 
      const notification = document.createElement('div');
      notification.className = `notification ${type}`;
      notification.style.cssText = `
        position: fixed;
        top: 80px;
        right: 20px;
        background: ${type === 'success' ? 'rgba(76, 175, 80, 0.9)' : 
                     type === 'error' ? 'rgba(244, 67, 54, 0.9)' : 
                     'rgba(33, 150, 243, 0.9)'};
        color: white;
        padding: 12px 20px;
        border-radius: 8px;
        z-index: 1001;
        backdrop-filter: blur(10px);
        box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        animation: slideIn 0.3s ease;
        max-width: 300px;
        word-wrap: break-word;
      `;
      notification.textContent = message;
      
      // æ·»åŠ åˆ°é¡µé¢
      document.body.appendChild(notification);
      
      // 3ç§’åè‡ªåŠ¨ç§»é™¤
      setTimeout(() => {
        if (document.body.contains(notification)) {
          notification.style.animation = 'slideOut 0.3s ease';
          setTimeout(() => {
            if (document.body.contains(notification)) {
              document.body.removeChild(notification);
            }
          }, 300);
        }
      }, 3000);
    }
    
    function applySystemSetting(settingName, value) {
      switch (settingName) {
        case 'mouseFollow':
          if (window.Config && live2dSprite) {
            window.Config.MouseFollow = value;
          }
          break;
        case 'particles':
          const particlesCanvas = document.getElementById('particles-canvas');
          if (particlesCanvas) {
            particlesCanvas.style.display = value ? 'block' : 'none';
          }
          break;
        case 'voice':
          console.log('è¯­éŸ³æ’­æ”¾:', value ? 'å¼€å¯' : 'å…³é—­');
          break;
        case 'voiceAnalysis':
          console.log('è¯­è°ƒåˆ†æ:', value ? 'å¼€å¯' : 'å…³é—­');
          if (value && !voiceAnalysisRunning) {
            // å¦‚æœå¼€å¯ä¸”æœªè¿è¡Œï¼Œåˆ™å¯åŠ¨
            startVoiceAnalysis();
          } else if (!value && voiceAnalysisRunning) {
            // å¦‚æœå…³é—­ä¸”æ­£åœ¨è¿è¡Œï¼Œåˆ™åœæ­¢
            stopVoiceAnalysis();
          }
          break;
        case 'autoRecord':
          console.log('è‡ªåŠ¨å½•éŸ³:', value ? 'å¼€å¯' : 'å…³é—­');
          break;
        case 'facialAnalysis':
          console.log('å¾®è¡¨æƒ…è¯†åˆ«:', value ? 'å¼€å¯' : 'å…³é—­');
          if (value && !facialAnalysisRunning) {
            // å¦‚æœå¼€å¯ä¸”æœªè¿è¡Œï¼Œåˆ™å¯åŠ¨
            startFacialAnalysis();
          } else if (!value && facialAnalysisRunning) {
            // å¦‚æœå…³é—­ä¸”æ­£åœ¨è¿è¡Œï¼Œåˆ™åœæ­¢
            stopFacialAnalysis();
          }
          break;
      }
    }
    
    window.testThinking = function() {
      showThinking();
    }
    
    window.resetAnimation = function() {
      // æ¸…é™¤ç°æœ‰çš„è¶…æ—¶
      if (thinkingAnimationTimeout) {
        clearTimeout(thinkingAnimationTimeout);
      }
      
      // éšè—åŠ¨ç”»å¹¶é‡ç½®
      hideThinking();
      console.log('å¤ªç©ºä¿¡æ¯ä¼ è¾“åŠ¨ç”»å·²é‡ç½®');
    }
    
    window.toggleFacialAnalysis = function() {
      const facialBtn = document.getElementById('facialBtn');
      
      if (facialAnalysisRunning) {
        stopFacialAnalysis();
        facialBtn.textContent = 'å¼€å§‹åˆ†æ';
      } else {
        startFacialAnalysis();
        facialBtn.textContent = 'åœæ­¢åˆ†æ';
      }
    }
    
    window.toggleVoiceAnalysis = function() {
      const voiceBtn = document.getElementById('voiceBtn');
      
      if (voiceAnalysisRunning) {
        stopVoiceAnalysis();
        voiceBtn.textContent = 'å¼€å§‹å½•éŸ³';
      } else {
        startVoiceAnalysis();
        voiceBtn.textContent = 'åœæ­¢å½•éŸ³';
      }
    }
    
    // æ›´æ–°æŒ‰é’®æ–‡æœ¬çš„å‡½æ•°
    function updateFacialAnalysisButton() {
      const facialBtn = document.getElementById('facialBtn');
      if (facialBtn) {
        facialBtn.textContent = facialAnalysisRunning ? 'åœæ­¢åˆ†æ' : 'å¼€å§‹åˆ†æ';
      }
    }
    
    function updateVoiceAnalysisButton() {
      const voiceBtn = document.getElementById('voiceBtn');
      if (voiceBtn) {
        voiceBtn.textContent = voiceAnalysisRunning ? 'åœæ­¢å½•éŸ³' : 'å¼€å§‹å½•éŸ³';
      }
    }
    
    window.resetLive2D = function() {
      if (live2dSprite && app) {
        // é‡ç½®Live2Dæ¨¡å‹ä½ç½®
        const canvas = document.getElementById('live2d');
        const screenWidth = window.innerWidth * window.devicePixelRatio / 1.5;
        const screenHeight = window.innerHeight * window.devicePixelRatio / 1.5;
        
        live2dSprite.width = 3 * screenWidth;
        live2dSprite.height = 3 * screenHeight;
        live2dSprite.x = -0.75 * screenWidth;
        live2dSprite.y = -1.5 * screenHeight;
        
        updateDebugInfo();
        console.log('Live2Dæ¨¡å‹å·²é‡ç½®');
      }
    }
    
    window.toggleDebugInfo = function() {
      const debugInfo = document.getElementById('debugInfo');
      const isVisible = debugInfo.style.display !== 'none';
      
      if (isVisible) {
        debugInfo.style.display = 'none';
      } else {
        debugInfo.style.display = 'block';
        updateDebugInfo();
      }
    }
    
    function updateDebugInfo() {
      const debugInfo = document.getElementById('debugInfo');
      const timestamp = new Date().toLocaleTimeString();
      
      let info = `æ›´æ–°æ—¶é—´: ${timestamp}\n`;
      info += `Live2DçŠ¶æ€: ${live2dSprite ? 'æ­£å¸¸' : 'æœªåŠ è½½'}\n`;
      info += `åŠ¨ç”»çŠ¶æ€: å¤ªç©ºä¿¡æ¯ä¼ è¾“\n`;
      info += `éŸ³é¢‘çŠ¶æ€: ${systemSettings.voice ? 'å·²å¯ç”¨' : 'æœªå¯ç”¨'}\n`;
      info += `é¼ æ ‡è·Ÿéš: ${systemSettings.mouseFollow ? 'å¼€å¯' : 'å…³é—­'}\n`;
      info += `ç²’å­ç‰¹æ•ˆ: ${systemSettings.particles ? 'å¼€å¯' : 'å…³é—­'}\n`;
      info += `å¾®è¡¨æƒ…è¯†åˆ«: ${systemSettings.facialAnalysis ? 'å¼€å¯' : 'å…³é—­'}\n`;
      info += `åˆ†æçŠ¶æ€: ${facialAnalysisRunning ? 'è¿è¡Œä¸­' : 'å·²åœæ­¢'}\n`;
      info += `åˆ†ææ¬¡æ•°: ${currentAnalysisCount}\n`;
      info += `è¯­è°ƒåˆ†æ: ${systemSettings.voiceAnalysis ? 'å¼€å¯' : 'å…³é—­'}\n`;
      info += `å½•éŸ³çŠ¶æ€: ${voiceAnalysisRunning ? (isRecording ? 'å½•éŸ³ä¸­' : 'å‡†å¤‡ä¸­') : 'å·²åœæ­¢'}\n`;
      info += `å±å¹•å°ºå¯¸: ${window.innerWidth}x${window.innerHeight}\n`;
      info += `è®¾å¤‡åƒç´ æ¯”: ${window.devicePixelRatio}\n`;
      info += `ä¼ è¾“åŠ¨ç”»: ä¿¡å·â†’å«æ˜Ÿâ†’è¯­éŸ³`;
      
      debugInfo.textContent = info;
    }
    
    window.exportSettings = function() {
      const settings = {
        systemSettings: systemSettings,
        timestamp: new Date().toISOString(),
        userAgent: navigator.userAgent,
        screenSize: {
          width: window.innerWidth,
          height: window.innerHeight,
          devicePixelRatio: window.devicePixelRatio
        }
      };
      
      const dataStr = JSON.stringify(settings, null, 2);
      const dataBlob = new Blob([dataStr], {type: 'application/json'});
      const url = URL.createObjectURL(dataBlob);
      
      const link = document.createElement('a');
      link.href = url;
      link.download = 'live2d_settings.json';
      link.click();
      
      URL.revokeObjectURL(url);
      console.log('è®¾ç½®å·²å¯¼å‡º');
    }
    
    // ç‚¹å‡»å¤–éƒ¨å…³é—­è®¾ç½®é¢æ¿
    document.addEventListener('click', function(event) {
      const settingsPanel = document.getElementById('settingsPanel');
      const settingsToggle = document.querySelector('.settings-toggle');
      
      if (settingsVisible && 
          !settingsPanel.contains(event.target) && 
          !settingsToggle.contains(event.target)) {
        toggleSettings();
      }
    });
  </script>
</body>
</html>