<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>简历智能分析 - AI面试助手</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/index.css') }}">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- 添加marked.js库用于markdown渲染 -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <style>
        .resume-container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 40px 20px;
        }
        
        .upload-section {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(20px);
            border-radius: 20px;
            padding: 40px;
            margin-bottom: 30px;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .file-upload {
            border: 2px dashed rgba(255, 255, 255, 0.3);
            border-radius: 15px;
            padding: 40px;
            text-align: center;
            transition: all 0.3s ease;
            cursor: pointer;
        }
        
        .file-upload:hover {
            border-color: rgba(102, 126, 234, 0.6);
            background: rgba(102, 126, 234, 0.1);
        }
        
        .file-upload input[type="file"] {
            display: none;
        }
        
        .upload-icon {
            font-size: 48px;
            color: rgba(255, 255, 255, 0.6);
            margin-bottom: 20px;
        }
        
        .upload-text {
            color: rgba(255, 255, 255, 0.8);
            font-size: 18px;
            margin-bottom: 10px;
        }
        
        .upload-hint {
            color: rgba(255, 255, 255, 0.5);
            font-size: 14px;
        }
        
        .analysis-section {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(20px);
            border-radius: 20px;
            padding: 40px;
            margin-bottom: 30px;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .comparison-container {
            display: flex;
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .comparison-panel {
            flex: 1;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 15px;
            padding: 30px;
            max-height: 600px;
            overflow-y: auto;
        }
        
        .panel-header {
            color: rgba(255, 255, 255, 0.8);
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .evaluation-section {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 15px;
            padding: 30px;
            margin-bottom: 30px;
        }
        
        .evaluation-header {
            color: rgba(255, 255, 255, 0.8);
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .content-area {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 15px;
            padding: 30px;
            margin-top: 20px;
            max-height: 500px;
            overflow-y: auto;
            white-space: pre-wrap;
            line-height: 1.6;
            font-family: 'Courier New', monospace;
            color: #e0e0e0;
        }
        
        .highlighted-content {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 15px;
            padding: 30px;
            margin-top: 20px;
            max-height: 500px;
            overflow-y: auto;
            line-height: 1.6;
            font-size: 14px;
            color: #e0e0e0;
        }
        
        /* 高亮样式优化 */
        .highlighted-content span[style*="background-color"] {
            border-radius: 4px !important;
            font-weight: bold !important;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1) !important;
            display: inline-block !important;
            margin: 1px 2px !important;
            transition: all 0.3s ease !important;
        }
        
        .highlighted-content span[style*="background-color"]:hover {
            transform: translateY(-1px) !important;
            box-shadow: 0 4px 8px rgba(0,0,0,0.15) !important;
        }
        
        .highlighted-content div[style*="background-color"] {
            border-radius: 6px !important;
            box-shadow: 0 3px 6px rgba(0,0,0,0.15) !important;
            margin: 4px 0 !important;
            font-weight: 500 !important;
            transition: all 0.3s ease !important;
        }
        
        .highlighted-content div[style*="background-color"]:hover {
            transform: translateY(-2px) !important;
            box-shadow: 0 6px 12px rgba(0,0,0,0.2) !important;
        }
        
        /* Markdown样式支持 */
        .highlighted-content h1,
        .highlighted-content h2,
        .highlighted-content h3,
        .highlighted-content h4,
        .highlighted-content h5,
        .highlighted-content h6 {
            color: #667eea;
            margin-top: 20px;
            margin-bottom: 10px;
            font-weight: 600;
        }
        
        .highlighted-content h1 {
            font-size: 1.8rem;
            border-bottom: 2px solid rgba(102, 126, 234, 0.3);
            padding-bottom: 5px;
        }
        
        .highlighted-content h2 {
            font-size: 1.5rem;
            border-bottom: 1px solid rgba(102, 126, 234, 0.2);
            padding-bottom: 3px;
        }
        
        .highlighted-content h3 {
            font-size: 1.3rem;
        }
        
        .highlighted-content p {
            margin-bottom: 15px;
            line-height: 1.7;
        }
        
        .highlighted-content ul,
        .highlighted-content ol {
            margin-bottom: 15px;
            padding-left: 20px;
        }
        
        .highlighted-content li {
            margin-bottom: 5px;
        }
        
        .highlighted-content blockquote {
            border-left: 4px solid #667eea;
            padding-left: 15px;
            margin: 15px 0;
            background: rgba(102, 126, 234, 0.1);
            padding: 10px 15px;
            border-radius: 5px;
            font-style: italic;
        }
        
        .highlighted-content code {
            background: rgba(102, 126, 234, 0.2);
            padding: 2px 6px;
            border-radius: 3px;
            font-family: 'Courier New', monospace;
            color: #e0e0e0;
        }
        
        .highlighted-content pre {
            background: rgba(0, 0, 0, 0.3);
            padding: 15px;
            border-radius: 8px;
            overflow-x: auto;
            margin: 15px 0;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .highlighted-content pre code {
            background: none;
            padding: 0;
            color: #e0e0e0;
        }
        
        .highlighted-content strong {
            color: #667eea;
            font-weight: 600;
        }
        
        .highlighted-content em {
            color: rgba(255, 255, 255, 0.8);
            font-style: italic;
        }
        
        .highlighted-content a {
            color: #667eea;
            text-decoration: none;
            border-bottom: 1px solid rgba(102, 126, 234, 0.3);
        }
        
        .highlighted-content a:hover {
            border-bottom-color: #667eea;
        }
        
        .highlighted-content table {
            width: 100%;
            border-collapse: collapse;
            margin: 15px 0;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 8px;
            overflow: hidden;
        }
        
        .highlighted-content th,
        .highlighted-content td {
            padding: 10px;
            text-align: left;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .highlighted-content th {
            background: rgba(102, 126, 234, 0.2);
            color: #667eea;
            font-weight: 600;
        }
        
        .highlighted-content tr:hover {
            background: rgba(255, 255, 255, 0.05);
        }
        
        /* Markdown渲染样式 */
        .content-area.markdown {
            white-space: normal;
            font-family: 'Inter', sans-serif;
        }
        
        .content-area.markdown h1,
        .content-area.markdown h2,
        .content-area.markdown h3,
        .content-area.markdown h4,
        .content-area.markdown h5,
        .content-area.markdown h6 {
            color: #667eea;
            margin-top: 20px;
            margin-bottom: 10px;
        }
        
        .content-area.markdown h1 {
            font-size: 1.8rem;
            border-bottom: 2px solid rgba(102, 126, 234, 0.3);
            padding-bottom: 5px;
        }
        
        .content-area.markdown h2 {
            font-size: 1.5rem;
            border-bottom: 1px solid rgba(102, 126, 234, 0.2);
            padding-bottom: 3px;
        }
        
        .content-area.markdown h3 {
            font-size: 1.3rem;
        }
        
        .content-area.markdown p {
            margin-bottom: 15px;
            line-height: 1.7;
        }
        
        .content-area.markdown ul,
        .content-area.markdown ol {
            margin-bottom: 15px;
            padding-left: 20px;
        }
        
        .content-area.markdown li {
            margin-bottom: 5px;
        }
        
        .content-area.markdown blockquote {
            border-left: 4px solid #667eea;
            padding-left: 15px;
            margin: 15px 0;
            background: rgba(102, 126, 234, 0.1);
            padding: 10px 15px;
            border-radius: 5px;
        }
        
        .content-area.markdown code {
            background: rgba(102, 126, 234, 0.2);
            padding: 2px 6px;
            border-radius: 3px;
            font-family: 'Courier New', monospace;
            color: #e0e0e0;
        }
        
        .content-area.markdown pre {
            background: rgba(0, 0, 0, 0.3);
            padding: 15px;
            border-radius: 8px;
            overflow-x: auto;
            margin: 15px 0;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .content-area.markdown pre code {
            background: none;
            padding: 0;
            color: #e0e0e0;
        }
        
        .content-area.markdown strong {
            color: #667eea;
            font-weight: 600;
        }
        
        .content-area.markdown em {
            color: rgba(255, 255, 255, 0.8);
            font-style: italic;
        }
        
        .content-area.markdown a {
            color: #667eea;
            text-decoration: none;
            border-bottom: 1px solid rgba(102, 126, 234, 0.3);
        }
        
        .content-area.markdown a:hover {
            border-bottom-color: #667eea;
        }
        
        .content-area.markdown table {
            width: 100%;
            border-collapse: collapse;
            margin: 15px 0;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 8px;
            overflow: hidden;
        }
        
        .content-area.markdown th,
        .content-area.markdown td {
            padding: 10px;
            text-align: left;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .content-area.markdown th {
            background: rgba(102, 126, 234, 0.2);
            color: #667eea;
            font-weight: 600;
        }
        
        .content-area.markdown tr:hover {
            background: rgba(255, 255, 255, 0.05);
        }
        
        .typing-cursor {
            display: inline-block;
            width: 2px;
            height: 1.2em;
            background-color: #667eea;
            animation: blink 1s infinite;
            margin-left: 2px;
        }
        
        @keyframes blink {
            0%, 50% { opacity: 1; }
            51%, 100% { opacity: 0; }
        }
        
        .loading {
            display: none;
            text-align: center;
            padding: 40px;
        }
        
        .spinner {
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .progress-indicator {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-bottom: 20px;
        }
        
        .progress-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background-color: #667eea;
            animation: pulse 1.5s infinite;
        }
        
        .progress-dot:nth-child(2) {
            animation-delay: 0.2s;
        }
        
        .progress-dot:nth-child(3) {
            animation-delay: 0.4s;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.5; transform: scale(1.2); }
        }
        
        .file-info {
            background: rgba(102, 126, 234, 0.1);
            border-radius: 8px;
            padding: 15px;
            margin-top: 15px;
            border-left: 4px solid #667eea;
        }
        
        .error-message {
            background: rgba(255, 0, 0, 0.1);
            border: 1px solid rgba(255, 0, 0, 0.3);
            border-radius: 8px;
            padding: 15px;
            margin-top: 15px;
            color: #ff6b6b;
        }
        
        .success-message {
            background: rgba(0, 255, 0, 0.1);
            border: 1px solid rgba(0, 255, 0, 0.3);
            border-radius: 8px;
            padding: 15px;
            margin-top: 15px;
            color: #51cf66;
        }
        
        .action-buttons {
            text-align: center;
            margin-top: 30px;
        }
        
        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
            border-radius: 25px;
            padding: 12px 30px;
            font-weight: 600;
            color: white;
            margin: 0 10px;
            transition: all 0.3s ease;
            cursor: pointer;
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }
        
        .btn-secondary {
            background: linear-gradient(135deg, #6c757d 0%, #495057 100%);
        }
        
        .btn-secondary:hover {
            box-shadow: 0 5px 15px rgba(108, 117, 125, 0.4);
        }
        
        /* 确保内容在背景特效之上 */
        .resume-container {
            position: relative;
            z-index: 10;
        }
        
        .upload-section,
        .analysis-section {
            position: relative;
            z-index: 11;
        }
        
        /* 确保鼠标特效正常工作 */
        .back-button {
            position: fixed;
            z-index: 100;
        }
        
        /* 返回按钮样式 */
        .back-button {
            position: fixed;
            top: 20px;
            left: 20px;
            padding: 12px 20px;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 25px;
            color: white;
            text-decoration: none;
            backdrop-filter: blur(10px);
            transition: all 0.3s ease;
            font-weight: 500;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 8px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }
        
        .back-button:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.15);
            border-color: rgba(255, 255, 255, 0.3);
            color: white;
            text-decoration: none;
        }
        
        .back-button:active {
            transform: translateY(0);
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }
        
        .back-button i {
            font-size: 16px;
            transition: transform 0.3s ease;
        }
        
        .back-button:hover i {
            transform: translateX(-3px);
        }
    </style>
</head>
<body>
    <!-- 火箭鼠标样式 -->
    <div class="rocket-cursor" id="rocketCursor">
        <div class="rocket-nose"></div>
        <div class="rocket-body"></div>
        <div class="rocket-fins"></div>
        <div class="rocket-engine"></div>
    </div>
    
    <!-- 返回按钮 -->
    <a href="/" class="back-button" onclick="triggerReturnTransition()">
        <i class="fas fa-arrow-left"></i> 返回首页
    </a>
    
    <!-- 高级粒子效果容器 -->
    <div class="particles-container">
        <canvas id="particles-canvas"></canvas>
    </div>
    
    <!-- 背景流星效果 -->
    <div class="meteor-container"></div>
    
    <!-- 星光特效 -->
    <div class="stars-container"></div>
    
    <!-- 星空装饰元素 -->
    <!-- 行星悬浮 -->
    <div class="planet saturn"></div>
    <div class="planet jupiter"></div>
    
    <!-- 望远镜 -->
    <div class="telescope"></div>
    
    <!-- 观星小人 -->
    <div class="stargazer"></div>
    
    <!-- 星座图案 -->
    <div class="constellation big-dipper"></div>
    <div class="constellation orion"></div>
    
    <!-- 流星痕迹 -->
    <div class="meteor-trail left"></div>
    <div class="meteor-trail right"></div>
    <div class="meteor-trail center"></div>
    
    <!-- 空间站 -->
    <div class="space-station right"></div>
    
    <!-- 黑洞转场效果 -->
    <div class="blackhole-transition" id="blackholeTransition">
        <div class="blackhole-circle"></div>
        <div class="blackhole-vortex"></div>
        <div class="blackhole-streams">
            <div class="particle"></div>
            <div class="particle"></div>
            <div class="particle"></div>
            <div class="particle"></div>
            <div class="particle"></div>
            <div class="particle"></div>
            <div class="particle"></div>
            <div class="particle"></div>
            <div class="particle"></div>
            <div class="particle"></div>
            <div class="particle"></div>
            <div class="particle"></div>
            <div class="particle"></div>
            <div class="particle"></div>
            <div class="particle"></div>
            <div class="particle"></div>
            <div class="particle"></div>
            <div class="particle"></div>
            <div class="particle"></div>
            <div class="particle"></div>
            <div class="particle"></div>
            <div class="particle"></div>
            <div class="particle"></div>
            <div class="particle"></div>
            <div class="particle"></div>
            <div class="particle"></div>
            <div class="particle"></div>
            <div class="particle"></div>
            <div class="particle"></div>
            <div class="particle"></div>
            <div class="particle"></div>
        </div>
    </div>
    
    <div class="resume-container">
        <h1 style="text-align: center; margin-bottom: 40px; color: white;">
            <i class="fas fa-file-alt"></i> 智能简历修改
        </h1>
        
        <!-- 文件上传区域 -->
        <div class="upload-section">
            <h2><i class="fas fa-upload"></i> 上传简历</h2>
            <div class="file-upload" onclick="document.getElementById('resumeFile').click()">
                <div class="upload-icon">
                    <i class="fas fa-cloud-upload-alt"></i>
                </div>
                <div class="upload-text">拖拽文件到此处或点击选择文件</div>
                <div class="upload-hint">支持 PDF、DOCX、DOC 格式</div>
                <input type="file" id="resumeFile" accept=".pdf,.docx,.doc" style="display: none;">
            </div>
            
            <div id="fileInfo" class="file-info" style="display: none;"></div>
            <div id="errorMessage" class="error-message" style="display: none;"></div>
            <div id="successMessage" class="success-message" style="display: none;"></div>
        </div>
        
        <!-- 加载状态 -->
        <div class="loading" id="loading">
            <div class="spinner"></div>
            <h5 style="color: rgba(255, 255, 255, 0.8);">正在分析并修改简历，需要5分钟左右，请耐心等待...</h5>
            <div class="progress-indicator">
                <div class="progress-dot"></div>
                <div class="progress-dot"></div>
                <div class="progress-dot"></div>
            </div>
        </div>
        
        <!-- 分析结果区域 -->
        <div class="analysis-section" id="analysisSection" style="display: none;">
            <!-- 对比分析区域 -->
            <div class="comparison-container">
                <div class="comparison-panel">
                    <div class="panel-header">
                        <i class="fas fa-exclamation-triangle"></i>
                        <span>简历原文（问题高亮）</span>
                    </div>
                    <div id="originalContent" class="highlighted-content"></div>
                </div>
                
                <div class="comparison-panel">
                    <div class="panel-header">
                        <i class="fas fa-check-circle"></i>
                        <span>修改建议（改进高亮）</span>
                    </div>
                    <div id="suggestedContent" class="highlighted-content"></div>
                </div>
            </div>
            
            <!-- 总体评价区域 -->
            <div class="evaluation-section">
                <div class="evaluation-header">
                    <i class="fas fa-star"></i>
                    <span>简历总体评价</span>
                </div>
                <div id="evaluationContent" class="content-area markdown"></div>
            </div>
            
            <!-- 操作按钮 -->
            <div class="action-buttons">
                <button class="btn" onclick="downloadResults()">
                    <i class="fas fa-download me-2"></i>
                    下载分析结果
                </button>
                <button class="btn btn-secondary" onclick="resetAnalysis()">
                    <i class="fas fa-redo me-2"></i>
                    重新分析
                </button>
            </div>
        </div>
    </div>

    <script src="{{ url_for('static', filename='js/index.js') }}"></script>
    <!-- 添加marked.js用于markdown渲染 -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script>
        let currentAnalysisData = null;
        
        // 配置marked.js
        marked.setOptions({
            breaks: true,
            gfm: true,
            sanitize: false,  // 允许HTML标签
            smartLists: true,
            smartypants: true
        });
        
        // 页面加载时检查用户登录状态
        document.addEventListener('DOMContentLoaded', function() {
            checkUserLogin();
            checkProcessingStatus(); // 检查处理状态
            
            // 初始化背景特效系统
            // 初始化火箭鼠标系统
            if (typeof RocketCursorSystem !== 'undefined') {
                new RocketCursorSystem();
            }
            
            // 初始化高级粒子系统
            if (typeof ParticleSystem !== 'undefined') {
                new ParticleSystem();
            }
            
            // 初始化星光系统
            if (typeof StarSystem !== 'undefined') {
                new StarSystem();
            }
            
            // 初始化流星系统
            if (typeof MeteorSystem !== 'undefined') {
                new MeteorSystem();
            }
            
            // 初始化加载系统
            if (typeof LoadingSystem !== 'undefined') {
                new LoadingSystem();
            }
        });
        
        // 检查处理状态
        async function checkProcessingStatus() {
            try {
                const response = await fetch('/api/resume/processing-status');
                const data = await response.json();
                
                if (data.success && data.processing_count > 0) {
                    showLoading(true);
                    showSuccess(`检测到有 ${data.processing_count} 个文件正在处理中，请耐心等待...`);
                    
                    // 定期检查状态
                    setTimeout(checkProcessingStatus, 5000);
                }
            } catch (error) {
                console.error('检查处理状态失败:', error);
            }
        }
        
        // 触发返回转场效果
        function triggerReturnTransition() {
            // 设置返回标志
            sessionStorage.setItem('returningToHome', 'true');
        }
        
        // 检查用户登录状态
        function checkUserLogin() {
            const user = sessionStorage.getItem('user');
            if (!user) {
                window.location.href = '/auth';
                return;
            }
        }
        
        // 文件上传相关
        const fileUpload = document.querySelector('.file-upload');
        const fileInput = document.getElementById('resumeFile');
        
        // 拖拽上传
        fileUpload.addEventListener('dragover', function(e) {
            e.preventDefault();
            fileUpload.style.borderColor = 'rgba(102, 126, 234, 0.6)';
            fileUpload.style.background = 'rgba(102, 126, 234, 0.1)';
        });
        
        fileUpload.addEventListener('dragleave', function(e) {
            e.preventDefault();
            fileUpload.style.borderColor = 'rgba(255, 255, 255, 0.3)';
            fileUpload.style.background = 'transparent';
        });
        
        fileUpload.addEventListener('drop', function(e) {
            e.preventDefault();
            fileUpload.style.borderColor = 'rgba(255, 255, 255, 0.3)';
            fileUpload.style.background = 'transparent';
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                handleFileUpload(files[0]);
            }
        });
        
        // 点击上传
        fileInput.addEventListener('change', function(e) {
            if (e.target.files.length > 0) {
                handleFileUpload(e.target.files[0]);
            }
        });
        
        // 处理文件上传
        function handleFileUpload(file) {
            // 重置分析状态
            isAnalyzing = false;
            
            // 显示文件信息
            const fileInfo = document.getElementById('fileInfo');
            fileInfo.innerHTML = `
                <div style="display: flex; align-items: center; justify-content: space-between;">
                    <div style="display: flex; align-items: center;">
                        <i class="fas fa-file-alt" style="margin-right: 15px; font-size: 24px; color: #667eea;"></i>
                        <div>
                            <h6 style="margin: 0; color: rgba(255, 255, 255, 0.8);">${file.name}</h6>
                            <small style="color: rgba(255, 255, 255, 0.5);">大小: ${(file.size / 1024).toFixed(2)} KB</small>
                        </div>
                    </div>
                    <button class="btn" onclick="analyzeResume()" id="analyzeBtn">
                        <i class="fas fa-play me-2"></i>
                        开始分析
                    </button>
                </div>
            `;
            fileInfo.style.display = 'block';
            
            // 隐藏其他消息
            document.getElementById('errorMessage').style.display = 'none';
            document.getElementById('successMessage').style.display = 'none';
            document.getElementById('loading').style.display = 'none';
        }
        
        // 分析新上传的简历
        let isAnalyzing = false; // 添加分析状态标志
        
        async function analyzeResume() {
            // 防止重复提交
            if (isAnalyzing) {
                console.log('分析正在进行中，请勿重复提交');
                return;
            }
            
            const fileInput = document.getElementById('resumeFile');
            const file = fileInput.files[0];
            
            if (!file) {
                showError('请先选择文件');
                return;
            }
            
            // 设置分析状态
            isAnalyzing = true;
            showLoading(true);
            
            // 禁用分析按钮
            const analyzeButton = document.getElementById('analyzeBtn');
            if (analyzeButton) {
                analyzeButton.disabled = true;
                analyzeButton.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>分析中...';
            }
            
            try {
                const formData = new FormData();
                formData.append('file', file);
                
                const response = await fetch('/api/resume/analyze-enhanced', {
                    method: 'POST',
                    body: formData
                });
                
                const data = await response.json();
                
                if (response.status === 429) {
                    // 重复提交的情况
                    showError('相同的文件正在分析中，请稍后重试');
                    showLoading(false);
                    return;
                }
                
                if (data.success) {
                    currentAnalysisData = data.data;
                    displayAnalysisResults(data.data);
                    showSuccess('简历分析完成！');
                    showLoading(false); // 确保隐藏加载状态
                } else {
                    showError(data.error || '分析失败');
                    showLoading(false);
                }
            } catch (error) {
                console.error('分析失败:', error);
                showError('网络错误，请稍后重试');
                showLoading(false);
            } finally {
                // 恢复分析按钮
                const analyzeButton = document.getElementById('analyzeBtn');
                if (analyzeButton) {
                    analyzeButton.disabled = false;
                    analyzeButton.innerHTML = '<i class="fas fa-play me-2"></i>开始分析';
                }
            }
        }
        
        // 轮询任务状态
        async function pollTaskStatus(taskId) {
            const maxAttempts = 300; // 最多轮询5分钟（每1秒一次）
            let attempts = 0;
            
            const poll = async () => {
                try {
                    const response = await fetch(`/api/resume/analysis-status/${taskId}`);
                    const data = await response.json();
                    
                    if (data.status === 'completed') {
                        // 任务完成，显示结果
                        currentAnalysisData = data.result;
                        displayAnalysisResults(data.result);
                        showSuccess('简历分析完成！');
                        showLoading(false);
                        return;
                    } else if (data.status === 'failed') {
                        // 任务失败
                        showError(data.error || '分析失败');
                        showLoading(false);
                        return;
                    } else if (data.status === 'processing') {
                        // 任务处理中，继续轮询
                        attempts++;
                        if (attempts >= maxAttempts) {
                            showError('分析超时，请稍后重试');
                            showLoading(false);
                            return;
                        }
                        
                        // 更新加载提示
                        updateLoadingMessage(attempts);
                        
                        // 1秒后继续轮询
                        setTimeout(poll, 1000);
                    } else {
                        // 其他状态，继续轮询
                        attempts++;
                        if (attempts >= maxAttempts) {
                            showError('分析超时，请稍后重试');
                            showLoading(false);
                            return;
                        }
                        setTimeout(poll, 1000);
                    }
                } catch (error) {
                    console.error('轮询失败:', error);
                    attempts++;
                    if (attempts >= maxAttempts) {
                        showError('网络错误，请稍后重试');
                        showLoading(false);
                        return;
                    }
                    setTimeout(poll, 1000);
                }
            };
            
            // 开始轮询
            poll();
        }
        
        // 更新加载提示信息
        function updateLoadingMessage(attempts) {
            const loadingText = document.querySelector('#loading h5');
            if (loadingText) {
                const minutes = Math.floor(attempts / 60);
                const seconds = attempts % 60;
                loadingText.textContent = `正在分析并修改简历，需要5分钟左右，请耐心等待...`;
            }
        }
        
        // 显示分析结果
        function displayAnalysisResults(data) {
            document.getElementById('analysisSection').style.display = 'block';
            
            // 显示原文（问题高亮）
            document.getElementById('originalContent').innerHTML = data.original_highlighted;
            
            // 显示修改建议（改进高亮）- 修复markdown渲染和高亮问题
            const suggestedContent = document.getElementById('suggestedContent');
            
            // 详细的调试信息
            console.log('=== 修改建议调试信息 ===');
            console.log('修改建议原始数据:', data.suggested_highlighted);
            console.log('修改建议长度:', data.suggested_highlighted.length);
            console.log('是否包含span标签:', data.suggested_highlighted.includes('<span'));
            console.log('是否包含div标签:', data.suggested_highlighted.includes('<div'));
            console.log('是否包含background-color:', data.suggested_highlighted.includes('background-color'));
            console.log('前200个字符:', data.suggested_highlighted.substring(0, 200));
            
            // 检查数据是否已经包含HTML高亮标签
            if (data.suggested_highlighted.includes('<span style="background-color') || 
                data.suggested_highlighted.includes('<div style="background-color')) {
                // 如果已经包含HTML高亮标签，直接使用innerHTML
                suggestedContent.innerHTML = data.suggested_highlighted;
                console.log('✅ 修改建议包含HTML高亮标签，直接渲染');
            } else {
                // 如果没有HTML高亮标签，先渲染markdown
                const markdownRendered = marked.parse(data.suggested_highlighted);
                suggestedContent.innerHTML = markdownRendered;
                console.log('✅ 修改建议使用markdown渲染');
                console.log('Markdown渲染结果:', markdownRendered);
            }
            
            // 显示总体评价
            const evaluationContent = document.getElementById('evaluationContent');
            evaluationContent.innerHTML = marked.parse(data.evaluation);
            
            // 滚动到分析结果区域
            document.getElementById('analysisSection').scrollIntoView({ behavior: 'smooth' });
            
            // 调试信息
            console.log('原文高亮内容长度:', data.original_highlighted.length);
            console.log('修改建议内容长度:', data.suggested_highlighted.length);
            console.log('修改建议内容预览:', data.suggested_highlighted.substring(0, 200));
            console.log('修改建议是否包含HTML标签:', data.suggested_highlighted.includes('<span') || data.suggested_highlighted.includes('<div'));
        }
        
        // 下载分析结果
        function downloadResults() {
            if (!currentAnalysisData) {
                showError('没有可下载的分析结果');
                return;
            }
            
            // 创建下载内容
            const content = `
简历分析报告
生成时间: ${new Date().toLocaleString()}

=== 简历原文 ===
${currentAnalysisData.original_text}

=== 修改建议 ===
${currentAnalysisData.markdown_text}

=== 总体评价 ===
${currentAnalysisData.evaluation}

=== 详细分析结果 ===
${currentAnalysisData.analysis_result}
            `;
            
            // 创建下载链接
            const blob = new Blob([content], { type: 'text/plain;charset=utf-8' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `简历分析报告_${new Date().toISOString().slice(0, 10)}.txt`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }
        
        // 重置分析
        function resetAnalysis() {
            document.getElementById('analysisSection').style.display = 'none';
            document.getElementById('fileInfo').style.display = 'none';
            document.getElementById('resumeFile').value = '';
            document.getElementById('loading').style.display = 'none';
            currentAnalysisData = null;
            isAnalyzing = false; // 重置分析状态
            
            // 重置按钮状态
            const analyzeButton = document.getElementById('analyzeBtn');
            if (analyzeButton) {
                analyzeButton.disabled = false;
                analyzeButton.innerHTML = '<i class="fas fa-play me-2"></i>开始分析';
            }
        }
        
        // 显示/隐藏加载状态
        function showLoading(show) {
            document.getElementById('loading').style.display = show ? 'block' : 'none';
        }
        
        // 显示错误信息
        function showError(message) {
            const errorDiv = document.getElementById('errorMessage');
            errorDiv.textContent = message;
            errorDiv.style.display = 'block';
            setTimeout(() => {
                errorDiv.style.display = 'none';
            }, 5000);
        }
        
        // 显示成功信息
        function showSuccess(message) {
            const successDiv = document.getElementById('successMessage');
            successDiv.textContent = message;
            successDiv.style.display = 'block';
            setTimeout(() => {
                successDiv.style.display = 'none';
            }, 5000);
        }
    </script>
</body>
</html> 